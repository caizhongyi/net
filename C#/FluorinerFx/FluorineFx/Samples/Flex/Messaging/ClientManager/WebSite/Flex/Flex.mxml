<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" backgroundColor="#FFFFFF" layout="absolute">
	<mx:Script>
		<![CDATA[
			import mx.utils.ObjectUtil;
			import mx.rpc.events.FaultEvent;
			import mx.controls.Alert;
			import mx.rpc.events.ResultEvent;        
			import mx.messaging.events.MessageEvent;        
			
	    private function logIn():void
	    {		
		    loginRO.logout();
        	loginRO.setCredentials(username.text, password.text);
	    	loginRO.SecureOperation();
	    }
	
	    /*Call logout*/
	    private function logOut():void
	    {		
		    loginRO.logout();
        	appViews.selectedChild = loginView;
	    }

	    private function loginResult(event:ResultEvent):void {
		    var result:Boolean = event.result as Boolean;
        	appViews.selectedChild = secureView;
        	consumer.setCredentials(username.text, password.text);
        	consumer.subscribe();    
     	}
      
	    private function loginFault(event:FaultEvent):void{
        	Alert.show( ObjectUtil.toString(event.fault), "Authentication failed" );
	    }
	    	    		
		
		public function messageHandler(event:MessageEvent):void 
		{        
			var body:Object = event.message.body;
			output.text = body.userId + ": " + body.msg;
		}    			
		]]>
	</mx:Script>    
  	<mx:RemoteObject id="loginRO" destination="fluorine">
    	<mx:method name="SecureOperation" result="loginResult(event)" fault="loginFault(event)" />
  	</mx:RemoteObject>
	
	<mx:Consumer id="consumer" destination="feed" message="messageHandler(event)"/>
	
  <mx:ViewStack id="appViews" width="100%" height="100%">
  <!--login view-->
    <mx:HBox horizontalAlign="center" verticalAlign="middle" id="loginView" width="100%" height="100%">
      <mx:Panel title="Login" id="loginPanel" horizontalScrollPolicy="off" verticalScrollPolicy="off">
        <mx:Form id="loginForm">
          <mx:FormItem label="Username:">
            <mx:TextInput id="username"/>
          </mx:FormItem>
          <mx:FormItem label="Password:">
            <mx:TextInput id="password"  displayAsPassword="true"/>
          </mx:FormItem>
        </mx:Form>
        <mx:ControlBar>
          <mx:Spacer width="100%" id="spacer1"/>
          <mx:Button label="Login" id="loginButton"
              enabled="{(username.text.length == 0 || password.text.length == 0) ? false : true}"
              toolTip="{loginButton.enabled == true ? 'Click to submit' : 'Enter username and password'}" 
              click="logIn()" />
        </mx:ControlBar>
      </mx:Panel>
    </mx:HBox>
  <!--end loginView-->

  <!--secure area view, made visible after a successful login-->
    <mx:HBox id="secureView" width="100%" height="100%">
		<mx:Box x="20" y="20">
			<mx:VBox>
				<mx:HBox>
					<mx:Label text="Secure Area" />
					<mx:Label id="output" text="..." />		
				</mx:HBox>
			</mx:VBox>
		</mx:Box>
    </mx:HBox>
  <!--end secure area view-->
  </mx:ViewStack>
	
	
</mx:Application>
