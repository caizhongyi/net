<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE>NeatUpload™ Manual</TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.1  (Linux)">
	<META NAME="CREATED" CONTENT="20070810;2243800">
	<META NAME="CHANGEDBY" CONTENT="Dean Brettle">
	<META NAME="CHANGED" CONTENT="20090728;14142900">
	<META NAME="Info 1" CONTENT="">
	<META NAME="Info 2" CONTENT="">
	<META NAME="Info 3" CONTENT="">
	<META NAME="Info 4" CONTENT="">
	<STYLE TYPE="text/css">
	<!--
		P { margin-top: 0.1in; margin-bottom: 0.1in }
		H2.western { font-family: "Nimbus Roman No9 L", serif }
		H2.cjk { font-family: "DejaVu LGC Sans" }
		H2.ctl { font-family: "DejaVu LGC Sans" }
		H3.western { font-family: "Nimbus Roman No9 L", serif }
		H3.cjk { font-family: "DejaVu LGC Sans" }
		H3.ctl { font-family: "DejaVu LGC Sans" }
		H4.western { font-family: "Nimbus Roman No9 L", serif }
		H4.cjk { font-family: "DejaVu LGC Sans" }
		H4.ctl { font-family: "DejaVu LGC Sans" }
		TD P { margin-top: 0.1in; margin-bottom: 0.1in }
		TH P { margin-top: 0.1in; margin-bottom: 0.1in }
		PRE { margin-left: 0.5in; background: #e6e6e6; border: 1px solid #000000; padding: 0.02in; font-family: "Nimbus Mono L", monospace }
		A:visited { so-language: en-US }
		STRONG { color: #800000 }
		CODE { background: transparent }
		CODE.western { font-family: "Nimbus Roman No9 L", serif; font-weight: bold }
		CODE.cjk { font-family: "DejaVu LGC Sans" }
		CODE.ctl { font-family: "DejaVu LGC Sans" }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<P ALIGN=CENTER STYLE="margin-top: 0.17in; margin-bottom: 0.2in; page-break-after: avoid"><A NAME="mozTocId101532"></A>
<FONT FACE="Albany, sans-serif"><FONT SIZE=5><B>NeatUpload™ Manual</B></FONT></FONT></P>
<P ALIGN=CENTER><EM><SPAN STYLE="font-style: normal">by <A HREF="http://www.brettle.com/">Dean
Brettle</A></SPAN></EM><A HREF="http://www.brettle.com/"><SPAN STYLE="font-style: normal"><BR></SPAN></A><EM><SPAN STYLE="font-style: normal">Last
updated <SDFIELD TYPE=DATETIME SDNUM="1033;0;MM/DD/YY">01/18/10</SDFIELD></SPAN></EM></P>
<DIV ID="Table of Contents1" DIR="LTR" STYLE="background: transparent">
	<DIV ID="Table of Contents1_Head" DIR="LTR">
		<P STYLE="margin-top: 0.17in; margin-bottom: 0.2in; page-break-after: avoid">
		<FONT FACE="Albany, sans-serif"><FONT SIZE=4 STYLE="font-size: 16pt"><B>Table
		of Contents</B></FONT></FONT></P>
	</DIV>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"> 1 <A HREF="#1.Introduction|outline">Introduction</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	1.1 <A HREF="#1.1.Requirements|outline">Requirements</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	1.2 <A HREF="#1.2.Branding, Licensing, and the Trademark|outline">Branding,
	Licensing, and the Trademark</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	1.3 <A HREF="#1.3.Version Numbering|outline">Version Numbering</A></P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"> 2 <A HREF="#2.Release Notes for NeatUpload-1.3.x|outline">Release
	Notes for NeatUpload-1.3.x</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	2.1 <A HREF="#2.1.Upgrading from NeatUpload-1.2.x and NeatUpload-1.1.x|outline">Upgrading
	from NeatUpload-1.2.x and NeatUpload-1.1.x</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	2.2 <A HREF="#2.2.Upgrading from NeatUpload-1.0.x|outline">Upgrading
	from NeatUpload-1.0.x</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	2.3 <A HREF="#2.3.New Features in NeatUpload-1.3|outline">New
	Features in NeatUpload-1.3</A></P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"> 3 <A HREF="#3.Usage|outline">Usage</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.1 <A HREF="#3.1.Installing NeatUpload|outline">Installing
	NeatUpload</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.2 <A HREF="#3.2.Using NeatUpload with the Visual Studio Web Form Designer|outline">Using
	NeatUpload with the Visual Studio Web Form Designer</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.3 <A HREF="#3.3.Using NeatUpload without the Visual Studio Web Form Designer|outline">Using
	NeatUpload without the Visual Studio Web Form Designer</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.4 <A HREF="#3.4.Allowing Users with Flash to Select Multiple Files from One File Selection Dialog|outline">Allowing
	Users with Flash to Select Multiple Files from One File Selection
	Dialog</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.5 <A HREF="#3.5.Validating File Names|outline">Validating File
	Names</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.6 <A HREF="#3.6.Preventing Accidental Upload Interruptions|outline">Preventing
	Accidental Upload Interruptions</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.7 <A HREF="#3.7.Avoiding Unnecessary Uploads and Progress Displays|outline">Avoiding
	Unnecessary Uploads and Progress Displays</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.8 <A HREF="#3.8.Showing Processing Progress|outline">Showing
	Processing Progress</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.9 <A HREF="#3.9.Uploading without InputFile|outline">Uploading
	without InputFile</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.10 <A HREF="#3.10.Uploading from a Client Application|outline">Uploading
	from a Client Application</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	3.11 <A HREF="#3.11.Using NeatUpload from JavaScript|outline">Using
	NeatUpload from JavaScript</A></P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"> 4 <A HREF="#4.Configuration|outline">Configuration</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.1 <A HREF="#4.1.Using the &lt;neatUpload&gt; Configuration Section|outline">Using
	the &lt;neatUpload&gt; Configuration Section</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.2 <A HREF="#4.2.Changing the Temporary Directory Used by the FilesystemUploadStorageProvider|outline">Changing
	the Temporary Directory Used by the FilesystemUploadStorageProvider</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.3 <A HREF="#4.3.Supporting Web Gardens and Web Farms|outline">Supporting
	Web Gardens and Web Farms</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.4 <A HREF="#4.4.Using Location Filtering to Restrict/Modify NeatUpload's Request Processing|outline">Using
	Location Filtering to Restrict/Modify NeatUpload's Request
	Processing</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.5 <A HREF="#4.5.Limiting the Size of Upload Requests|outline">Limiting
	the Size of Upload Requests</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.6 <A HREF="#4.6.Changing the Maximum Size of Normal Requests|outline">Changing
	the Maximum Size of Normal Requests</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.7 <A HREF="#4.7.Limiting the Upload Rate|outline">Limiting the
	Upload Rate</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.8 <A HREF="#4.8.Configuring Individual InputFile and MultiFile Controls Programmatically|outline">Configuring
	Individual InputFile and MultiFile Controls Programmatically</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.9 <A HREF="#4.9.Reducing Server Load|outline">Reducing Server Load</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.10 <A HREF="#4.10.Changing the Location of NeatUpload's Files|outline">Changing
	the Location of NeatUpload's Files</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.11 <A HREF="#4.11.Changing the Query String Parameter Used When Uploading From Client Applications|outline">Changing
	the Query String Parameter Used When Uploading From Client
	Applications</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	4.12 <A HREF="#4.12.Changing the Encryption and Validation Algorithms Used|outline">Changing
	the Encryption and Validation Algorithms Used</A></P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"> 5 <A HREF="#5.Customization|outline">Customization</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	5.1 <A HREF="#5.1.Customizing Progress.aspx|outline">Customizing
	Progress.aspx</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	5.2 <A HREF="#5.2.Creating Custom Fallback Content for ProgressBar|outline">Creating
	Custom Fallback Content for ProgressBar</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	5.3 <A HREF="#5.3.Advanced Progress Bar Customization|outline">Advanced
	Progress Bar Customization</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	5.4 <A HREF="#5.4.Customizing the MultiFile Button|outline">Customizing
	the MultiFile Button</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	5.5 <A HREF="#5.5.Customizing MultiFile's Handling of Queued Files|outline">Customizing
	MultiFile's Handling of Queued Files</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	5.6 <A HREF="#5.6.Creating a Custom UploadStorageProvider|outline">Creating
	a Custom UploadStorageProvider</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	5.7 <A HREF="#5.7.Creating a Custom UploadStateStoreProvider|outline">Creating
	a Custom UploadStateStoreProvider</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	5.8 <A HREF="#5.8.Handling Non-absolute Paths in IE6|outline">Handling
	Non-absolute Paths in IE6</A></P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"> 6 <A HREF="#6.Extensions|outline">Extensions</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	6.1 <A HREF="#6.1.The SqlServerInputFile Extension|outline">The
	SqlServerInputFile Extension</A></P>
	<P STYLE="margin-left: 0.39in; margin-top: 0in; margin-bottom: 0in">
	6.1.1 <A HREF="#6.1.1.Installation|outline">Installation</A></P>
	<P STYLE="margin-left: 0.39in; margin-top: 0in; margin-bottom: 0in">
	6.1.2 <A HREF="#6.1.2.Configuration|outline">Configuration</A></P>
	<P STYLE="margin-left: 0.39in; margin-top: 0in; margin-bottom: 0in">
	6.1.3 <A HREF="#6.1.3.Usage|outline">Usage</A></P>
	<P STYLE="margin-left: 0.39in; margin-top: 0in; margin-bottom: 0in">
	6.1.4 <A HREF="#6.1.4.Example|outline">Example</A></P>
	<P STYLE="margin-left: 0.59in; margin-top: 0in; margin-bottom: 0in">
	6.1.4.1 <A HREF="#6.1.4.1.Example Setup Query for SQL Server 2005|outline">Example
	Setup Query for SQL Server 2005</A></P>
	<P STYLE="margin-left: 0.59in; margin-top: 0in; margin-bottom: 0in">
	6.1.4.2 <A HREF="#6.1.4.2.Example Setup Query for SQL Server 2000|outline">Example
	Setup Query for SQL Server 2000</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	6.2 <A HREF="#6.2.The GreyBoxProgressBar Extension|outline">The
	GreyBoxProgressBar Extension</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	6.3 <A HREF="#6.3.The HashedInputFile Extension|outline">The
	HashedInputFile Extension</A></P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"> 7 <A HREF="#7.Known Issues|outline">Known
	Issues</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.1 <A HREF="#7.1.ASP.NET application-wide tracing disables NeatUpload|outline">ASP.NET
	application-wide tracing disables NeatUpload</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.2 <A HREF="#7.2.Permissions on uploaded files depend on temporary directory|outline">Permissions
	on uploaded files depend on temporary directory</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.3 <A HREF="#7.3.Module conflicts|outline">Module conflicts</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.4 <A HREF="#7.4.HttpResponse.AppendToLog() does nothing when UploadHttpModule is used|outline">HttpResponse.AppendToLog()
	does nothing when UploadHttpModule is used</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.5 <A HREF="#7.5.Setting HttpResponse.HeaderEncoding does nothing when UploadHttpModule is used|outline">Setting
	HttpResponse.HeaderEncoding does nothing when UploadHttpModule is
	used</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.6 <A HREF="#7.6.Non-absolute path in IE7 causes the progress display to start even though no upload occurs|outline">Non-absolute
	path in IE7 causes the progress display to start even though no
	upload occurs</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.7 <A HREF="#7.7. Clicking submit buttons or image buttons might start the progress display or clear selected files|outline">
	Clicking submit buttons or image buttons might start the progress
	display or clear selected files</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.8 <A HREF="#7.8. LinkButtons do not start the progress display in Internet Explorer for the Mac|outline">
	LinkButtons do not start the progress display in Internet Explorer
	for the Mac</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.9 <A HREF="#7.9.Sometimes responses larger than 1MB are not buffered|outline">Sometimes
	responses larger than 1MB are not buffered</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.10 <A HREF="#7.10.NeatUpload controls might not work properly within an UpdatePanel|outline">NeatUpload
	controls might not work properly within an UpdatePanel</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.11 <A HREF="#7.11.NeatUpload might fail when using Windows Authentication|outline">NeatUpload
	might fail when using Windows Authentication</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.12 <A HREF="#7.12.NeatUpload might fail when using SSL/HTTPS|outline">NeatUpload
	might fail when using SSL/HTTPS</A></P>
	<P STYLE="margin-left: 0.2in; margin-top: 0in; margin-bottom: 0in">
	7.13 <A HREF="#7.13.Application restarts can interrupt uploads or blank ProgressBars|outline">Application
	restarts can interrupt uploads or blank ProgressBars</A></P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"> 8 <A HREF="#8.Troubleshooting|outline">Troubleshooting</A></P>
</DIV>
<P><BR><BR>
</P>
<H1><A NAME="mozTocId903858"></A><A NAME="1.Introduction|outline"></A>
 1 Introduction</H1>
<P>The <A HREF="http://www.brettle.com/neatupload">NeatUpload™</A><A HREF="http://en.wikipedia.org/wiki/ASP.NET">ASP.NET</A>
component allows developers to stream uploaded files to storage (e.g.
disk or a database) and allows users to monitor upload progress. It
is <A HREF="http://opensource.org/docs/definition.php">open source</A>
and works under <A HREF="http://www.mono-project.com/">Mono's</A><A HREF="http://www.go-mono.com/asp-net.html#xsp">XSP</A>
/ <A HREF="http://www.go-mono.com/asp-net.html#mod_mono">mod_mono</A>
as well as Microsoft's ASP.NET implementation. 
</P>
<P>NeatUpload contains seven custom controls (<CODE CLASS="western">InputFile</CODE>,
<B>MultiFile</B>, <CODE CLASS="western">ProgressBar</CODE>,
<CODE CLASS="western">UnloadConfirmer</CODE>, <CODE CLASS="western">HiddenPostBackID</CODE>,
<CODE CLASS="western">DetailsSpan</CODE>, and <CODE CLASS="western">DetailsDiv</CODE>),
an <CODE CLASS="western">HttpModule</CODE> (<CODE CLASS="western">UploadHttpModule</CODE>),
and a Page subclass (<CODE CLASS="western">ProgressPage</CODE>). This
section briefly describes what they each do and how they are related.
The remainder of this manual describes how to install and use
NeatUpload. 
</P>
<P><CODE CLASS="western">InputFile</CODE> is a custom control that
renders like <CODE CLASS="western">HtmlInputFile</CODE>, but provides
properties to access the uploaded file's client-specified name,
content, and MIME type, and a method to move the file to a permanent
location.  <B>MultiFile</B><SPAN STYLE="font-weight: normal">is a
custom control similar to </SPAN><B>InputFile</B><SPAN STYLE="font-weight: normal">but
with support for uploading multiple files and for specifying the look
of the control.</SPAN></P>
<P><CODE CLASS="western">ProgressBar</CODE> is a custom control that
is responsible for providing a site for the progress to be displayed.
It provides an attribute to control whether to display the progress
inline or in a popup. It also provides ways to control which buttons
cause the progress display to start refreshing. If the progress is
displayed inline, the <CODE CLASS="western">ProgressBar</CODE>
control renders as an <CODE CLASS="western">IFRAME</CODE>. Otherwise,
it renders as a <CODE CLASS="western">DIV</CODE> containing a &quot;Check
Upload Progress&quot; link (to display the progress in a new window)
along with some JavaScript which removes the <CODE CLASS="western">DIV</CODE>
when the page loads. This provides a fallback when JavaScript is not
available. Note that <CODE CLASS="western">ProgressBar</CODE> doesn't
actually display the progress bar itself. It merely provides a site
(an <CODE CLASS="western">IFRAME</CODE> or popup) which loads a page
derived from <CODE CLASS="western">ProgressPage</CODE> (by default
<CODE CLASS="western">Progress.aspx</CODE>). &nbsp;The <CODE CLASS="western">ProgressPage</CODE>
subclass displays the progress bar. 
</P>
<P><CODE CLASS="western">UnloadConfirmer</CODE> is a custom control
that displays a confirmation dialog if the user tries to do something
that would interrupt an upload.</P>
<P><CODE CLASS="western">HiddenPostBackID</CODE> is a custom control
that tells NeatUpload to stream to storage all files uploaded from a
page, including those uploaded with standard ASP.NET upload controls.</P>
<P><CODE CLASS="western">UploadHttpModule</CODE> is an <CODE CLASS="western">HttpModule</CODE>
that intercepts HTTP requests, streams <CODE CLASS="western">InputFile/MultiFile</CODE>
uploads to temporary files, and restricts the size of the remainder
of the request. By default, <CODE CLASS="western">UploadHttpModule</CODE>
intercepts every request. &nbsp;As a result, a bug in NeatUpload
could affect pages that don't even contain <CODE CLASS="western"><SPAN STYLE="font-weight: normal">NeatUpload</SPAN></CODE>controls.
For this reason, you can configure NeatUpload to only use
<CODE CLASS="western">UploadHttpModule</CODE> for certain pages (or
even none) while continuing to use <CODE CLASS="western">InputFile</CODE><CODE CLASS="western"><SPAN STYLE="font-weight: normal">,
</SPAN></CODE><CODE CLASS="western">MultiFile</CODE><CODE CLASS="western"><SPAN STYLE="font-weight: normal">,</SPAN></CODE>and
<CODE CLASS="western">ProgressBar</CODE>. When <CODE CLASS="western">UploadHttpModule</CODE>
is not used for a request, NeatUpload gets the uploaded file from the
ASP.NET standard <CODE CLASS="western">HttpRequest.Files</CODE>
property instead of intercepting the request. That means that
<CODE CLASS="western">InputFile</CODE> will function like an
<CODE CLASS="western">HtmlInputFile</CODE> control, but no progress
bar will be displayed. This greatly reduces the risk of adopting
NeatUpload. 
</P>
<P><CODE CLASS="western">ProgressPage</CODE> is a subclass
of&nbsp;<CODE CLASS="western">System.Web.UI.Page</CODE> that is used
as the base class for pages displayed in the site provided by the
<CODE CLASS="western">ProgressBar</CODE> control (i.e. in the <CODE CLASS="western">IFRAME</CODE>
or popup). <CODE CLASS="western">&nbsp;Progress.aspx</CODE> is the
default <CODE CLASS="western">ProgressPage</CODE>. &nbsp;<CODE CLASS="western">ProgressPage
</CODE>retrieves the details of the upload process from the
<CODE CLASS="western">UploadHttpModule</CODE>. and makes them
available for subclasses to use in data-binding expressions.&nbsp;
<CODE CLASS="western">ProgressPage</CODE> subclasses (e.g.
<CODE CLASS="western">Progress.aspx</CODE>) place such data-binding
expressions within <CODE CLASS="western"><B>DetailsSpan </B></CODE>and
<CODE CLASS="western"><B>DetailsDiv </B></CODE>controls so that
NeatUpload can use AJAX techniques to update the values without
requiring a browser a refresh. 
</P>
<H2 CLASS="western"><A NAME="Requirements"></A><A NAME="1.1.Requirements|outline"></A>
 1.1 Requirements</H2>
<P>To use NeatUpload you will need: 
</P>
<UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">.NET Framework
	(1.1, 2.0, 3.0, or 3.5), or Mono (1.1 or 1.2). Mono users that are
	using the mod_mono Apache module should use mod_mono 1.1.14 or
	later. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">A working web
	application. 
	</P>
	<LI><P>Either &quot;Full&quot; <A HREF="http://msdn2.microsoft.com/en-us/library/tkscy493.aspx">trust</A>
	or, if NeatUpload is installed in the GAC, at least &quot;Medium&quot;
	trust. &quot;Full&quot; trust level is the ASP.NET default, but some
	hosting providers force web applications to run with &quot;Medium&quot;
	trust. 
	</P>
</UL>
<H2 CLASS="western"><A NAME="Branding"></A><A NAME="1.2.Branding, Licensing, and the Trademark|outline"></A>
 1.2 Branding, Licensing, and the Trademark</H2>
<P>Some NeatUpload controls display a &quot;Powered&nbsp;by&nbsp;<A HREF="http://www.brettle.com/neatupload" TARGET="_blank">NeatUpload</A>&quot;
branding unless you are using a version that someone has modified to
remove the branding. This branding is designed to encourage you to
contribute to NeatUpload in one of the following ways: 
</P>
<UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">spread the word
	by leaving the branding in place, or 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">becoming familiar
	enough with NeatUpload (as evidenced by your ability to find and
	remove the branding) that you could contribute code in the future,
	or</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">make a
	substantial non-monetary contribution (e.g. fix a bug, help with
	testing, or manually translate documentation), in return for which I
	will typically provide an unbranded version, or 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">help fund
	NeatUpload development by purchasing an unbranded version for $400
	US which you can pay <A HREF="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&amp;business=dean%40brettle%2Ecom&amp;item_name=NeatUpload&amp;no_shipping=0&amp;no_note=1&amp;tax=0&amp;currency_code=USD&amp;bn=PP%2DDonationsBF&amp;charset=UTF%2D8" TARGET="_blank">here</A>.&nbsp;
	Once I receive payment, I will email you a link to a version of
	NeatUpload with the branding removed.  Note that unbranded version
	comes with no warranty (just like the branded version) and I can't
	provide refunds.&nbsp; So you should make sure that the branded
	version works properly in your application before purchasing the
	unbranded version.&nbsp; Of course, if you have problems with either
	version, please let me know.</P>
</UL>
<P>Both the branded and unbranded versions are licensed under the <A HREF="http://www.brettle.com/neatupload#License">GNU
Lesser General Public License (LGPL)</A>. The only difference is
whether the branding is present. That means you can legally
redistribute (or fork) the unbranded version in accordance with the
LGPL. Note however that &quot;NeatUpload&quot; is a trademark for the
combination of the code I distribute and my support of it. As such,
you are not allowed to promote your redistribution of the unbranded
version (or a derivative of either version) in a way that could imply
my endorsement without my permission. For example, don't call it
&quot;Unbranded NeatUpload&quot; or say that it is &quot;based on
NeatUpload&quot;, because I don't want to get support requests from
folks using it. 
</P>
<P>To summarize, if you are using a branded version of NeatUpload you
have several options for removing the branding. In addition, you can
use NeatUpload, modify it (including removal of the branding), and
redistribute it in accordance with the terms of LGPL license. This
includes using it to create products/services that compete with
NeatUpload. However, you can't promote your redistribution of an
unbranded version of NeatUpload in a way that could imply my
endorsement because doing so dilutes the NeatUpload trademark. 
</P>
<P>I view branding NeatUpload as an experiment, and I'm very
interested in feedback, both positive and negative. Please <A HREF="http://www.brettle.com/ForumView.aspx?ItemID=5&amp;mid=39&amp;pageindex=7&amp;pageid=32">post
your comments</A>, or <A HREF="mailto:dean@brettle.com">email me</A>
directly. 
</P>
<H2 CLASS="western"><A NAME="1.3.Version Numbering|outline"></A> 1.3 Version
Numbering</H2>
<P>NeatUpload release names have the form
NeatUpload-<EM>major.minor.patch</EM>. When comparing versions, the
same major and minor numbers but a higher patch number (e.g. 1.1.4
vs. 1.1.3) means the new version contains only fixes for bugs in
existing assemblies or new features implemented in new optional
assemblies. There is very little risk (and sometimes significant
reward) in installing the new version. The same major number but a
higher minor number (e.g. 1.2.<EM>patch</EM> vs. 1.1.<EM>patch</EM>)
means the new version adds new features to existing assemblies but
any backward incompatibilities are extremely minor. You should not
need to modify your application to continue to use the old features,
but you might need to make modification to use the new features.
However, you should review the release notes and test your
application after upgrading to ensure that bugs weren't inadvertently
introduced. A higher major number (e.g. 2.<EM>minor.patch</EM> vs.
1.<EM>minor.patch</EM>) means the new version contains significant
changes that are not backward-compatible. Depending on what features
your application uses, you might need to modify it to work with the
new version. Review the release notes for details.</P>
<H1><A NAME="ReleaseNotes"></A><A NAME="2.Release Notes for NeatUpload-1.3.x|outline"></A>
 2 Release Notes for NeatUpload-1.3.x</H1>
<H2 CLASS="western"><A NAME="Upgrading1dot2"></A><A NAME="2.1.Upgrading from NeatUpload-1.2.x and NeatUpload-1.1.x|outline"></A>
 2.1 Upgrading from NeatUpload-1.2.x and NeatUpload-1.1.x</H2>
<P>NeatUpload-1.3.x is intended to be almost completely
backward-compatible with NeatUpload-1.2.x and NeatUpload-1.1.x. See
below for compatibility exceptions. To upgrade, simply replace your
<CODE CLASS="western">Brettle.Web.NeatUpload.dll</CODE> with the copy
from <CODE CLASS="western">NeatUpload-1.3.x/dotnet/app/bin/</CODE>
and copy everything from the <CODE CLASS="western">NeatUpload-1.3.x/dotnet/app/NeatUpload/</CODE>
folder into the NeatUpload folder that is a child of your
application's root directory.  You also need to <A HREF="#7.12.NeatUpload might fail when using Windows Authentication|outline">disable
Windows Authentication</A> and enable Anonymous Authentication for
the NeatUpload folder.  
</P>
<P>If you have customized your <CODE CLASS="western">Progress.aspx</CODE>
page, it will probably work unchanged under NeatUpload-1.3.x but
merging your changes into the latest version should not be difficult
and is recommended. 
</P>
<P>If you are using the &lt;neatUpload&gt; configuration section,
consider moving it out of the &lt;system.web&gt; section and adding
the xmlns=&quot;http://www.brettle.com/neatupload/config/2008&quot;
attribute as described in <A HREF="#4.1.Using the &lt;neatUpload&gt; Configuration Section|outline">Using
the &lt;neatUpload&gt; Configuration Section</A>.  The old location
under &lt;system.web&gt; is still supported but the documentation
uses the new location and adding the xmlns attribute will provide
Intellisense support in Visual Studio. 
</P>
<P>The only compatiblity exceptions in NeatUpload-1.3 are: 
</P>
<UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">You should
	<A HREF="#7.12.NeatUpload might fail when using Windows Authentication|outline">disable
	Windows Authentication</A> and enable Anonymous Authentication for
	the NeatUpload folder.  
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">The <CODE CLASS="western">InputFile</CODE>
	control is now &quot;branded&quot; unless you are using a version
	that someone has modified to remove the branding. The branding looks
	says “(Powered&nbsp;by&nbsp;<A HREF="http://www.brettle.com/neatupload" TARGET="_blank">NeatUpload</A>)”.
	 For more information on the branding and having it removed, see
	<A HREF="#Branding">Branding, Licensing, and the Trademark</A></P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">If you don't
	specify a temporary directory for use by the default
	<CODE CLASS="western">FileSystemUploadStorageProvider</CODE>, it
	will first try to use the directory <CODE CLASS="western">app_data/NeatUpload_Temp</CODE>
	within your application directory. If that directory exists (or can
	be created) and is writable, NeatUpload will use it. Otherwise, it
	will revert to the old behavior of using the system-wide temporary
	directory. This change was made to make it easier to configure
	NeatUpload in environments which use a Medium trust-level. In such
	an environment, the server administrator typically doesn't want to
	give applications access to the system-wide directory. Without this
	change, you would need to explicitly specify a temporary directory
	for NeatUpload to work in such an environment. With this change, you
	at most need to create <CODE CLASS="western">app_data/NeatUpload_Temp</CODE>
	and grant write permissions to the account that your app runs under.
	If you aren't in a Medium trust environment, you don't even need to
	do that. NeatUpload will probably be unable to create the directory
	and will fallback to using the system-wide temporary directory. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">UploadException</CODE>
	is no longer a subclass of <CODE CLASS="western">HttpException</CODE>.
	It is now just a subclass of <CODE CLASS="western">Exception</CODE>.
	This changes was necessary to allow <CODE CLASS="western">UploadException</CODE>s
	to be serialized so they can be passed to the progress bar in a web
	garden/farm environment. Custom error pages should still work
	because when an <CODE CLASS="western">UploadException</CODE> occurs
	during an upload, NeatUpload now wraps it in an <CODE CLASS="western">HttpException</CODE>
	with the same HTTP status code and throws the <CODE CLASS="western">HttpException</CODE>.
		</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">For upload
	requests where the non-file portion exceeds the
	<CODE CLASS="western">maxNormalRequestLength</CODE> limit,
	NeatUpload now throws a <CODE CLASS="western">NonfilePortionTooLargeException</CODE>
	instead of an <CODE CLASS="western">UploadTooLargeException</CODE>. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">If you use
	ASP.NET 2.0 themes, those themes will now be applied to the default
	progress display page (<CODE CLASS="western">Progress.aspx</CODE>)
	and the sample custom error page (<CODE CLASS="western">Error413.aspx</CODE>).
		</P>
</UL>
<H2 CLASS="western"><A NAME="mozTocId432734"></A><A NAME="2.2.Upgrading from NeatUpload-1.0.x|outline"></A>
 2.2 Upgrading from NeatUpload-1.0.x</H2>
<P>NeatUpload-1.3.x is intended to be almost
completely&nbsp;backward-compatible with NeatUpload-1.0.x. &nbsp;The
only exception other than those mentioned above is that <CODE CLASS="western">ProgressBar</CODE>s
must now be placed somewhere inside a <CODE CLASS="western">&lt;form&gt;</CODE>
element. &nbsp;In almost all cases that will already be the case so
this should not be a major issue. &nbsp;<BR><BR>To upgrade, simply
replace your <CODE CLASS="western">Brettle.Web.NeatUpload.dll</CODE>
with the copy from <CODE CLASS="western">NeatUpload-1.3.x/dotnet/app/bin/</CODE>
and copy everything from the <CODE CLASS="western">NeatUpload-1.3.x/dotnet/app/NeatUpload/</CODE>
folder into the NeatUpload folder in your application.  If you have
not customized your <CODE CLASS="western">Progress.aspx</CODE> page,
you should replace it with
<CODE CLASS="western">NeatUpload-1.3.x/dotnet/app/NeatUpload/Progress.aspx</CODE>.
&nbsp;If you have customized it, consider changing it to use the new
<CODE CLASS="western">&lt;Upload:DetailsSpan&gt;</CODE> and
<CODE CLASS="western">&lt;Upload:DetailsDiv&gt;</CODE> elements to
take advantage of&nbsp;<A HREF="http://en.wikipedia.org/wiki/AJAX">AJAX</A>
refreshless updates.&nbsp; See <A HREF="#Customizing_Progress_aspx">Customizing
Progress.aspx</A> for details.<BR><BR>If you recompile, you will see
some warnings about obsoleted/deprecated methods. &nbsp;Those methods
may be removed in NeatUpload-2.x. &nbsp;You are encouraged to switch
to their replacements, but that is not required for NeatUpload-1.3.x.
&nbsp;Similarly, you are encouraged to use the new custom
configuration section instead of the NeatUpload-1.0.x appSettings.
&nbsp;The old appSettings still work in NeatUpload-1.3.x, but the new
custom configuration section provides much more flexibility,
including the ability to use location filtering to restrict the
requests that NeatUpload touches. &nbsp;See <A HREF="#mozTocId221000">Configuration</A>
for details.</P>
<H2 CLASS="western"><A NAME="NewFeatures1dot3"></A><A NAME="2.3.New Features in NeatUpload-1.3|outline"></A>
 2.3 New Features in NeatUpload-1.3</H2>
<UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><A NAME="_ctl5_myDataList__ctl0_Description"></A>
	Added support for IIS7's default application pool (i.e. Integrated
	Pipeline Mode) using the same technique that <A HREF="http://darrenjohnstone.net/category/aspnet-file-uploads/">Darren
	Johnstone's upload component</A> uses.&nbsp; The technique does use
	reflection to access non-public members of ASP.NET classes, but uses
	the least reflection of any technique I've seen.</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Added the
	<CODE CLASS="western">MultiFile</CODE> control for uploading
	multiple files.</P>
	<UL>
		<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">If the user has
		Flash 8 or above and a compatible browser, they can also
		<A HREF="#0.0.2.Allowing Users with Flash to Select Multiple Files from One File Selection Dialog|outline"><I>select</I></A><A HREF="#0.0.2.Allowing Users with Flash to Select Multiple Files from One File Selection Dialog|outline">multiple
		files</A> from a single file selection dialog.  This functionality
		has been tested under IE7, Windows Firefox 3, and Windows Safari 3
		but should work with any browser that supports using JavaScript to
		make calls to ActionScript functions defined in transparent Flash
		movies.  Users of browser that don't have the required support
		(e.g. Opera 9 and Linux Firefox 2) can select one file per-dialog.</P>
		<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Developers can
		<A HREF="#0.1.1.Customizing the MultiFile Button|outline">customize
		the button</A> that displays the file selection dialog and
		<A HREF="#0.1.1.Customizing MultiFile's Handling of Queued Files|outline">customize
		the handling of queued files</A>.</P>
	</UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Added support for
	using NeatUpload in a web garden or web farm if you have ASP.NET
	configured to share session state across the servers in your
	garden/farm. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Added support for
	<A HREF="#MediumTrust">Using NeatUpload in a Medium Trust
	Environment</A> when installed in the GAC. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Added support for
	<A HREF="#ShowingProcessingProgress">using a </A><CODE CLASS="western"><A HREF="#ShowingProcessingProgress">ProgressBar</A></CODE><A HREF="#ShowingProcessingProgress">to
	show processing progress</A>. This can be used to display the
	progress of a long-running task even when no files are uploaded.</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><A NAME="_ctl5_myDataList__ctl0_Description1"></A>
	Added an <CODE CLASS="western">UnloadConfirmer</CODE> control which
	displays a confirmation dialog to the user if they attempt to leave
	the page or resubmit it while an upload is in progress.</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Added support for
	<A HREF="#UploadingWithoutInputFile">uploading without using
	</A><CODE CLASS="western"><A HREF="#UploadingWithoutInputFile">InputFile</A></CODE>.
		</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Added support for
	<A HREF="#MaxUploadRate">Limiting the Upload Rate</A>.</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><A NAME="_ctl5_myDataList__ctl0_Description2"></A>
	Added APIs and SPIs to make it possible to write new controls that
	use the same <CODE CLASS="western">IHttpModule</CODE>, new
	<CODE CLASS="western">IHttpModule</CODE>s that work with existing
	controls, and custom <CODE CLASS="western">UploadStateStoreProvider</CODE>s
	that maintain upload state in different locations. 
	</P>
</UL>
<UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Added
	Intellisense support for the &lt;neatUpload&gt; element if you
	include NeatUploadConfig.xsd in your web project and use
	&lt;neatUpload&nbsp;xmlns=&quot;http://www.brettle.com/neatupload/config/2008&quot;
	...&gt;. 
	</P>
</UL>
<UL>
	<LI><P>Rearranged the directory structure to separate the source
	code from the example application and moved most of the script code
	into a separate NeatUpload.js file that is not specific to ASP.NET.</P>
</UL>
<H1><A NAME="mozTocId50790"></A><A NAME="3.Usage|outline"></A> 3 Usage</H1>
<P><I>The following instructions should work with Visual Studio 2003
and Visual Studio 2005. &nbsp;If you are using Visual Studio 2002,
you might be able to get NeatUpload to work by following the
instructions in this <A HREF="http://www.brettle.com/ForumThreadView.aspx?thread=84&amp;pageindex=7">forum
thread</A>.</I></P>
<H2 CLASS="western"><A NAME="mozTocId304923"></A><A NAME="3.1.Installing NeatUpload|outline"></A>
 3.1 Installing NeatUpload</H2>
<P>Installing NeatUpload is pretty straightforward. Just copy the
necessary assemblies and subdirectories into your application and
make some modifications to your <CODE CLASS="western">Web.config</CODE>.
&nbsp;Specifically: 
</P>
<OL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">If you haven't
	already, download the release and extract it wherever you want. All
	the files will be extracted into a subdirectory named
	<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM>, where
	version is the version of the release you are installing. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><A NAME="MediumTrust"></A>
	If your application has &quot;Full&quot; trust, you can safely skip
	this step. If your application does not have &quot;Full&quot; trust,
	a server administrator (e.g. your hosting provider) needs to install
	NeatUpload in the GAC. This is necessary because NeatUpload (and all
	other similar components) needs to access the underlying
	<CODE CLASS="western">HttpWorkerRequest</CODE> object. To install
	NeatUpload in the GAC, the server administrator should: 
	</P>
	<OL>
		<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Use Windows
		Explorer to open <CODE CLASS="western">%WINDIR%/assembly</CODE>.
		The window will list the assemblies currently in the GAC along with
		their version number, etc. 
		</P>
		<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">In another
		Windows Explorer window, open the <CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/bin</CODE>
		folder. 
		</P>
		<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Drag and drop
		<CODE CLASS="western">Brettle.Web.NeatUpload.dll</CODE> and (if
		present) <CODE CLASS="western">Policy.</CODE><EM>major.minor</EM><CODE CLASS="western">.Brettle.Web.NeatUpload.dll</CODE>
		from the <CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/bin</CODE>
		folder into the GAC window to add them to the GAC. 
		</P>
		<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Find the
		Brettle.Web.NeatUpload assembly that was just added and note the
		value in the &quot;Version&quot; column. 
		</P>
		<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Tell NeatUpload
		users that the full strong name for the Brettle.Web.NeatUpload
		assembly is
		<CODE CLASS="western">Brettle.Web.NeatUpload,&nbsp;Version=</CODE><EM><B>value&nbsp;in&nbsp;version&nbsp;column</B></EM><CODE CLASS="western">,&nbsp;Culture=neutral,&nbsp;PublicKeyToken=C95290D92C5893C8&quot;</CODE>.
				</P>
	</OL>
	<P STYLE="margin-top: 0in; margin-bottom: 0in">To use NeatUpload
	after it has been installed in the GAC, you need to: Use the full
	strong name wherever the assembly is referenced in your
	application's <CODE CLASS="western">Web.config</CODE>. For example,
	if this documentation says to use: 
	</P>
	<PRE>type=&quot;Brettle.Web.NeatUpload.UploadHttpModule,<B>Brettle.Web.NeatUpload</B>&quot;</PRE><P STYLE="margin-top: 0in; margin-bottom: 0in">
	you would use: 
	</P>
	<PRE>type=&quot;Brettle.Web.NeatUpload.UploadHttpModule,<B>Brettle.Web.NeatUpload,Version=valuefromadmin,Culture=neutral,PublicKeyToken=C95290D92C5893C8&quot;</B></PRE><P STYLE="margin-top: 0in; margin-bottom: 0in">
	The server administrator will provide the &quot;Version&quot;
	portion of the strong name. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Either create
	<CODE CLASS="western">app_data/NeatUpload_Temp</CODE> under your
	application root and make it writable by the account that your
	application is running as, or <A HREF="#TempDirectory">change the
	temporary directory</A> used by the default provider. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">(Optional) To see
	the demo running on your server, configure IIS, mod_mono, or XSP so
	that <CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/</CODE>
	is a web application. Then point your browser at the
	<CODE CLASS="western">Brettle.Web.NeatUpload/Demo.aspx</CODE> on
	that website. To use NeatUpload in your own web application,
	continue with the remaining installation steps. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Add a reference
	to your web application that refers to the
	<CODE CLASS="western">Brettle.Web.NeatUpload.dll</CODE> (and any
	extension assemblies of interest) in the
	<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotet/app/bin</CODE>
	directory. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">If you will be
	using the Visual Studio Web Form Designer, add the NeatUpload
	controls to your toolbox. &nbsp;To do that, right-click on the
	Toolbox, click Add/Remove Items, Browse
	to&nbsp;&nbsp;<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/bin/Brettle.Web.NeatUpload.dll</CODE>,
	click Open, and then click OK.  If you want to use any of the
	NeatUpload extensions, add the other corresponding assemblies to
	your toolbox.</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">In your web
	application's root directory, create a <CODE CLASS="western">NeatUpload/
	</CODE>child directory by copying
	<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/NeatUpload/
	</CODE>and its contents. &nbsp;That subdirectory contains various
	files that NeatUpload needs in order to function properly.  <A HREF="#7.12.NeatUpload might fail when using Windows Authentication|outline">Disable
	Windows Authentication</A> and enable Anonymous Authentication for
	the NeatUpload folder.  
	</P>
	<LI><P>Add the line below to the
	<CODE CLASS="western">configuration/system.web/httpModules</CODE>
	section of your <CODE CLASS="western">Web.config</CODE><CODE CLASS="western"><SPAN STYLE="font-weight: normal">.
	 If you are using other 3rd-party modules, see the <A HREF="#7.3.Module conflicts|outline">Module
	conflict</A> section for details.</SPAN></CODE></P>
	<PRE>&lt;add name=&quot;UploadHttpModule&quot; type=&quot;Brettle.Web.NeatUpload.UploadHttpModule, Brettle.Web.NeatUpload&quot; /&gt;</PRE>
	<LI><P>Add the line below to the
	<CODE CLASS="western">configuration/system.webServer/modules</CODE>
	section of your <CODE CLASS="western">Web.config</CODE> to support
	IIS7's Integrated Pipeline Mode (which is used in it's default
	application pool).  If you are using other 3rd-party modules, see
	the <A HREF="#7.3.Module conflicts|outline">Module conflict</A>
	section for details.</P>
	<PRE>&lt;add name=&quot;UploadHttpModule&quot; type=&quot;Brettle.Web.NeatUpload.UploadHttpModule, Brettle.Web.NeatUpload&quot; preCondition=&quot;managedHandler&quot;/&gt;</PRE>
	<LI><P>(Optional) To allow larger uploads than the default of 4
	Mbytes under Microsoft's ASP.NET, &nbsp;you <I>might</I> need to add
	or modify the following element in your <CODE CLASS="western">Web.config</CODE>
	under <CODE CLASS="western">configuration/system.web</CODE>: 
	</P>
	<PRE STYLE="margin-bottom: 0.2in">&lt;httpRuntime maxRequestLength=&quot;<VAR>size_in_kbytes</VAR>&quot; /&gt;</PRE><P STYLE="margin-top: 0in; margin-bottom: 0in">
	At the moment, both .NET and Mono seem to ignore that setting when
	NeatUpload is being used, but there is no official documentation
	specifying exactly when that limit is enforced, so a future version
	of .NET or Mono might enforce the limit even when NeatUpload is
	being used. &nbsp; Setting the <CODE CLASS="western">&lt;httpRuntime&gt;</CODE>
	element's <CODE CLASS="western">maxRequestLength</CODE> attribute
	simply provides insurance against such future changes. &nbsp;Note
	that since that attribute is currently ignored when NeatUpload is
	used, you can't use it to actually restrict the size of uploads. &nbsp;To
	do that, see <A HREF="#Limiting_the_Size_of_Upload_Requests">Limiting
	the Size of Upload Requests</A> below.</P>
	<LI><P>(Optional)  To allow larger uploads than the 30MB default
	used by IIS7,&nbsp;add the following to your <CODE CLASS="western">Web.config</CODE>
	under the <CODE CLASS="western">configuration/system.webServer/security/requestFiltering</CODE>
	section:</P>
	<PRE STYLE="margin-bottom: 0.2in">&lt;requestLimits maxAllowedContentLength=&quot;<VAR>size_in_bytes</VAR>&quot;&gt;&lt;/requestLimits&gt;</PRE><P>
	Note that for such a change to be allowed, you or your hosting
	provider might need to change the machine's
	<CODE CLASS="western">%SystemRoot%/system32/inetserv/config/applicationHost.config</CODE>
	file such that the <CODE CLASS="western">overrideModeDefault</CODE>
	attribute for the <CODE CLASS="western">requestFiltering</CODE>
	section is <CODE CLASS="western">Allow</CODE> instead of <CODE CLASS="western">Deny.</CODE></P>
	<LI><P>(Optional) Copy the
	<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/Brettle.Web.NeatUpload/</CODE>
	folder into your application. Point your browser at the <CODE CLASS="western">Demo.aspx</CODE>
	in that folder and verify that the demo functions properly. 
	</P>
</OL>
<H2 CLASS="western"><A NAME="mozTocId879490"></A><A NAME="3.2.Using NeatUpload with the Visual Studio Web Form Designer|outline"></A>
 3.2 Using NeatUpload with the Visual Studio Web Form Designer</H2>
<P>To use the Visual Studio web form designer to add NeatUpload to a
web form, follow these steps: 
</P>
<OL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Drag the
	following controls from the toolbox onto your web form:&nbsp;<CODE CLASS="western">MultiFile</CODE>,
	<CODE CLASS="western">InputFile</CODE>, <CODE CLASS="western">ProgressBar</CODE>,
	and <CODE CLASS="western">Button</CODE>. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">(Optional) If you
	want an inline progress bar, set the <CODE CLASS="western">ProgressBar</CODE>'s
	<CODE CLASS="western">Inline</CODE> property to <CODE CLASS="western">true</CODE>.
		</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">(Optional) If you
	want to customize the <CODE CLASS="western">ProgressBar</CODE>
	fallback behavior, drag whatever control(s) you want displayed as a
	fallback onto the <CODE CLASS="western">ProgressBar</CODE> control.
	&nbsp;For example, to just change the fallback text, you could drag
	a <CODE CLASS="western">Label</CODE> control onto the ProgressBar
	and edit its contents. 
	</P>
	<LI><P>In your codebehind file,&nbsp;process the uploaded file(s).
	&nbsp;If you are using the <CODE CLASS="western">InputFile</CODE>
	control, the uploaded file's client-specified name, MIME type, and
	contents can be accessed via <VAR>inputFileId</VAR><CODE CLASS="western">.FileName</CODE>,
	<VAR>inputFileId</VAR><CODE CLASS="western">.ContentType</CODE>, and
	<CODE CLASS="western"><I>inputFileId</I></CODE><CODE CLASS="western">
	.FileContent</CODE>, respectively. &nbsp; <STRONG><B>If you want to
	keep the uploaded file, you must use the </B></STRONG><STRONG><I><B>inputFileId</B></I></STRONG><STRONG><B>.MoveTo()
	method to move the uploaded file to a permanent location. &nbsp;If
	you do not, NeatUpload will automatically remove the uploaded file
	at the end of the request</B></STRONG>to ensure that unwanted files
	are not left on the filesystem. &nbsp;The following code will put
	the uploaded file in the application's root directory (assuming
	sufficient permissions): 
	</P>
	<PRE>using Brettle.Web.NeatUpload;<BR>...<BR>using System.IO;<BR>...<BR>public class YourPage : System.Web.UI.Page<BR>{<BR>&nbsp;&nbsp;private void Page_Load(object sender, EventArgs e)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;<I>submitButtonId.Click</I> += new System.EventHandler(this.Button_Clicked);<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;}<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;private void Button_Clicked(object sender, EventArgs e)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;if (IsValid &amp;&amp; <VAR>inputFileId</VAR>.HasFile)<BR>&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<VAR>inputFileId</VAR>.MoveTo(Path.Combine(Request.PhysicalApplicationPath,<VAR>inputFileId</VAR>.FileName),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MoveToOptions.Overwrite);</PRE>
</OL>
<P>If you are using the <CODE CLASS="western">MultiFile</CODE>
control, the <VAR>multiFileId</VAR><CODE CLASS="western">.Files</CODE>
property returns an array of <CODE CLASS="western">UploadedFile</CODE>
objects.  Those objects have members similar to the above <CODE CLASS="western">InputFile</CODE>
members, that you can use to save and access the uploaded files.  
</P>
<H2 CLASS="western"><A NAME="mozTocId170882"></A><A NAME="3.3.Using NeatUpload without the Visual Studio Web Form Designer|outline"></A>
 3.3 Using NeatUpload <I>without</I> the Visual Studio Web Form
Designer</H2>
<P>To use NeatUpload on a web form <I>without</I> using the Visual
Studio designer, follow these steps: 
</P>
<OL>
	<LI><P>Add the following to the top of your page: 
	</P>
	<PRE>&lt;%@ Register TagPrefix=&quot;Upload&quot; Namespace=&quot;Brettle.Web.NeatUpload&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assembly=&quot;Brettle.Web.NeatUpload&quot; %&gt;</PRE>
	<LI><P>Add an <CODE CLASS="western">InputFile</CODE> or <CODE CLASS="western">MultiFile</CODE>
	control to your aspx page wherever you want the user to choose a
	file, using something like this: 
	</P>
	<PRE>&lt;Upload:InputFile id=&quot;<VAR>inputFileId</VAR>&quot; runat=&quot;server&quot; /&gt;</PRE><P STYLE="margin-top: 0in; margin-bottom: 0in">
	or this:</P>
	<PRE>&lt;Upload:MultiFile id=&quot;multi<VAR>FileId</VAR>&quot; runat=&quot;server&quot; /&gt;</PRE><P STYLE="margin-top: 0in; margin-bottom: 0in">
	Feel free to add any attributes that you would normally add to an
	<CODE CLASS="western">HtmlInputFile</CODE> tag. 
	</P>
	<LI><P>Add a <CODE CLASS="western">ProgressBar</CODE> control to
	your aspx page wherever you want to display an inline progress bar
	or, in the case of a popup progress bar, add it wherever you want
	the fallback link to be displayed. &nbsp;Use something like this: 
	</P>
	<PRE>&lt;Upload:ProgressBar id=&quot;<VAR>progressBarId</VAR>&quot; runat=&quot;server&quot; inline=&quot;<VAR>true|false</VAR>&quot; /&gt;</PRE><P STYLE="margin-top: 0in; margin-bottom: 0in">
	The inline attribute defaults to false. 
	</P>
	<LI><P>Add a submit button to your aspx page. For example: 
	</P>
	<PRE STYLE="margin-bottom: 0.2in">&lt;asp:Button id=&quot;<VAR>submitButtonId</VAR>&quot; runat=&quot;server&quot; Text=&quot;<VAR>Submit</VAR>&quot; /&gt;</PRE>
	<LI><P>In your codebehind file, declare each <CODE CLASS="western">MultiFile</CODE>,
	<CODE CLASS="western">InputFile</CODE>, <CODE CLASS="western">ProgressBar</CODE>,
	and <CODE CLASS="western">Button</CODE> control using code like
	this: 
	</P>
	<PRE>using Brettle.Web.NeatUpload;<BR>...<BR>using System.Web.UI.WebControls;<BR>...<BR>public class YourPage : System.Web.UI.Page<BR>{<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;protected InputFile <VAR>inputFileId</VAR>;<BR>&nbsp;&nbsp;protected MultiFile <VAR>multiFileId</VAR>;<BR>&nbsp;&nbsp;protected ProgressBar <VAR>progressBarId</VAR>; <BR>&nbsp;&nbsp;protected Button <I>submitButtonId</I>;</PRE>
	<LI><P>In your codebehind file,&nbsp;process the uploaded file. &nbsp;If
	you are using the <CODE CLASS="western">InputFile</CODE> control,
	the uploaded file's client-specified name, MIME type, and contents
	can be accessed via <VAR>inputFileId</VAR><CODE CLASS="western">.FileName</CODE>,
	<VAR>inputFileId</VAR><CODE CLASS="western">.ContentType</CODE>, and
	<CODE CLASS="western"><I>inputFileId</I></CODE><CODE CLASS="western">
	.FileContent</CODE>, respectively. &nbsp; <STRONG><B>If you want to
	keep the uploaded file, you must use the </B></STRONG><CODE CLASS="western"><I><B>inputFileId</B></I></CODE><CODE CLASS="western"><B>.MoveTo()</B></CODE><STRONG><B>method
	to move the uploaded file to a permanent location. &nbsp;If you do
	not, NeatUpload will automatically remove the uploaded file at the
	end of the request</B></STRONG>to ensure that unwanted files do not
	fill up the filesystem. &nbsp;The following code will put the
	uploaded file in the application's root directory (assuming
	sufficient permissions): 
	</P>
	<PRE>using Brettle.Web.NeatUpload;<BR>...<BR>using System.IO;<BR>...<BR>public class YourPage : System.Web.UI.Page<BR>{<BR>&nbsp;&nbsp;private void Page_Load(object sender, EventArgs e)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;<I>submitButtonId.Click</I> += new System.EventHandler(this.Button_Clicked);<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;}<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;private void Button_Clicked(object sender, EventArgs e)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;if (IsValid &amp;&amp; <VAR>inputFileId</VAR>.HasFile)<BR>&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<VAR>inputFileId</VAR>.MoveTo(Path.Combine(Request.PhysicalApplicationPath,<VAR>inputFileId</VAR>.FileName),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MoveToOptions.Overwrite);</PRE>
</OL>
<P>If you are using the <CODE CLASS="western">MultiFile</CODE>
control, the <VAR>multiFileId</VAR><CODE CLASS="western">.Files</CODE>
property returns an array of <CODE CLASS="western">UploadedFile</CODE>
objects.  Those objects have members similar to the above <CODE CLASS="western">InputFile</CODE>
members, that you can use to save and access the uploaded files.  
</P>
<H2 CLASS="western"><A NAME="3.4.Allowing Users with Flash to Select Multiple Files from One File Selection Dialog|outline"></A><A NAME="0.0.2.Allowing Users with Flash to Select Multiple Files from One File Selection Dialog|outline"></A><A NAME="0.0.2.Allowing Users with Flash to Select Multiple Files from One File Selection Dialog|outline"></A><A NAME="3.4.Allowing Users with Flash to Select Multiple Files from One File Selection Dialog|outline"></A>
 3.4 Allowing Users with Flash to Select Multiple Files from One File
Selection Dialog</H2>
<P>By default, the NeatUpload <CODE CLASS="western">MultiFile</CODE>
control requires the user to use select each file they want to upload
using a new file selection dialog.  This can be cumbersome when
uploading a large number of files.  If you set <CODE CLASS="western">MultiFile</CODE>'s
<CODE CLASS="western">UseFlashIfAvailable</CODE> property to true,
then users with Flash 8 or above and a compatible browser will be
able select multiple files from a single file selection dialog (e.g.
using shift-click or ctrl-click).  This functionality has been tested
under IE7, Windows Firefox 3, and Windows Safari 3 but should work
with any browser that supports using JavaScript to make calls to
ActionScript functions defined in transparent Flash movies.  Users of
browsers that don't have the required support (e.g. Opera 9 and Linux
Firefox 2) can continue to select one file per-dialog.  You can set
<CODE CLASS="western">MultiFile</CODE>'s <CODE CLASS="western">FlashFilterExtensions</CODE>
property to a semicolon delimited list of extension patterns (e.g.
“*.jpg;*.gif”) that Flash will allow the user to select in the
file selection dialog.  You can also set <CODE CLASS="western">MultiFile</CODE>'s
<CODE CLASS="western">FlashFilterDescription</CODE> to a short
textual description of the files that Flash will allow the user to
select.  Flash displays that description in the file selection
dialog.</P>
<H2 CLASS="western"><A NAME="3.5.Validating File Names|outline"></A> 3.5 Validating
File Names</H2>
<P>NeatUpload's <CODE CLASS="western">MultiFile</CODE> and <CODE CLASS="western">InputFile</CODE>
controls can be used with validation controls (e.g.
<CODE CLASS="western">RegularExpressionValidator</CODE>) to restrict
the file names that are allowed.  If the validation control is
capable of client-side validation and the browser supports
JavaScript, the file names will be validated before the upload
starts.  Otherwise, they will be validated after the files have been
uploaded.  Note that the validation controls in ASP.NET 1.1 don't do
client-side validation for many non-IE browsers.  That is fixed in
ASP.NET 2.0 and later.  Developers using ASP.NET 1.1 should consider
alternative validation controls.</P>
<P>To validate an <CODE CLASS="western">InputFile</CODE> or <CODE CLASS="western">MultiFile</CODE>
control using an ASP.NET validator, just set the validator's
<CODE CLASS="western">ControlToValidate</CODE> property to the ID of
the <CODE CLASS="western">InputFile</CODE> or <CODE CLASS="western">MultiFile</CODE>
control.  For the <CODE CLASS="western">InputFile</CODE> control, the
validator will validate the <CODE CLASS="western">ValidationFileName</CODE>
property which is the same as the <CODE CLASS="western">FileName</CODE>
property except that is an empty string (instead of null) when there
are no files.  For the <CODE CLASS="western">MultiFile</CODE>
control, the validator will validate the <CODE CLASS="western">ValidationFileNames</CODE>
property which is a semicolon-delimited list of the file names, or an
empty string if there are no files.  The
<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/Brettle.Web.NeatUpload/Demo.aspx
</CODE>page contains examples of using <CODE CLASS="western">RegularExpressionValidators</CODE>
to validate <CODE CLASS="western">InputFile</CODE> and <CODE CLASS="western">MultiFile</CODE>
controls.</P>
<H2 CLASS="western"><A NAME="3.6.Preventing Accidental Upload Interruptions|outline"></A>
 3.6 Preventing Accidental Upload Interruptions</H2>
<P>By default, any in-progress uploads are uploaded when a user
resubmits the form, closes the browser window, or attempts to view
another page in the same window that started the upload.  To prevent
a user from accidentally interrupting the upload in any of those ways
add the <CODE CLASS="western">UnloadConfirmer</CODE> control to your
page.  It will display a confirmation dialog to the user if they do
something that would interrupt the upload.  The text of the
confirmation defaults to the <CODE CLASS="western">UnloadConfirmation</CODE>
resource in
<CODE CLASS="western">NeatUpload&nbsp;</CODE><VAR>version</VAR><CODE CLASS="western">/dotnet/src/Brettle.Web.NeatUpload/NeatUpload.Strings.resx</CODE>
and can be overriden using the <CODE CLASS="western">Text</CODE>
property of the <CODE CLASS="western">UnloadConfirmer</CODE> control.</P>
<H2 CLASS="western"><A NAME="mozTocId900479"></A><A NAME="3.7.Avoiding Unnecessary Uploads and Progress Displays|outline"></A>
 3.7 Avoiding Unnecessary Uploads and Progress Displays</H2>
<P>By default, anytime the user submits a form containing a non-empty
<CODE CLASS="western">MultiFile</CODE> or <CODE CLASS="western">InputFile</CODE>
and a <CODE CLASS="western">ProgressBar</CODE>, the progress display
is started (either inline or in a popup). &nbsp;If all <CODE CLASS="western">MultiFile</CODE>
and <CODE CLASS="western">InputFiles</CODE> are empty, the progress
display is not started. &nbsp;That ensures that the user is not
distracted by a transient and meaningless progress display.<BR><BR>Now
consider the case where the form contains a cancel button in addition
to a normal submit button. &nbsp;Both buttons cause the form to be
submitted, but when the cancel button is clicked, the server ignores
the values on the form. &nbsp;By default, if the user selects a file
to upload and then changes his mind and clicks the cancel button, the
progress display will start and the user will need to wait for the
file to be uploaded. &nbsp;To avoid this unfriendly behavior,
NeatUpload allows you to specify &quot;trigger&quot; controls. &nbsp;If
you specify at least one trigger, then form submissions&nbsp;initiated
via any <I>other</I> control will cause NeatUpload to clear all file
upload controls (including <CODE CLASS="western">MultiFile</CODE>,<CODE CLASS="western">
InputFile</CODE>, and ASP.NET's <CODE CLASS="western">FileUpload </CODE>and
<CODE CLASS="western">HtmlInputFile)</CODE> so that no files will be
uploaded and the progress display will not start. &nbsp;(On some
downlevel browsers, notably Internet Explorer for the Mac, NeatUpload
can't clear the controls so it displays a dialog asking the user to
clear them manually and try again. &nbsp;The text for that dialog can
be customized via the <CODE CLASS="western">ClearFileNamesAlert</CODE>
resource in
<CODE CLASS="western">NeatUpload&nbsp;</CODE><VAR>version</VAR><CODE CLASS="western">/dotnet/src/Brettle.Web.NeatUpload/NeatUpload.Strings.resx</CODE>.)<BR><BR>If
your form contains more than one <CODE CLASS="western">ProgressBar</CODE>,
each <CODE CLASS="western">ProgressBar</CODE> which specifies trigger
controls will only start when the form submission is initiated by one
of those controls.<BR><BR>There are two ways to indicate that a
control is a &quot;trigger&quot; control.  The first way is to
include the ID of the control in the <CODE CLASS="western">ProgressBar</CODE>'s
<CODE CLASS="western">Triggers </CODE>property/attribute.  Multiple
IDs must be space-separated.  Each ID can either by the <CODE CLASS="western">ID</CODE>
or <CODE CLASS="western">ClientID</CODE> property of the trigger. 
The second way is to call the ProgressBar's <CODE CLASS="western">AddTrigger(Control)</CODE>
method. &nbsp;Note: if you call the <CODE CLASS="western">AddTrigger(Control)</CODE>
method, you need to call it each time the page is loaded (even when
<CODE CLASS="western">Page.IsPostBack</CODE> is <CODE CLASS="western">true</CODE>)
because the list of trigger controls is not maintained in the page's
<CODE CLASS="western">ViewState</CODE>.</P>
<H2 CLASS="western"><A NAME="3.8.Showing Processing Progress|outline"></A>
 3.8 Showing Processing Progress</H2>
<P>By default, the NeatUpload <CODE CLASS="western">ProgressBar</CODE>
displays &quot;Processing...&quot; (the <CODE CLASS="western">ProcessingMessage</CODE>
resource in
<CODE CLASS="western">NeatUpload&nbsp;</CODE><VAR>version</VAR><CODE CLASS="western">/dotnet/src/Brettle.Web.NeatUpload/NeatUpload.Strings.resx</CODE>)
if it refreshes while the code associated with your page runs. In
most cases your code finishes running before the display refreshes,
so you never see that text. However, if you perform some long-running
task (e.g. converting large images to a different format) you can use
the <CODE CLASS="western">ProgressBar</CODE> to display how that task
is progressing. 
</P>
<P>To display the progress of a long-running task, you must first: 
</P>
<OL>
	<LI><P>Use <CODE CLASS="western">EnableSessionState=&quot;false&quot;</CODE>
	in your <CODE CLASS="western">&lt;%@Page ...%&gt;</CODE> directive.
	If you don't do that your page will hold a lock on the session for
	the duration of your long-running task. That will block the display
	of any other pages which need access to the session until your
	long-running task completes. More importantly, NeatUpload's progress
	display will not update because it needs access to the session to
	determine how the upload is progressing. If you need to access the
	session from your page, you should consider moving the code that
	requires that access into a web method that you can can from your
	page.</P>
	<LI><P>By setting  <CODE CLASS="western">EnableSessionState=&quot;false&quot;</CODE>
	you also prevent ASP.NET from starting a new session if the user
	doesn't yet have one.  If the user doesn't have a session when the
	upload starts and the <CODE CLASS="western">UploadStateStoreProvider</CODE>
	you are using requires a session, then the progress display will not
	update at all.  This happens most often during development when you
	go directly to the page with <CODE CLASS="western">EnableSessionState=&quot;false&quot;</CODE>
	to test it.  To avoid this issue, ensure that the user visits a page
	without <CODE CLASS="western">EnableSessionState=&quot;false&quot;
	</CODE><EM>that stores something in the session</EM>, before
	visiting the page with <CODE CLASS="western">EnableSessionState=&quot;false&quot;</CODE>.
	The page must store something in the session, because that is the
	only way to guarantee that a new session will be established.  If
	the user isn't guaranteed to go through such a page first, you can
	create a redirector page that stores something in the session and
	then uses <CODE CLASS="western">Response.Redirect()</CODE> to
	redirect the user to the target page.  Alternatively, if you aren't
	using a web garden or web farm, you can avoid the need to establish
	a session by configuring NeatUpload to use the
	<CODE CLASS="western">InProcUploadStateStoreProvider</CODE> as
	described in <A HREF="#4.9.Reducing Server Load|outline">Reducing
	Server Load</A>.</P>
	<LI><P>If you're form doesn't contain any <CODE CLASS="western">MultiFile</CODE>
	or <CODE CLASS="western">InputFile</CODE> controls you need to add a
	<CODE CLASS="western">HiddenPostBackID</CODE> control at the top of
	the form so that NeatUpload can associate the form submission with
	the progress display. 
	</P>
	<LI><P>If you want to display progress even if the user doesn't
	upload a file (either because your form doesn't have a way to select
	file or because the user chose not to select a file), you need to
	set the <CODE CLASS="western">ProgressBar</CODE>'s
	<CODE CLASS="western">AutoStartCondition</CODE> property to the
	string <CODE CLASS="western">&quot;true&quot;</CODE>. 
	</P>
</OL>
<P>To actually update the progress display from the your page: 
</P>
<OL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Set the
	<CODE CLASS="western">ProgressBar</CODE>'s <CODE CLASS="western">ProcessingProgress</CODE>
	property to a new <CODE CLASS="western">ProgressInfo</CODE> object,
	passing to the constructor the maximum number of work units that
	will be performed and a string describing those units. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Update the
	<CODE CLASS="western">ProgressInfo</CODE>'s <CODE CLASS="western">Value</CODE>
	property as the task progresses. The <CODE CLASS="western">Value</CODE>
	property will control the position of the bar. If <CODE CLASS="western">Value</CODE>
	is 0, no bar will be shown. If it is equal to the <CODE CLASS="western">Maximum</CODE>
	property (initialized via the constructor), a full bar will be
	shown. 
	</P>
	<LI><P>Optionally, update the <CODE CLASS="western">ProgressInfo</CODE>'s
	<CODE CLASS="western">Text</CODE> property. By default, when a
	<CODE CLASS="western">ProgressBar</CODE>'s <CODE CLASS="western">ProcessingProgress</CODE>
	property has been set, it will display &quot;<I>Value</I>/<I>MaximumUnits</I>
	processed&quot; where <I>Value</I>, <I>Maximum</I>, and <I>Units</I>
	are the corresponding properties of the <CODE CLASS="western">ProgressInfo</CODE>
	object. You can localize that text via the <CODE CLASS="western">ProgressInfoFormat</CODE>
	resource in
	<CODE CLASS="western">NeatUpload&nbsp;</CODE><VAR>version</VAR><CODE CLASS="western">/dotnet/src/Brettle.Web.NeatUpload/NeatUpload.Strings.resx</CODE>
	or you can replace that text completely by setting the
	<CODE CLASS="western">ProgressInfo</CODE>'s <CODE CLASS="western">Text</CODE>
	property. 
	</P>
</OL>
<P>Here's an example: 
</P>
<PRE>...<BR>myProgressBar.ProcessingProgress = new ProgressInfo(5, &quot;images&quot;);<BR>for (int i = 1; i &lt;= 5; i++)<BR>{<BR>&nbsp;&nbsp;ConvertImage(i);<BR>&nbsp;&nbsp;myProgressBar.ProgressInfo.Value = i;<BR>}<BR>myProgressBar.ProgressInfo.Text = &quot;Image conversion complete&quot;;<BR>...</PRE><P>
For a complete working example, see <CODE CLASS="western">Processing.aspx</CODE>
and <CODE CLASS="western">Processing.aspx.cs</CODE> in the
<CODE CLASS="western">NeatUpload-1.3.x/dotnet/app/Brettle.Web.NeatUpload/tests/</CODE>
directory. 
</P>
<H2 CLASS="western"><A NAME="UploadingWithoutInputFile"></A><A NAME="3.9.Uploading without InputFile|outline"></A>
 3.9 Uploading without <CODE CLASS="western">InputFile</CODE></H2>
<P>By default, NeatUpload will stream to storage only those files
associated with <CODE CLASS="western">MultiFile</CODE> or <CODE CLASS="western">InputFile</CODE>
controls.&nbsp; Other files will be processed by ASP.NET and will
only cause any <CODE CLASS="western">ProgressBar</CODE>s to update if
they happen to occur after a file that NeatUpload has streamed.&nbsp;
To tell NeatUpload to stream the other files, you must put a
<CODE CLASS="western">HiddenPostBackID</CODE> control in your form
before the controls used to upload those other files.&nbsp; If you
are using the Visual Studio web form designer, just drag-and-drop the
control at the top of your form.&nbsp; Otherwise, just manually add
<CODE CLASS="western">&lt;Upload:HiddenPostBackID runat=&quot;server&quot;/&gt;</CODE>
just inside the <CODE CLASS="western">&lt;form&gt;</CODE> element on
your page.&nbsp; There are no properties to set. 
</P>
<P>Files that NeatUpload streams to storage are not available via the
standard ASP.NET <CODE CLASS="western">Request.Files</CODE>
property.&nbsp; Instead, they must be accessed via the static
<CODE CLASS="western">Brettle.Web.NeatUpload.UploadModule.Files</CODE>
property.&nbsp; Since ASP.NET doesn't allow subclassing of the
<CODE CLASS="western">HttpFileCollection</CODE> returned by
<CODE CLASS="western">Request.Files</CODE> (nor the <CODE CLASS="western">HttpPostedFile</CODE>
class), NeatUpload attempts to mimic their API with new classes
called <CODE CLASS="western">UploadedFileCollection</CODE> and
<CODE CLASS="western">UploadedFile</CODE>.&nbsp; <CODE CLASS="western">UploadModule.Files</CODE>
only contains an <CODE CLASS="western">UploadedFile</CODE> object for
files that NeatUpload streamed to storage.  To convert an
<CODE CLASS="western">HttpPostedFile</CODE> to an <CODE CLASS="western">UploadedFile</CODE>,
pass it to <CODE CLASS="western">UploadModule.ConvertToUploadedFile()</CODE>.
 If the <CODE CLASS="western">UploadHttpModule</CODE> is listed in
the <CODE CLASS="western">&lt;httpModules&gt;</CODE> section (even if
it is disabled), <CODE CLASS="western">ConvertToUploadedFile()</CODE>
will stream the file to storage and return a corresponding
<CODE CLASS="western">UploadedFile</CODE>.&nbsp; If no upload module
is listed in the <CODE CLASS="western">&lt;httpModules&gt;</CODE>
section, <CODE CLASS="western">ConvertToUploadedFile()</CODE> will
return a subclass of <CODE CLASS="western">UploadedFile</CODE> that
delegates to the underlying <CODE CLASS="western">HttpPostedFile</CODE>.</P>
<P>There is one important difference between <CODE CLASS="western">UploadedFile</CODE>
and <CODE CLASS="western">HttpPostedFile</CODE>.  You must call the
<CODE CLASS="western">Dispose()</CODE> method of each <CODE CLASS="western">UploadedFile</CODE>
you use when you are done with it.  If you do not call <CODE CLASS="western">Dispose()</CODE>,
temporary files or other similar resources might not get cleaned up. 
This is particularly important if the <CODE CLASS="western">UploadHttpModule</CODE>
is disabled or not listed in the <CODE CLASS="western">&lt;httpModules&gt;</CODE>
section.</P>
<H2 CLASS="western"><A NAME="mozTocId483750"></A><A NAME="3.10.Uploading from a Client Application|outline"></A>
 3.10 Uploading from a Client Application</H2>
<P>If your users are uploading using their web browser, you don't
need to read this section. &nbsp;This section is for environments
where a separate client application uses HTTP POST requests to
uploads files to your application. &nbsp;You should read the earlier
sections before reading this one.<BR><BR>In order for NeatUpload to
process requests from non-browser client applications, each request
needs to contain a unique ID&nbsp;called a post-back ID. &nbsp;NeatUpload
looks for the post-back ID in a parameter that is in either the query
string or in a form field in the body of the request that occurs
before the files to be streamed. &nbsp;The parameter name is
<A HREF="#mozTocId991184">configurable</A>. &nbsp;By default,
NeatUpload looks for a parameter named &quot;NeatUpload_PostBackID&quot;.
&nbsp;The post-back ID itself does not need to be in any particular
format, but it needs to be unique for each request. &nbsp;So, for
example, if the client application uploads the file to :</P>
<PRE STYLE="margin-bottom: 0.2in">http://www.tempuri.org/path/to/MyUploadPage.aspx?NeatUpload_PostBackID=afa02a6999e54541bb6873151d1dfbfc</PRE><P>
<BR>then NeatUpload will use &quot;afa02a6999e54541bb6873151d1dfbfc&quot;
as the post-back ID.<BR><BR>If NeatUpload finds the post-back ID in
the query string it will stream all files in the request to storage.
&nbsp;You can access the uploaded file via the static
<CODE CLASS="western">Brettle.Web.NeatUpload.UploadModule.Files</CODE>
property.&nbsp;Alternatively, you can put <CODE CLASS="western">MultiFile</CODE>
or <CODE CLASS="western">InputFile</CODE> controls on your page and
make sure that the name of the form field(s) used by the client
application match the control IDs of your <CODE CLASS="western">MultiFile</CODE>
or <CODE CLASS="western">InputFile</CODE> control(s). &nbsp;So, if
your client application uses a field name of &quot;FILE001&quot;, you
could put the following in your page:</P>
<PRE>...<BR>&lt;Upload:InputFile id=&quot;FILE001&quot; runat=&quot;server&quot; /&gt;<BR>...</PRE><H2 CLASS="western">
<A NAME="3.11.Using NeatUpload from JavaScript|outline"></A> 3.11 Using
NeatUpload from JavaScript</H2>
<P>NeatUpload's controls implement much of their functionality
through JavaScript found in NeatUpload.js.  You can use NeatUpload.js
directly to write your own controls or even use NeatUpload from a
static HTML page.  For an example of using NeatUpload from a static
HTML page, see
<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/Brettle.Web.NeatUpload/tests/StaticPage.htm</CODE>.
 The comments in the source code for that page provide more details.</P>
<P>That page also demonstrates how to access the state of the upload
as a Java	Script Object Notation (JSON) object returned by
<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/NeatUpload/ProgressJsonHandler.ashx</CODE><CODE CLASS="western"><SPAN STYLE="font-weight: normal">.
 </SPAN></CODE>
</P>
<H1><A NAME="mozTocId221000"></A><A NAME="4.Configuration|outline"></A>
 4 Configuration</H1>
<H2 CLASS="western"><A NAME="mozTocId576312"></A><A NAME="4.1.Using the &lt;neatUpload&gt; Configuration Section|outline"></A><A NAME="4.1.Using the &lt;neatUpload&gt; Configuration Section|outline"></A>
 4.1 Using the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
Configuration Section</H2>
<P>To configure NeatUpload, you need to add the NeatUpload
configuration section handler to your <CODE CLASS="western">Web.config</CODE>:</P>
<PRE>&lt;configuration&gt;<BR>&nbsp;&nbsp;&lt;configSections&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;section name=&quot;neatUpload&quot; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;Brettle.Web.NeatUpload.ConfigSectionHandler, Brettle.Web.NeatUpload&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowLocation=&quot;true&quot; /&gt;<BR>&nbsp;&nbsp;&lt;/configSections&gt;<BR>...</PRE><P>
In addition, if you are using ASP.NET 2.0 or higher under medium
trust, you need to add <CODE CLASS="western">requirePermission=&quot;false&quot;</CODE>
to the &lt;section&gt; element above.</P>
<P>Once you've added the configuration section handler, you can add
the &lt;neatUpload&gt; element inside your <CODE CLASS="western">Web.config
</CODE>like this:</P>
<PRE STYLE="margin-left: 0in">&lt;configuration&gt;<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;neatUpload xmlns=&quot;http://www.brettle.com/neatupload/config/2008&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Using Location Filtering to Restrict/Modify NeatUpload's Request Processing|outline">useHttpModule</A>=&quot;<I>true or false, defaults to true</I>&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Changing the Maximum Size of Normal Requests|outline">maxNormalRequestLength</A>=&quot;<I>up to 2097151in KBytes, defaults to 4096</I>&quot; <BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Limiting the Size of Upload Requests|outline">maxRequestLength</A>=&quot;<I>up to 2097151in KBytes, defaults to 2097151</I>&quot; <BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Limiting the Upload Rate|outline">maxUploadRate</A>=&quot;<I>rate in KBytes/sec, defaults to -1 which means unlimited</I>&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Changing the Query String Parameter Used When Uploading From Client Applications|outline">postBackIDQueryParam</A>=&quot;<I>parameter name, defaults to NeatUpload_PostBackID</I>&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Changing the Location of NeatUpload's Files|outline">multiRequestUploadHandlerUrl</A>=<FONT FACE="Nimbus Mono L, monospace">&quot;</FONT><I>URL that handles the requests in a multi-request upload,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaults to ~/NeatUpload/MultiRequestUploadHandler.ashx</I><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2>&quot;</FONT></FONT></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.1.Troubleshooting|outline">debugDirectory</A><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2>=&quot;</FONT></FONT></FONT><I>directory to which debug info should be written, defaults to none</I><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">&quot;</SPAN></FONT></FONT></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Supporting Web Gardens and Web Farms|outline">decryption</A><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">=&quot;</SPAN></FONT></FONT></FONT><I>name of the SymmetricAlgorithm to use to encrypt/decrypt protected data, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaults to .NET default algorithm used by SymmetricAlgorithm.Create()</I><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">&quot;</SPAN></FONT></FONT></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#4.12.Changing the Encryption and Validation Algorithms Used|outline">validation</A><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">=&quot;</SPAN></FONT></FONT></FONT><I>name of the HashAlgorithm to use to validate protected data, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaults to .NET default algorithm used by HashAlgorithm.Create()</I><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">&quot;</SPAN></FONT></FONT></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Supporting Web Gardens and Web Farms|outline">decryptionKey</A><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">=&quot;</SPAN></FONT></FONT></FONT><I>32 hex-digit key used to encrypt/decrypt protected data, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaults to auto-generated for each app instance</I><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">&quot;</SPAN></FONT></FONT></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Reducing Server Load|outline">stateMergeIntervalSeconds</A><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">=&quot;</SPAN></FONT></FONT></FONT><I>secs between merges of the current and stored upload states,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaults to 1</I><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">&quot;</SPAN></FONT></FONT></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="#0.0.2.Reducing Server Load|outline">stateStaleAfterSeconds</A><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">=&quot;</SPAN></FONT></FONT></FONT><I>secs before an unchanged upload state can be removed from the store,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaults to 60</I><FONT COLOR="#000000"><FONT FACE="Nimbus Mono L, monospace"><FONT SIZE=2><SPAN STYLE="font-style: normal">&quot;</SPAN></FONT></FONT></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;defaultStorageProvider=&quot;<I>friendly name, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaults to a FilesystemUploadStorageProvider with <A HREF="#TempDirectory">default temp dir</A></I>&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;defaultStateStoreProvider=&quot;<I>friendly name, defaults to a AdaptiveUploadStateStoreProvider</I>&quot;<BR>&nbsp;&nbsp;&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name=&quot;<I>friendly name</I>&quot; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;<I>type derived from Brettle.Web.NeatUpload.UploadStorageProvider</I>&quot; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<I>provider-specific-</I><FONT FACE="Nimbus Mono L, monospace"><I>attributes</I></FONT><FONT FACE="Nimbus Mono L, monospace">...</FONT> /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/providers&gt;<BR>&nbsp;&nbsp;&lt;/neatUpload&gt;<BR>&nbsp;&nbsp;...<BR>&lt;/configuration&gt;</PRE><P>
All of the attributes are optional.  The xmlns attribute allows the
Visual Studio XML Editor to provide Intellisense support for the
&lt;neatUpload&gt; element using the NeatUpload/NeatUploadConfig.xsd
file in your application.  The remaining attributes are described in
the remainder of this section and in the sections linked to the
attribute names above.</P>
<P>The <CODE CLASS="western">&lt;providers&gt;</CODE> element is also
optional. You only need to use it if you are using an
<CODE CLASS="western">UploadStorageProvider</CODE> or
<CODE CLASS="western">UploadStateStoreProvider</CODE> other than the
default providers, or if you need to change the temporary directory
used by the <CODE CLASS="western">FilesystemUploadStorageProvider</CODE>.
In those cases, you should include an &lt;add&gt; element for each
provider or provider configuration you will be using and set the
&lt;neatUpload&gt; element's <CODE CLASS="western">defaultStorageProvider</CODE>
or <CODE CLASS="western">defaultStateStoreProvider</CODE> attribute
to the name you chose for the provider you want to use by default.
For specific pages or directories, you can override that default or
add/remove/clear available providers using child configuration
sections. Child configuration sections are &lt;neatUpload&gt;
elements within &lt;location&gt; elements or in Web.config files in
subdirectories.</P>
<P>Each provider object is created and initialized at most once
during the application lifecycle - when the configuration section
containing the associated &lt;add&gt; element is relevant to a
request. A configuration section is relevant to a request if the
request matches the &quot;path&quot; attribute of the containing
&lt;location&gt; element. If there is no containing &lt;location&gt;
element, the configuration section is relevant if the requested page
is in the directory hierarchy controlled by the containing
Web.config. This means that multiple provider objects might be
created and initialized in response to a request, but only the one
configured as the &quot;defaultStorageProvider&quot; or
“defaultStateStoreProvider” for the requested page is actually
used for that request. The others might be configured as default
providers for other pages. 
</P>
<H2 CLASS="western"><A NAME="TempDirectory"></A><A NAME="4.2.Changing the Temporary Directory Used by the FilesystemUploadStorageProvider|outline"></A>
 4.2 Changing the Temporary Directory Used by the
FilesystemUploadStorageProvider</H2>
<P>By default, NeatUpload puts uploaded files in temporary files in
<CODE CLASS="western"><I>YOUR_APP_ROOT</I></CODE><CODE CLASS="western">
/app_data/NeatUpload_Temp/</CODE> if it exists (or can be created)
and is writable by your application, or failing that, it puts them in
the <A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemiopathclassgettemppathtopic.asp">system's
temporary directory</A>. You can specify a different directory using
the <CODE CLASS="western">tempDirectory</CODE> attribute of the
<CODE CLASS="western">FilesystemUploadStorageProvider</CODE>, like
this: 
</P>
<PRE>&lt;neatUpload ...<CODE CLASS="western"> defaultStorageProvider=&quot;FilesystemUploadStorageProvider&quot; ...</CODE>&gt;<BR><CODE CLASS="western">&nbsp;&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name=&quot;FilesystemUploadStorageProvider&quot;</CODE>
<CODE CLASS="western">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE CLASS="western">type=&quot;Brettle.Web.NeatUpload.FilesystemUploadStorageProvider&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tempDirectory=&quot;</CODE><CODE CLASS="western"><I>path, defaults as described above</I></CODE><CODE CLASS="western"> &quot; ... /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;/providers&gt;<BR></CODE>&lt;/neatUpload&gt;</PRE><P>
If you specify a relative path, it will be relative to your
application root directory. 
</P>
<H2 CLASS="western"><A NAME="0.0.2.Supporting Web Gardens and Web Farms|outline"></A><A NAME="0.0.2.Supporting Web Gardens and Web Farms|outline"></A><A NAME="4.3.Supporting Web Gardens and Web Farms|outline"></A>
 4.3 Supporting Web Gardens and Web Farms</H2>
<P>By default, NeatUpload won't work properly on a web garden or web
farm.  To use NeatUpload in a web garden or web farm, you need to do
the following:</P>
<UL>
	<LI><P>Specify the same random 32-hex-digit <CODE CLASS="western">decryptionKey</CODE>
	attribute in the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
	section of each server's <CODE CLASS="western">Web.config</CODE>. 
	That key allows NeatUpload to securely communicate the state of
	uploads across all application instances.</P>
	<LI><P>Use an <CODE CLASS="western">UploadStateStoreProvider</CODE>
	capable of sharing upload state across application instances.  If
	you are already maintaining session state out-of-process (e.g. using
	<CODE CLASS="western">StateServer</CODE> or <CODE CLASS="western">SQLServer</CODE>
	session state modes), use NeatUpload's
	<CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>. 
	If your session state mode is specified directly in your <CODE CLASS="western">Web.config</CODE>
	(i.e. not in a file referenced via <CODE CLASS="western">configSource</CODE>),
	NeatUpload will automatically use the
	<CODE CLASS="western">SessionBasedUploadStateProvider</CODE>. 
	Otherwise, you must explictly configure NeatUpload to use the
	<CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>,
	like this: 
	</P>
</UL>
<PRE>&lt;neatUpload ...<CODE CLASS="western"> defaultStateStoreProvider=&quot;sbStateStoreProvider&quot; ...</CODE>&gt;<BR><CODE CLASS="western">&nbsp;&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name=&quot;sbStateStoreProvider&quot;</CODE>
<CODE CLASS="western">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE CLASS="western">type=&quot;Brettle.Web.NeatUpload.SessionBasedUploadStateProvider&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;/providers&gt;<BR></CODE>&lt;/neatUpload&gt;</PRE>
<UL>
	<LI><P>If you are using a control that performs multi-request
	uploads like the <CODE CLASS="western">MultiFile</CODE> control with
	<CODE CLASS="western">useFlashWhenAvailable=”true”</CODE> you
	must specify a shared location for the uploaded files to be stored
	temporarily.  You could configure a <CODE CLASS="western">FilesystemUploadStorageProvider</CODE>
	to use a network share as the temporary directory, if the network
	share is readable and writable by the ASP.NET worker process. 
	Alternatively, you could use a different <CODE CLASS="western">UploadStorageProvider</CODE>
	(e.g. the one used by the <CODE CLASS="western">SqlServerInputFile</CODE>
	extension) which stores the uploaded files in a shared location.</P>
</UL>
<H2 CLASS="western"><A NAME="0.0.2.Using Location Filtering to Restrict/Modify NeatUpload's Request Processing|outline"></A><A NAME="4.4.Using Location Filtering to Restrict/Modify NeatUpload's Request Processing|outline"></A>
 4.4 Using Location Filtering to Restrict/Modify NeatUpload's Request
Processing</H2>
<P>By default, whenever NeatUpload's <CODE CLASS="western">UploadHttpModule</CODE>
is added via the <CODE CLASS="western">&lt;httpModules&gt;</CODE>
section of your <CODE CLASS="western">Web.config</CODE>, it
intercepts and filters <I>all</I> requests sent to your application.
&nbsp;For upload requests, it streams the uploaded files to disk and
makes them available to your code. &nbsp;It also limits the size of
the non-upload part of the request <I>and the total size of
non-upload requests</I> because that request data is stored in server
memory. &nbsp;If it didn't do that an attacker could mount a Denial
of Service attack by sending a request that contains up to
<CODE CLASS="western">maxRequestLength</CODE> kilobytes of non-file
data.</P>
<P>You can disable use of <CODE CLASS="western">UploadHttpModule</CODE>
by settting the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element's <CODE CLASS="western">useHttpModule</CODE> attribute to
false. &nbsp;If you want to use the <CODE CLASS="western">UploadHttpModule</CODE>
for only some requests, you can use ASP.NET's <CODE CLASS="western">&lt;location&gt;</CODE>
element to specify which pages it should be used for. &nbsp;You can
also use the <CODE CLASS="western">&lt;location&gt;</CODE> element to
control which <CODE CLASS="western">UploadStorageProvider</CODE> is
used for specific pages. &nbsp;For example, consider the following
configuration:</P>
<PRE STYLE="margin-left: 0in">&lt;configuration&gt;<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;system.web&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;httpRuntime maxRequestLength=&quot;100&quot; /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;httpModules&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name=&quot;UploadHttpModule&quot; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;Brettle.Web.NeatUpload.UploadHttpModule, Brettle.Web.NeatUpload&quot; /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/httpModules&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;/system.web&gt;<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;neatUpload ... useHttpModule=&quot;false&quot; maxNormalRequestLength=&quot;100&quot; maxRequestLength=&quot;2097151&quot;&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name=&quot;special&quot; type=&quot;Brettle.Web.NeatUpload.FilesystemUploadStorageProvider&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tempDirectory=&quot;SpecialTempDirectory&quot; /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/providers&gt;<BR>&nbsp;&nbsp;&lt;/neatUpload&gt;<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;location path=&quot;Upload.aspx&quot;&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;system.web&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;httpRuntime maxRequestLength=&quot;2097151&quot; executionTimeout=&quot;3600&quot; /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/system.web&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;neatUpload useHttpModule=&quot;true&quot; /&gt;<BR>&nbsp;&nbsp;&lt;/location&gt;<BR>&nbsp;&nbsp;&lt;location path=&quot;Special.aspx&quot;&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;system.web&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;httpRuntime maxRequestLength=&quot;2097151&quot; executionTimeout=&quot;3600&quot; /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/system.web&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;neatUpload useHttpModule=&quot;true&quot; defaultStorageProvider=&quot;special&quot; /&gt;<BR>&nbsp;&nbsp;&lt;/location&gt;<BR>&nbsp;&nbsp;...<BR>&lt;/configuration&gt;</PRE><P>
That configuration will cause the <CODE CLASS="western">UploadHttpModule</CODE>
to&nbsp;only be used for requests to <CODE CLASS="western">Upload.aspx</CODE>
and <CODE CLASS="western">Special.aspx</CODE>. &nbsp;In addition,
ASP.NET's <CODE CLASS="western">maxRequestLength</CODE> is set to
only 100 KBytes for all requests other than those two pages. &nbsp;For
those two pages, the <CODE CLASS="western">maxRequestLength</CODE> is
increased to 2 GBytes and the <CODE CLASS="western">executionTimeout</CODE>
is increased to 1 hour. &nbsp;Also, requests for <CODE CLASS="western">Special.aspx</CODE>
use the &quot;special&quot; provider which is configured to use the
&quot;<CODE CLASS="western">SpecialTempDirectory</CODE>&quot;, while
requests for <CODE CLASS="western">Upload.aspx</CODE> use the default
provider and the default temporary directory.<BR><BR>Note that you
still need to add the <CODE CLASS="western">UploadHttpModule</CODE>
in the <CODE CLASS="western">&lt;httpModules&gt;</CODE> section so
that it will be available to your application.&nbsp; Location
filtering just gives you finer control over which requests the
<CODE CLASS="western">UploadHttpModule</CODE> actually touches.</P>
<H2 CLASS="western"><A NAME="mozTocId970185"></A><A NAME="Limiting_the_Size_of_Upload_Requests"></A><A NAME="0.0.2.Limiting the Size of Upload Requests|outline"></A><A NAME="4.5.Limiting the Size of Upload Requests|outline"></A>
 4.5 Limiting the Size of Upload Requests</H2>
<P>By default, NeatUpload does not directly limit the size of
uploads. &nbsp;To limit upload size,&nbsp;use the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element's <CODE CLASS="western">maxRequestLength </CODE>attribute: 
</P>
<PRE STYLE="margin-bottom: 0.2in">&lt;neatUpload ... maxRequestLength=&quot;<EM>sizeInKBytes</EM>&quot; ... /&gt;</PRE><P>
If a user attempts to upload a file larger than the specified size,
NeatUpload will update the progress bar to indicate that the upload
was rejected because it was too large. &nbsp;If the progress bar is
in a pop-up window, it will leave the window open to ensure that the
user sees why the upload was rejected. &nbsp; Next it will attempt to
stop the upload by asking the browser to run JavaScript that
simulates clicking the browser's Stop button. &nbsp;If JavaScript is
enabled, most modern browsers (including recent versions of IE,
Firefox, and Opera) will be able to stop the upload and the user will
simply see the original form along with the progress bar displaying
the reason the upload was rejected. &nbsp;The remainder of this
section only affects the user when the browser is <I>not</I> able to
stop the upload.</P>
<P>After asking the browser to stop the upload using JavaScript,
NeatUpload reads the remainder of the request and then throws an
<CODE CLASS="western">UploadTooLargeException</CODE> . &nbsp;The
<CODE CLASS="western">UploadTooLargeException&nbsp;</CODE>class is a
subclass of <CODE CLASS="western">UploadException</CODE> with an HTTP
status code of 413. &nbsp;If the browser hasn't stopped the upload
for some reason, the exception will cause the user to see&nbsp;a
generic error page by default. &nbsp;If you want something more
user-friendly, you can either handle the error by adding a handler
for the <CODE CLASS="western">HttpApplication.Error</CODE> event, or
you can use a custom error page. &nbsp;NeatUpload comes with an
example custom error page. &nbsp;To use it, add the following to
your&nbsp;<CODE CLASS="western">Web.config</CODE> under
<CODE CLASS="western">configuration/system.web</CODE>: 
</P>
<PRE>&lt;customErrors mode=&quot;On&quot;&gt;<BR>&nbsp;&nbsp;&lt;error statusCode=&quot;413&quot; redirect=&quot;~/NeatUpload/Error413.aspx&quot; /&gt;<BR>&lt;/customErrors&gt;</PRE><P>
Note: most browsers, including IE and Firefox, won't display any new
content until the entire upload has been sent to the server. &nbsp;If
that takes longer than the amount of time specified via the
<CODE CLASS="western">httpRuntime</CODE> element's <CODE CLASS="western">executionTimeout</CODE>
attribute, the server may choose to close the connection and the user
will see a different error. &nbsp;IE will display a generic error
page saying &quot;Page cannot be displayed&quot;. &nbsp;Firefox will
display a dialog saying &quot;Document contains no data&quot;. &nbsp;The
default <CODE CLASS="western">executionTimeout</CODE> is 360 seconds.</P>
<H2 CLASS="western"><A NAME="mozTocId358727"></A><A NAME="0.0.2.Changing the Maximum Size of Normal Requests|outline"></A><A NAME="4.6.Changing the Maximum Size of Normal Requests|outline"></A>
 4.6 Changing the Maximum Size of Normal Requests</H2>
<P>By default, NeatUpload restricts the size of non-upload requests
and the non-upload portion of upload requests to 4 MBytes. To specify
a different maximum size,&nbsp;use the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element's <CODE CLASS="western">maxNormalRequestLength </CODE>attribute:
</P>
<PRE STYLE="margin-bottom: 0.2in">&lt;neatUpload ... maxNormalRequestLength=&quot;<EM>sizeInKBytes</EM>&quot; ... /&gt;</PRE><P>
The behavior when this value is exceeded is similar to the behavior
when the <CODE CLASS="western">maxRequestLength</CODE> is exceeded.
&nbsp;See the preceding section for details. &nbsp;The only
differences are: 
</P>
<OL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">For upload
	requests where the non-file portion exceeds the
	<CODE CLASS="western">maxNormalRequestLength</CODE> limit,
	NeatUpload throws a <CODE CLASS="western">NonfilePortionTooLargeException</CODE>
	instead of an <CODE CLASS="western">UploadTooLargeException</CODE>. 
	</P>
	<LI><P>For non-upload requests that exceed the
	<CODE CLASS="western">maxNormalRequestLength</CODE> limit,
	NeatUpload does not attempt to use JavaScript to interrupt the
	browser and the exception that is thrown is an <CODE CLASS="western">HttpException(413,
	&quot;Request Entity Too Large&quot;)</CODE> instead of an
	<CODE CLASS="western">UploadTooLargeException()</CODE>. 
	</P>
</OL>
<H2 CLASS="western"><A NAME="MaxUploadRate"></A><A NAME="0.0.2.Limiting the Upload Rate|outline"></A><A NAME="4.7.Limiting the Upload Rate|outline"></A>
 4.7 Limiting the Upload Rate</H2>
<P>By default, NeatUpload receives the upload as fast as it can. &nbsp;To
limit the rate at which the upload is received, use the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element's <CODE CLASS="western">maxUploadRate</CODE> attribute:</P>
<PRE STYLE="margin-bottom: 0.2in">&lt;neatUpload ... maxUploadRate=&quot;<EM>rateInKBytesPerSec</EM>&quot; ... /&gt;</PRE><P>
This is mostly useful when testing on your local machine. &nbsp;By
limiting the upload rate, you can get a better idea how the progress
display will look when users upload over the internet.</P>
<H2 CLASS="western"><A NAME="mozTocId652103"></A><A NAME="4.8.Configuring Individual InputFile and MultiFile Controls Programmatically|outline"></A>
 4.8 Configuring Individual InputFile and MultiFile Controls
Programmatically</H2>
<P>You can use the <CODE CLASS="western">StorageConfig</CODE>
property of each <CODE CLASS="western">MultiFile</CODE> and <CODE CLASS="western">InputFile</CODE>
control to change the way the <CODE CLASS="western">UploadStorageProvider</CODE>
handles the file uploaded to that control. &nbsp;The interpretation
of the <CODE CLASS="western">StorageConfig</CODE> property depends on
which <CODE CLASS="western">UploadStorageProvider</CODE> is used.
&nbsp;The default <CODE CLASS="western">FilesystemUploadStorageProvider</CODE>
only allows the temporary directory to be set via the <CODE CLASS="western">StorageConfig</CODE>
property. &nbsp;To programmatically set the temporary directory place
a line like this in&nbsp;<CODE CLASS="western">Page_Load()</CODE>:</P>
<PRE STYLE="margin-bottom: 0.2in"><I>inputFileId</I>.StorageConfig[&quot;tempDirectory&quot;] = &quot;<I>path_to_temp_directory</I>&quot;;</PRE><P>
Before using the <CODE CLASS="western">StorageConfig</CODE> property,
it is critical to understand how the <CODE CLASS="western">StorageConfig</CODE>
is communicated to the UploadStorageProvider to avoid some possible
pitfalls. &nbsp;When the <CODE CLASS="western">MultiFile</CODE> or
<CODE CLASS="western">InputFile</CODE> control is rendered,
NeatUpload encrypts the <CODE CLASS="western">StorageConfig</CODE>
with a key then renders the ciphertext and signature in a hidden form
field. &nbsp;When NeatUpload receives the upload request, it
retrieves the form field value, decrypts the ciphertext to get the
<CODE CLASS="western">StorageConfig</CODE>. &nbsp;By default,
NeatUpload automatically generates a random key when it is first
needed during the application lifetime. &nbsp;However, you can set it
explicitly by setting the <CODE CLASS="western">decryptionKey</CODE>
attributes of the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element to a random 32 digit hexadecimal string.<BR><BR>Encrypting
the <CODE CLASS="western">StorageConfig</CODE> prevents an attacker
from examining and modifying it. &nbsp;However, <B>it does not
prevent replay attacks and it will cause uploads to be rejected if
the server receiving the upload uses a different key than the server
that rendered the upload page</B>. &nbsp;Follow the following rules
to avoid these problems:</P>
<UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Only use
	<CODE CLASS="western">StorageConfig</CODE> to configure a <CODE CLASS="western">MultiFile</CODE>
	or <CODE CLASS="western">InputFile</CODE> control if you don't
	mind&nbsp;an attacker associating that <CODE CLASS="western">StorageConfig</CODE>
	with other <CODE CLASS="western">MultiFile</CODE> or <CODE CLASS="western">InputFile</CODE>
	controls&nbsp;while the same key is being used. &nbsp;This is not
	typically a problem for <CODE CLASS="western">StorageConfig[&quot;tempDirectory&quot;]</CODE>
	because it is mostly used to specify a temporary directory on the
	same drive as the final location of the file to improve performance.
	&nbsp;If an attacker used a&nbsp; <CODE CLASS="western">StorageConfig</CODE>
	from a different control, they would typically just get poor
	performance. &nbsp;Note, however, that if you decide to stop using a
	temporary directory, you should either change the key or use some
	other mechanism (e.g. change the permissions on the directory) to
	ensure that an upload that uses an old <CODE CLASS="western">StorageConfig</CODE>
	can not write to the old directory. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Only use
	<CODE CLASS="western">StorageConfig</CODE> to configure a <CODE CLASS="western">MultiFile</CODE>
	or <CODE CLASS="western">InputFile</CODE> control if you don't mind
	having uploads rejected while transitioning from old to new keys.
	&nbsp;NeatUpload will reject any uploads from forms rendered with
	the old key. &nbsp;The default rejection message is the value of the
	<CODE CLASS="western">InvalidStorageConfigMessageFormat</CODE>
	resource in
	<CODE CLASS="western">NeatUpload&nbsp;</CODE><VAR>version</VAR><CODE CLASS="western">/dotnet/src/Brettle.Web.NeatUpload/NeatUpload.Strings.resx</CODE>.
	&nbsp;It defaults to &quot;Please refresh the page and try again.&quot;
		</P>
	<LI><P>To use <CODE CLASS="western">StorageConfig</CODE> in an
	environment (e.g. a web farm) where the server rendering the form
	could be different from the server that receives the upload request,
	you must manually configure all servers to use the same keys. 
	</P>
</UL>
<H2 CLASS="western"><A NAME="4.9.Reducing Server Load|outline"></A><A NAME="4.9.Reducing Server Load|outline"></A><A NAME="0.0.2.Reducing Server Load|outline"></A><A NAME="0.0.2.Reducing Server Load|outline"></A><A NAME="4.9.Reducing Server Load|outline"></A><A NAME="4.9.Reducing Server Load|outline"></A>
 4.9 Reducing Server Load</H2>
<P>NeatUpload provides several configuration options that can help
you reduce the load on the server associated with using NeatUpload.</P>
<P>First, if you are not using a web garden or web farm but have a
session state mode other than InProc or Off, the default
<CODE CLASS="western">AdaptiveUploadStateStoreProvider</CODE> will
act like the <CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>
which will make extra web requests to transfer upload state to and
from the user's session.  To avoid those requests, you can use the
<CODE CLASS="western">InProcUploadStateStoreProvider</CODE> instead
of the default <CODE CLASS="western">AdaptiveUploadStateStoreProvider</CODE>,
like this:</P>
<PRE>&lt;neatUpload ...<CODE CLASS="western"> defaultStateStoreProvider=&quot;InProcUploadStateStoreProvider&quot; ...</CODE>&gt;<BR>&nbsp;&nbsp;<CODE CLASS="western">&lt;providers&gt;</CODE>
<CODE CLASS="western">&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE CLASS="western">...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name=&quot;InProcUploadStateStoreProvider&quot; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;Brettle.Web.NeatUpload.InProcUploadStateStoreProvider,Brettle.Web.NeatUpload&quot;/&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;/providers&gt;<BR></CODE>&lt;/neatUpload&gt;   </PRE><P>
However, note that using the <CODE CLASS="western">InProcUploadStateStoreProvider</CODE>
will cause <A HREF="#7.14.Application restarts can interrupt uploads or blank ProgressBars|outline">progress
displays to go blank and Flash uploads to stop whenever the
application is restarted</A>.</P>
<P>Next, if you are using a web garden or web farm, you can reduce
the rate at which those extra web requests are made my setting the
value of the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element's <CODE CLASS="western">stateMergeIntervalSeconds</CODE>
attribute to a value larger than the default value of 1.  However,
note that making such a change will cause the progress display to
appear to update at no more than the corresponding rate.</P>
<P>Lastly, if you find that users are interrupting many uploads and
the partial uploads are occupying too much storage space, you can
reduce the time that NeatUpload waits to remove such partial uploads
by reducing the value of the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element's <CODE CLASS="western">stateStaleAfterSeconds</CODE>
attribute from it's default of 60 seconds.</P>
<H2 CLASS="western"><A NAME="0.0.2.Changing the Location of NeatUpload's Files|outline"></A><A NAME="4.10.Changing the Location of NeatUpload's Files|outline"></A>
 4.10 Changing the Location of NeatUpload's Files</H2>
<P>By default, NeatUpload looks for all the files it needs in the
NeatUpload folder under your application root.  If you want to move
some of those files to other locations, this section will help tell
NeatUpload where to find them.</P>
<P>If you move <CODE CLASS="western">default.css</CODE>, <CODE CLASS="western">cancel.png</CODE>,
<CODE CLASS="western">refresh.png</CODE>, or <CODE CLASS="western">stop_refresh.png</CODE>,
you need to <A HREF="#0.1.0.Customizing Progress.aspx |outline">customize
</A><CODE CLASS="western"><A HREF="#0.1.0.Customizing Progress.aspx |outline">Progress.aspx</A></CODE>to
refer to them in their new locations.</P>
<P>If you move <CODE CLASS="western">Progress.aspx</CODE>, you need
to set the <CODE CLASS="western">ProgressBar</CODE>'s <CODE CLASS="western">Url</CODE>
property to refer to the new location.</P>
<P>If you move <CODE CLASS="western">MultiRequestUploadHandler.ashx</CODE>,
you need to set the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element's <CODE CLASS="western">multiRequestUploadHandlerUrl</CODE>
attribute to refer to the new location.  You also need to ensure that
sufficiently large requests are allowed and the upload module is
enabled for the new location.  The <CODE CLASS="western">Web.config</CODE>
file in the <CODE CLASS="western">NeatUpload</CODE> folder does that.</P>
<P>If you move <CODE CLASS="western">UploadStateStoreHandler.ashx</CODE>,
you need to set the <CODE CLASS="western">handlerUrl</CODE> attribute
of the <CODE CLASS="western">&lt;add&gt;</CODE> element that adds the
<CODE CLASS="western">AdaptiveUploadStateStoreProvider</CODE> so that
it refers to the new location.</P>
<P>If you move <CODE CLASS="western">Error413.aspx</CODE>, you need
to change any <CODE CLASS="western">&lt;customErrors&gt;</CODE>
section of your <CODE CLASS="western">Web.config</CODE> that refers
to that page to refer to the new location.</P>
<P><CODE CLASS="western">NeatUploadConfig.xsd</CODE> is only used to
provide Intellisense for the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
section.  It can be relocated to any location within your application
without affecting Intellisense support.  If you remove it entirely,
your application will still function normally.</P>
<H2 CLASS="western"><A NAME="mozTocId991184"></A><A NAME="0.0.2.Changing the Query String Parameter Used When Uploading From Client Applications|outline"></A><A NAME="4.11.Changing the Query String Parameter Used When Uploading From Client Applications|outline"></A>
 4.11 Changing the Query String Parameter Used When Uploading From
Client Applications</H2>
<P>If you are <A HREF="#mozTocId483750">uploading from a client
application</A>&nbsp;other than a browser, you might not have control
over the name of the query string parameter that the application uses
to identify each upload. &nbsp;To configure NeatUpload to look for a
query string parameter with a particular name, the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element's <CODE CLASS="western">postBackIDQueryParam</CODE>
attribute:</P>
<PRE STYLE="margin-bottom: 0.2in">&lt;neatUpload ... postBackIDQueryParam=&quot; <EM><FONT FACE="monospace">parameterName</FONT></EM>&quot; ... /&gt;</PRE><P>
The default value is &quot;NeatUpload_PostBackID&quot;.</P>
<H2 CLASS="western"><A NAME="4.12.Changing the Encryption and Validation Algorithms Used|outline"></A><A NAME="4.12.Changing the Encryption and Validation Algorithms Used|outline"></A>
 4.12 Changing the Encryption and Validation Algorithms Used</H2>
<P>By default, NeatUpload protects data that must pass through an
untrusted 3rd-party (e.g. the StorageConfig) by using .NET's default
<CODE CLASS="western">SymmetricAlgorithm</CODE> and <CODE CLASS="western">HashAlgorithm</CODE>.
 You can use the <CODE CLASS="western">decryption</CODE> and
<CODE CLASS="western">validation</CODE> attributes to change the
algorithms that NeatUpload uses,.  For example, the following will
cause values will allow NeatUpload to work in a FIPS compliant
environment:</P>
<PRE STYLE="margin-bottom: 0.2in">&lt;neatUpload ... decryption=”3DES” validation=”SHA1” ... /&gt;</PRE><H1>
<A NAME="mozTocId250326"></A><A NAME="5.Customization|outline"></A> 5 Customization</H1>
<H2 CLASS="western"><A NAME="mozTocId628349"></A><A NAME="Customizing_Progress_aspx"></A><A NAME="5.1.Customizing Progress.aspx|outline"></A>
 5.1 Customizing <CODE CLASS="western">Progress.aspx</CODE></H2>
<P>The <CODE CLASS="western">Progress.aspx</CODE> page that comes
with NeatUpload is just an example. You can modify it to suit your
needs. &nbsp;For example, you could change the color scheme with
minor modification to the <CODE CLASS="western">default.css</CODE>
stylesheet that is included, or you could change the text or images
that are used by modifying <CODE CLASS="western">Progress.aspx</CODE>
itself. &nbsp;You could even rearrange the layout entirely or create
a new page derived from <CODE CLASS="western">ProgressPage</CODE> and
use the <CODE CLASS="western">Url</CODE> property of the <CODE CLASS="western">ProgressBar</CODE>
to refer to it. &nbsp;To allow AJAX refreshless updates, you must
include at least one <CODE CLASS="western">DetailsSpan</CODE> or
<CODE CLASS="western">DetailsDiv</CODE> control. &nbsp;Those controls
render as like <CODE CLASS="western">div</CODE> and <CODE CLASS="western">span</CODE>
controls, respectively. &nbsp;Use data-binding expressions within
those controls (either the in the content or properties) to access
the details of the upload at runtime.&nbsp; Below is a list of the
properties and methods that NeatUpload provides for use in
data-binding expressions. &nbsp; Refer to the default <CODE CLASS="western">Progress.aspx</CODE>
for an example of how each of these is used. 
</P>
<TABLE WIDTH=1244 BORDER=1 CELLPADDING=2 CELLSPACING=3>
	<COL WIDTH=215>
	<COL WIDTH=1010>
	<THEAD>
		<TR>
			<TH WIDTH=215>
				<P>Name</P>
			</TH>
			<TH WIDTH=1010>
				<P>Description</P>
			</TH>
		</TR>
	</THEAD>
	<TBODY>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">Status</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>A value from the <CODE CLASS="western">UploadStatus</CODE>
				enumeration, as follows:<BR><CODE CLASS="western">Unknown</CODE>
				- NeatUpload has not yet started receiving the
				upload<BR><CODE CLASS="western">NormalInProgress</CODE> - a
				normal (non-chunked) upload had started but not yet
				finished<BR><CODE CLASS="western">ChunkedInProgress</CODE> - an
				upload which uses chunked transfer coding has started but not yet
				finished.<BR><CODE CLASS="western">ProcessingInProgress</CODE> -
				an upload (if any) has completed and the code associated with the
				page is running. See <A HREF="#ShowingProcessingProgress">Showing
				Processing Progress</A> for details.<BR><CODE CLASS="western">Completed</CODE>
				- the entire upload was&nbsp;successfully received and
				processed<BR><CODE CLASS="western">Cancelled</CODE> - the user
				has cancelled the upload using the cancel link<BR><CODE CLASS="western">Rejected</CODE>
				- the upload has been rejected by the server because it is
				unacceptable for some reason<BR><CODE CLASS="western">Failed</CODE>
				- an unexpected error occurred while receiving the upload<BR><BR>If
				the <CODE CLASS="western">WhenStatus</CODE> property of a
				<CODE CLASS="western">DetailsSpan</CODE> and <CODE CLASS="western">DetailsDiv</CODE>
				control is set, the control will only render when the status is
				one of the space-separated list of statuses in the <CODE CLASS="western">WhenStatus</CODE>
				value. &nbsp;If the <CODE CLASS="western">WhenStatus</CODE>
				property is not set, the control will always display.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">BytesRead</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>Number of bytes received by the server so far. &nbsp;Pass this
				to <CODE CLASS="western">FormatCount()</CODE> to get a more
				readable value.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">BytesTotal</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>Total number of bytes in the upload. &nbsp;Pass this to
				<CODE CLASS="western">FormatCount()</CODE> to get a more readable
				value. &nbsp;For chunked uploads, <CODE CLASS="western">BytesTotal</CODE>
				is -1.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">CountUnits</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>The units associated with the result of a call to
				<CODE CLASS="western">FormatCount()</CODE>. &nbsp;&nbsp;If&nbsp;<CODE CLASS="western">BytesTotal</CODE>
				is greater that 1 million, returns the value of the <CODE CLASS="western">MBUnits</CODE>
				resource. &nbsp;Otherwise, if&nbsp;<CODE CLASS="western">BytesTotal</CODE>
				is greater than 1 thousand,&nbsp;returns the value of the <CODE CLASS="western">KBUnits</CODE>
				resource. &nbsp;Otherwise, returns the value of the <CODE CLASS="western">ByteUnits</CODE>
				resource. &nbsp;Note: for chunked uploads, <CODE CLASS="western">BytesRead</CODE>
				is used instead of <CODE CLASS="western">BytesTotal</CODE>.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">FormatCount(long count)</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>Converts a number of bytes to units that would make <CODE CLASS="western">BytesTotal</CODE>
				readable. &nbsp;If <CODE CLASS="western">BytesTotal</CODE> is
				greater that 1 million,&nbsp;<CODE CLASS="western">count</CODE>
				is formatted according to the <CODE CLASS="western">MBCountFormat</CODE>
				resource. &nbsp;Otherwise, if&nbsp;<CODE CLASS="western">BytesTotal</CODE>
				greater than 1 thousand,&nbsp;<CODE CLASS="western">count</CODE>
				is formatted according to the <CODE CLASS="western">KBCountFormat</CODE>
				resource. &nbsp;Otherwise, <CODE CLASS="western">count</CODE> is
				formatted according of the <CODE CLASS="western">ByteCountFormat</CODE>
				resource. &nbsp;Note: for chunked uploads, <CODE CLASS="western">BytesRead</CODE>
				is used instead of <CODE CLASS="western">BytesTotal</CODE>.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">BytesPerSec</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>Rate (in bytes/sec) at which the server has received the
				upload. &nbsp; While the upload is in progress, this is an
				average over the past 1-2 seconds. &nbsp;When the upload has
				finished, this is an average over the entire upload.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">FormatRate(int rate)</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>Converts a rate to more readable units. &nbsp;If <CODE CLASS="western">rate</CODE>
				is greater than 1 million, it is formatted according to the
				<CODE CLASS="western">MBRateFormat</CODE> resource. &nbsp;Otherwise,
				if&nbsp;<CODE CLASS="western">rate</CODE> is greater than 1
				thousand, it is formatted according to the <CODE CLASS="western">KBRateFormat</CODE>
				resource. &nbsp;Otherwise,&nbsp;<CODE CLASS="western">rate</CODE>
				is formatted according of the <CODE CLASS="western">ByteRateFormat</CODE>
				resource.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">FractionComplete</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>A double in the range 0.0-1.0. &nbsp;Computed as
				<CODE CLASS="western">BytesRead</CODE>/<CODE CLASS="western">BytesTotal</CODE>
				for normal (ie non-chunked) uploads. &nbsp;Always 0.0 for chunked
				uploads.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">TimeElapsed</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P><CODE CLASS="western">TimeSpan</CODE> representing the time
				that has elapsed since the upload began.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">TimeRemaining</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P><CODE CLASS="western">TimeSpan</CODE> estimating the time left
				until the upload completes. &nbsp;This is projected based on the
				elapsed time and the fraction complete. &nbsp;Returns
				<CODE CLASS="western">TimeSpan</CODE>.<CODE CLASS="western">MaxValue</CODE>
				if <CODE CLASS="western">BytesRead</CODE> is 0 or if this is a
				chunked upload. 
				</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">FormatTimeSpan(TimeSpan</CODE> ts<CODE CLASS="western">)</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>Formats a <CODE CLASS="western">TimeSpan</CODE> for
				readability using the following code:</P>
				<PRE>string format;<BR>if (ts.TotalSeconds &lt; 60)<BR>&nbsp;&nbsp;format = GetResourceString(&quot;SecondsFormat&quot;);<BR>else if (ts.TotalSeconds &lt; 60*60)<BR>&nbsp;&nbsp;format = GetResourceString(&quot;MinutesFormat&quot;);<BR>else<BR>&nbsp;&nbsp;format = GetResourceString(&quot;HoursFormat&quot;);<BR>return String.Format(format,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(int)Math.Floor(ts.TotalHours),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(int)Math.Floor(ts.TotalMinutes),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ts.Seconds,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ts.TotalHours,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ts.TotalMinutes);</PRE>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">Rejection</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>An <CODE CLASS="western">UploadException</CODE> (eg
				<CODE CLASS="western">UploadTooLargeException</CODE>) when <CODE CLASS="western">Status</CODE>
				is <CODE CLASS="western">Rejected</CODE>. &nbsp;Otherwise, <CODE CLASS="western">null</CODE>.
				&nbsp;It can be useful to display <CODE CLASS="western">Rejection.Message</CODE>
				to the user when a rejection occurs. &nbsp;NeatUpload throws an
				<CODE CLASS="western">UploadTooLargeException</CODE> if the total
				request size is more than the size specified with the
				<CODE CLASS="western">maxRequestLength</CODE> attribute of the
				<CODE CLASS="western">&lt;neatUpload&gt;</CODE> element. &nbsp;The
				value of the <CODE CLASS="western">UploadTooLargeException</CODE>'s
				<CODE CLASS="western">Message</CODE> property is based on the
				<CODE CLASS="western">UploadTooLargeMessageFormat</CODE> resource
				in
				<CODE CLASS="western">NeatUpload&nbsp;</CODE><VAR>version</VAR><CODE CLASS="western">/dotnet/src/Brettle.Web.NeatUpload/NeatUpload.Strings.resx</CODE>.
				&nbsp;NeatUpload throws an <CODE CLASS="western">NonfilePortionTooLargeException</CODE>
				if the non-file portion of an upload request is more than the
				size specified with the <CODE CLASS="western">maxNormalRequestLength</CODE>
				attribute of the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
				element. &nbsp;The value of the <CODE CLASS="western">NonfilePortionTooLargeException</CODE>'s
				<CODE CLASS="western">Message</CODE> property is based on the
				<CODE CLASS="western">NonfilePortionTooLargeMessageFormat</CODE>
				resource in
				<CODE CLASS="western">NeatUpload&nbsp;</CODE><VAR>version</VAR><CODE CLASS="western">/dotnet/src/Brettle.Web.NeatUpload/NeatUpload.Strings.resx</CODE>.
								</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">Failure</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>An&nbsp;<CODE CLASS="western">Exception</CODE>&nbsp; when
				<CODE CLASS="western">Status</CODE> is <CODE CLASS="western">Failed</CODE>.
				&nbsp;Otherwise, <CODE CLASS="western">null</CODE>. &nbsp;It can
				be useful to display <CODE CLASS="western">Failure.Message</CODE>
				to the user when a failure occurs.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">CurrentFileName</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>The client-specified name of the file currently being received
				by the server. &nbsp;</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">CancelVisible</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>Whether the 'cancel' link should be visible. &nbsp;This is
				only 'true' when an upload is in progress and NeatUpload can use
				JavaScript to cancel an upload.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">StartRefreshVisible</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>Whether the 'start refresh' link should be visible. &nbsp;This
				is only 'true' when the progress display is not refreshing and
				NeatUpload can't use JavaScript to automatically start refreshing
				it when the upload starts. &nbsp;</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">StopRefreshVisible</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>Whether the 'stop refresh' link should be visible. &nbsp;This
				is only 'true' when the upload is in progress, the progress
				display is refreshing, and NeatUpload can't use Javascript to
				cancel the upload.</P>
			</TD>
		</TR>
		<TR>
			<TD WIDTH=215>
				<P><CODE CLASS="western">CancelUrl,
				StartRefreshUrl.&nbsp;StopRefreshUrl</CODE></P>
			</TD>
			<TD WIDTH=1010>
				<P>The URLs for the 'cancel', 'start refresh', and 'stop refresh'
				links, respectively.</P>
			</TD>
		</TR>
	</TBODY>
</TABLE>
<P><BR>By default, <CODE CLASS="western">ProgressPage</CODE> calls
it's <CODE CLASS="western">GetResourceString()</CODE> method to
retrieve all of it's resources. &nbsp;The default implementation uses
the embedded resources compiled from
<CODE CLASS="western">NeatUpload&nbsp;</CODE><VAR>version</VAR><CODE CLASS="western">/dotnet/src/Brettle.Web.NeatUpload/NeatUpload.Strings.resx</CODE>.
&nbsp;If you want to use a different source, override
<CODE CLASS="western">GetResourceString()</CODE> in your subclass. 
</P>
<P>For AJAX refreshless updates to work, your <CODE CLASS="western">ProgressPage</CODE>
subclass must render as a well-formed XML document. &nbsp;Here are a
few tips to avoid the most common problems:</P>
<UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Use all lowercase
	for HTML element names (ie '<CODE CLASS="western">&lt;body&gt;</CODE>'
	instead of '<CODE CLASS="western">&lt;BODY&gt;</CODE>' or '<CODE CLASS="western">&lt;Body&gt;</CODE>').
		</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">If your page
	contains HTML-specific entities replace them with their numeric
	equivalents. &nbsp;For example, replace '<CODE CLASS="western">&amp;nbsp;</CODE>'
	with '<CODE CLASS="western">&amp;#160;</CODE>'. 
	</P>
	<LI><P>Use <CODE CLASS="western">&lt;asp:HyperLink&gt;</CODE>
	instead of <CODE CLASS="western">&lt;a&gt;</CODE> for links,
	especially for links that use <CODE CLASS="western">CancelUrl</CODE>,
	<CODE CLASS="western">StartRefreshUrl</CODE>, and <CODE CLASS="western">StopRefreshUrl</CODE>.
	&nbsp;Some&nbsp;<CODE CLASS="western">HtmlAnchor</CODE>&nbsp;(i.e.
	<CODE CLASS="western">&lt;a&gt;</CODE>) implementations, notably
	Microsoft's ASP.NET 2.0, do not HTML encode the value of the <CODE CLASS="western">href</CODE>
	attribute. &nbsp;If the URLs contain ampersands, the XML will not be
	considered well-formed unless they are encoded. 
	</P>
</UL>
<P>One final note: By default,&nbsp;<CODE CLASS="western">DetailsDiv</CODE>
and <CODE CLASS="western">DetailsSpan</CODE> controls (like regular
<CODE CLASS="western">div</CODE> and <CODE CLASS="western">span</CODE>
controls) will not render as simple <CODE CLASS="western">&lt;div&gt;</CODE>
and <CODE CLASS="western">&lt;span&gt;</CODE> elements in browsers
that ASP.NET considers &quot;downlevel&quot;. &nbsp;Instead, <CODE CLASS="western">div</CODE>
controls are rendered as tables and <CODE CLASS="western">span</CODE>
controls may render with extra font tags, etc. &nbsp;The
<CODE CLASS="western">Machine.config</CODE> shipped with ASP.NET 1.1
contains a <CODE CLASS="western"><A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpgenref/html/gngrfbrowsercapssection.asp">&lt;browserCaps&gt;</A></CODE>section
that causes all non-IE browsers to be considered downlevel, including
Netscape, Firefox, Opera, Safari, etc. &nbsp;To force the <CODE CLASS="western">DetailsDiv</CODE>
and <CODE CLASS="western">DetailsSpan</CODE> controls to render as
simple <CODE CLASS="western">&lt;div&gt;</CODE> and <CODE CLASS="western">&lt;span&gt;</CODE>
elements even in supposedly downlevel browsers, set the control's
<CODE CLASS="western">UseHtml4</CODE> property to &quot;true&quot;.
&nbsp;The default <CODE CLASS="western">Progress.aspx</CODE> does
that for the <CODE CLASS="western">DetailsDiv</CODE> control with an
id of &quot;barDetailsDiv&quot; that is used to draw the gray
progress bar. &nbsp;Note that even with the <CODE CLASS="western">UseHtml4</CODE>
property it is still a good idea to <A HREF="http://slingfive.com/pages/code/browserCaps/">update
or supplement the default ASP.NET 1.1 </A><CODE CLASS="western"><A HREF="http://slingfive.com/pages/code/browserCaps/">&lt;browserCaps&gt;</A></CODE><A HREF="http://slingfive.com/pages/code/browserCaps/">section</A>
to make the rest of your web application render more cleanly in
modern non-IE browsers. 
</P>
<H2 CLASS="western"><A NAME="mozTocId184279"></A><A NAME="5.2.Creating Custom Fallback Content for ProgressBar|outline"></A>
 5.2 Creating Custom Fallback Content for <CODE CLASS="western">ProgressBar</CODE></H2>
<P>If JavaScript is not available or the browser doesn't support
IFRAMEs and the <CODE CLASS="western">ProgressBar</CODE> element is
empty, a &quot;Check Upload Progress&quot; link will be displayed. To
change the text of that link, simply place the desired text (or
controls) between the begin and end tags of the <CODE CLASS="western">ProgressBar</CODE>
element. For example: 
</P>
<PRE STYLE="margin-bottom: 0.2in">&lt;Upload:ProgressBar id=&quot;progressBar&quot; runat=&quot;server&quot; &gt;<BR>&nbsp;&nbsp;&lt;asp:Label id=&quot;label&quot; runat=&quot;server&quot; Text=&quot;Your Text Here&quot;/&gt;<BR>&lt;/Upload:ProgressBar&gt;</PRE><H2 CLASS="western">
<A NAME="5.3.Advanced Progress Bar Customization|outline"></A> 5.3 Advanced
Progress Bar Customization</H2>
<P>NeatUpload's <CODE CLASS="western">ProgressBar</CODE> (and the
<CODE CLASS="western">GreyBoxProgressBar</CODE> extension) are both
subclasses of NeatUpload's abstract <CODE CLASS="western">ProgressBarBase</CODE>
class.  <CODE CLASS="western">ProgressBarBase</CODE> provides all of
the functionality of the progress bar including detecting postbacks
initiated by registered triggers, displaying the progress bar in a
pop-up window, and displaying fallback content when scripting is not
available.  The <CODE CLASS="western">ProgressBar</CODE> control adds
an <CODE CLASS="western">Inline</CODE> property that displays the
progress bar inline using an IFRAME if the browser supports it. 
<CODE CLASS="western">GreyBoxProgressBar</CODE> displays the popup
using GreyBox instead of <CODE CLASS="western">window.open()</CODE>. 
You can create your own subclass of <CODE CLASS="western">ProgressBarBase</CODE>
to change the way that the progress bar is displayed.  Refer to the
source code of <CODE CLASS="western">GreyBoxProgressBar</CODE> for an
example of how to do that.  The key is to override <CODE CLASS="western">GetStartupScript()</CODE>
to return the base startup script followed by your own script.  The
base startup script will create the <CODE CLASS="western">NeatUploadPB</CODE>
script object associated with your control.  You can access the
created object using <CODE CLASS="western">NeatUploadPB.prototype.Bars['</CODE><EM>progressBarID</EM><CODE CLASS="western">']
</CODE>where <EM>progressBarID</EM> is the <CODE CLASS="western">ClientID</CODE>
property of your control.  Once you have that object, you can modify
it's behavior by replacing any of the following:</P>
<UL>
	<LI><P><CODE CLASS="western">Display()</CODE> - NeatUpload calls
	<CODE CLASS="western">Display()</CODE> with no parameters when the
	progress bar should be displayed.  The default implementation calls
	<CODE CLASS="western">DisplayUrl(progressUrl)</CODE> which is
	described below.  You might want to override the <CODE CLASS="western">Display()</CODE>
	method to show a hidden progress bar before calling <CODE CLASS="western">DisplayUrl()</CODE>.
	 You could also override it to create an entirely different progress
	display.  For example,
	<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/Brettle.Web.NeatUpload/tests/StaticPage.htm
	</CODE>overrides it to update an inline progress display that is not
	in an IFRAME using the JavaScript Object Notation (JSON) upload
	state object retrieved from
	<CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/NeatUpload/ProgressJsonHandler.ashx</CODE>.</P>
	<LI><P><CODE CLASS="western">DisplayUrl(progressUrl)</CODE> – The
	default implementation of <CODE CLASS="western">Display()</CODE>
	calls <CODE CLASS="western">DisplayUrl(progressUrl)</CODE> to start
	the progress display.   The <CODE CLASS="western">progressUrl</CODE>
	parameter is the URL of the progress page (e.g. Progress.aspx) with
	the required query string.  The default <CODE CLASS="western">DisplayUrl()</CODE>
	passes <CODE CLASS="western">progressUrl</CODE> to <CODE CLASS="western">window.open()</CODE>
	to start the progress display in a popup window.  You might want to
	override <CODE CLASS="western">DisplayUrl()</CODE> to display the
	progress information in some other way.</P>
	<LI><P><CODE CLASS="western">EvalOnClose</CODE> – <CODE CLASS="western">ProgressPage</CODE>
	subclasses (e.g. <CODE CLASS="western">Progress.aspx</CODE>) define
	a <CODE CLASS="western">NeatUploadClose()</CODE> function which is
	responsible for closing the progress display created by
	<CODE CLASS="western">DisplayUrl()</CODE>.  <CODE CLASS="western">ProgressPage</CODE>
	ensure that <CODE CLASS="western">NeatUploadClose()</CODE> is called
	when the upload completes or is canceled.  Your subclass can call
	<CODE CLASS="western">NeatUploadClose()</CODE> at other times (e.g.
	when an upload is rejected).  The default <CODE CLASS="western">NeatUploadClose()</CODE>
	implementation attempts to access
	<CODE CLASS="western">NeatUploadPB.prototype.Bars['</CODE><EM>progressBarID</EM><CODE CLASS="western">'].EvalOnClose
	</CODE>within the window object that started the display.  If the
	upload did not complete (e.g. it was canceled), <CODE CLASS="western">NeatUploadClose()</CODE>
	will be able to access the <CODE CLASS="western">EvalOnClose</CODE>
	string and will pass it to JavaScript's <CODE CLASS="western">eval</CODE>
	function in the window or frame that displays the progress page
	(e.g. <CODE CLASS="western">Progress.aspx</CODE>).  You might set
	<CODE CLASS="western">EvalOnClose</CODE> to some code that hides the
	progress bar that you display in <CODE CLASS="western">DisplayUrl()</CODE>.
	 You can access the window object that started the display using the
	<CODE CLASS="western">NeatUploadMainWindow</CODE> variable.  If the
	upload completed and the uploading page has already been replaced
	(or is being replaced) by the response from the server, then
	<CODE CLASS="western">NeatUploadClose()</CODE> won't be able to
	access <CODE CLASS="western">EvalOnClose</CODE> and will be unable
	to execute that code.  In that case, <CODE CLASS="western">NeatUploadClose()</CODE>
	will call <CODE CLASS="western">window.close()</CODE> so that the
	progress display will be closed if it is displayed in a separate
	top-level window.  Note that if the progress display was embedded in
	the upload page, it would have been effectively closed when the
	upload page was replaced, so <CODE CLASS="western">NeatUploadClose()</CODE>
	ignores that case.  If you want different behavior from
	<CODE CLASS="western">NeatUploadClose()</CODE>, you can redefine it
	in your <CODE CLASS="western">ProgressPage</CODE> subclass (e.g. in
	a custom <CODE CLASS="western">Progress.aspx</CODE>).</P>
</UL>
<H2 CLASS="western"><A NAME="0.1.1.Customizing the MultiFile Button|outline"></A><A NAME="5.4.Customizing the MultiFile Button|outline"></A>
 5.4 Customizing the MultiFile Button</H2>
<P>By default, the <CODE CLASS="western">MultiFile</CODE> control
renders as a “Pick Files...” button that displays a file
selection dialog when clicked.  You can replace that button with a
different button, a link, or any other HTML you want by putting the
desired content inside the <CODE CLASS="western">MultiFile</CODE>
element on your page.  Note that whatever content you place in the
<CODE CLASS="western">MultiFile</CODE> element is for display
purposes only.  The user won't actually interact with any of that
content.  If the user attempts to click anywhere on your content, the
file selection dialog will be displayed.  For example, the following:</P>
<PRE>&lt;Upload:MultiFile runat=”server”&gt;<BR>&nbsp;&nbsp;&lt;a href=”<A HREF="http://www.google.com/">http://www.</A>brettle.com/neatupload”&gt;Select Files...&lt;/a&gt;<BR>&lt;/Upload:MultiFile&gt;</PRE><P>
will display a “Select Files...” link instead of the “Pick
Files...” button, but clicking on the link will display the file
selection dialog instead of loading the NeatUpload home page.</P>
<H2 CLASS="western"><A NAME="0.1.1.Customizing MultiFile's Handling of Queued Files|outline"></A><A NAME="5.5.Customizing MultiFile's Handling of Queued Files|outline"></A>
 5.5 Customizing MultiFile's Handling of Queued Files</H2>
<P>By default, NeatUpload's <CODE CLASS="western">MultiFile</CODE>
displays queued files (i.e. files that have been selected but not yet
uploaded) as a vertical list above the “Pick Files...” button,
with each name preceded by an “X” which the user can click to
delete the file.  To display the list someplace else, simply set
MultiFile's <CODE CLASS="western">FileQueueControlID</CODE> property
to the ID of the element (e.g. a &lt;div&gt;) that should contain the
list.  To display the list in some other format, replace the
<CODE CLASS="western">OnFileQueued()</CODE> method of the
<CODE CLASS="western">NeatUploadMultiFile</CODE> script object that
NeatUpload creates for your control.  You can access that object
using <CODE CLASS="western">NeatUploadMultiFile.prototype.Controls['multiFileID']
</CODE>where <EM>multiFileID</EM> is the <CODE CLASS="western">ClientID</CODE>
property of your control.  The <CODE CLASS="western">OnFileQueued()</CODE>
method takes one argument: a file object that contains a <CODE CLASS="western">name</CODE>
property which your <CODE CLASS="western">OnFileQueued()</CODE>
method should display and a <CODE CLASS="western">Delete()</CODE>
method which your <CODE CLASS="western">OnFileQueued()</CODE> method
should arrange to call when the user deletes the file from the queue.
 For an example, see the default implementation of <CODE CLASS="western">OnFileQueued()</CODE>
in <CODE CLASS="western">NeatUpload-</CODE><EM>version</EM><CODE CLASS="western">/js/NeatUpload.js</CODE>.</P>
<P>The file object passed to <CODE CLASS="western">OnFileQueued()</CODE>
also has a size property.  If the file was selected using Flash, that
property will contain the size of the file in bytes.  Otherwise, it
will contain -1.  You could use that property to warn the user and
immediately call <CODE CLASS="western">Delete()</CODE> for any files
which are larger than you want.</P>
<H2 CLASS="western"><A NAME="5.6.Creating a Custom UploadStorageProvider|outline"></A>
 5.6 Creating a Custom UploadStorageProvider</H2>
<P>By default, NeatUpload uses the built-in
<CODE CLASS="western">FilesystemUploadStorageProvider</CODE> which
streams uploaded files to a temporary directory until you move them.
&nbsp;If you would rather stream uploaded files to some other
location (e.g. a database, or remote machine), or you want some other
functionality not provided by&nbsp;<CODE CLASS="western">FilesystemUploadStorageProvider,</CODE>
you need to create and use a custom <CODE CLASS="western">UploadStorageProvider</CODE>.
&nbsp;To create a custom <CODE CLASS="western">UploadStorageProvider</CODE>,
create a class which inherits from <CODE CLASS="western">UploadStorageProvider</CODE>.
&nbsp;You will need to implement the following methods:</P>
<PRE>public abstract void Initialize(string name, NameValueCollection attrs);<BR>public virtual UploadedFile CreateUploadedFile(UploadContext ctx, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string controlUniqueID, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string fileName,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string contentType,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UploadStorageConfig storageConfig);</PRE><P>
When the configuration section where your provider is added is first
relevant to a request, NeatUpload creates an instance of your
provider and calls it's <CODE CLASS="western">Initialize()</CODE>
method, &nbsp;passing the value of the &quot;name&quot; attribute as
the first parameter and the remaining attributes (other than &quot;name&quot;,
and &quot;type&quot;) as the second parameter. &nbsp;You can use the
remaining attributes to pass provider-specific configuration
information to your provider.<BR><BR>Whenever NeatUpload encounters a
file upload associated with a <CODE CLASS="western">MultiFile</CODE>
or <CODE CLASS="western">InputFile</CODE> control, it calls the
second <CODE CLASS="western">CreateUploadedFile()</CODE> method of
the provider that is configured as the <CODE CLASS="western">defaultProvider</CODE>
for the requested page. &nbsp;When NeatUpload calls your provider's
<CODE CLASS="western">CreateUploadedFile()</CODE> method, it passes
the <CODE CLASS="western">UploadContext</CODE> associated with the
current request, the ID of the <CODE CLASS="western">MultiFile</CODE>
or <CODE CLASS="western">InputFile</CODE> control associated with the
upload, the browser-specified name and MIME type of the file, and the
value of the control's <CODE CLASS="western">StorageConfig</CODE>
property. &nbsp;<CODE CLASS="western">CreateUploadedFile()</CODE> is
responsible for returning an instance of a class derived from
<CODE CLASS="western">UploadedFile</CODE>. &nbsp;NeatUpload will
stream the file to that object.  Various <CODE CLASS="western">InputFile</CODE>
members delegate to the associated methods of your
<CODE CLASS="western">UploadedFile</CODE>-derived object.  The
<CODE CLASS="western">MultiFile</CODE> control has a <CODE CLASS="western">Files</CODE>
property that returns an array of your <CODE CLASS="western">UploadedFile</CODE>-derived
objects directly.<BR><BR>Your provider's <CODE CLASS="western">CreateUploadedFile()</CODE>
can optionally use the <CODE CLASS="western">ContentLength</CODE>
property of the passed <CODE CLASS="western">UploadContext</CODE> to
get the length of the entire request, including all files. &nbsp;That
information could be used to reserve sufficient space to store the
files, for example. &nbsp;At the moment, no members of <CODE CLASS="western">UploadContext</CODE>
other than <CODE CLASS="western">ContentLength</CODE> are available
to providers. &nbsp;Future releases of NeatUpload might use
UploadContext to pass other similar information to providers.<BR><BR>Your
provider can &quot;reject&quot; an upload at any time (eg based on
MIME type, size, or content), by throwing an exception derived from
<CODE CLASS="western">UploadException</CODE>. &nbsp;When NeatUpload
detects such an exception, it:</P>
<OL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">updates the
	progress bar to indicate that the upload was rejected (i.e. sets
	<CODE CLASS="western">Status</CODE> to <CODE CLASS="western">Rejected</CODE>
	and <CODE CLASS="western">Rejection</CODE> to the <CODE CLASS="western">UploadException</CODE>
	that occured) 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">if the progress
	bar is in a pop-up window, leaves the pop-up open so that the user
	can see the message 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">asks the browser
	to stop the upload using javascript to simulate clicking the
	browser's Stop button 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">waits 5 seconds
	to give the browser and opportunity to stop the upload 
	</P>
	<LI><P>rethrows the exception 
	</P>
</OL>
<P>NeatUpload has no way of knowing for sure whether the browser
stopped the upload, so it always rethrows the exception. &nbsp;If the
browser did stop the upload, it will ignore any response that the
application generates because of the error. &nbsp;If the browser
didn't stop the upload, it will display the response that the
application generates. &nbsp;You can customize that response by
handling the <CODE CLASS="western">Application.Error</CODE> event or
by using custom error pages. NeatUpload responds to &nbsp;<CODE CLASS="western">UploadException</CODE>s
by throwing an <CODE CLASS="western">HttpException</CODE> with the
same HTTP error code and the <CODE CLASS="western">UploadException</CODE>
as the <CODE CLASS="western">InnerException</CODE>. This allows you
to control which custom error page is used by specifying the
corresponding HTTP error code when you construct your
<CODE CLASS="western">UploadException</CODE>.<BR><BR>When NeatUpload
detects an exception that is <I>not</I> derived from <CODE CLASS="western">UploadException</CODE>,
it assumes that it is an unexpected error, so it:</P>
<OL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">updates the
	progress bar to indicate that an error occurred&nbsp;(i.e. sets
	<CODE CLASS="western">Status</CODE> to <CODE CLASS="western">Failed</CODE>
	and <CODE CLASS="western">Failure</CODE> to the&nbsp;<CODE CLASS="western">Exception</CODE>
	that occured) 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">if the progress
	bar is in a pop-up window, leaves the pop-up open so that the user
	can see the message 
	</P>
	<LI><P>rethrows the exception 
	</P>
</OL>
<P>ASP.NET will handled the exception the same way any other
exception is handled. &nbsp;It will fire the <CODE CLASS="western">Application.Error</CODE>
event and use custom error pages if they are configured.<BR><BR>If
the <CODE CLASS="western">NameValueCollection</CODE> provided by
<CODE CLASS="western">UploadStorageConfig</CODE> is not sufficient
for your provider, you can override
<CODE CLASS="western">UploadStorageProvider.CreateUploadStorageConfig()</CODE>
to return your own <CODE CLASS="western">UploadStorageConfig</CODE>
subclass. &nbsp;Your subclass can override the
<CODE CLASS="western">UploadStorageConfig.Serialize(Stream)</CODE>
and <CODE CLASS="western">UploadStorageConfig.Deserialize(Stream)</CODE>
methods to serialize itself to the provided <CODE CLASS="western">Stream</CODE>
and deserialize itself from the provided <CODE CLASS="western">Stream</CODE>.
&nbsp;The base class implementations of these methods use
<CODE CLASS="western"><A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfSystemWebUILosFormatterClassTopic.asp">LosFormatter</A></CODE>to
provide a concise serialization of the <CODE CLASS="western">NameValueCollection</CODE>
as a <CODE CLASS="western">Hashtable</CODE>.<BR><BR>For an example of
how to implement a custom <CODE CLASS="western">UploadStorageProvider</CODE>,
see <CODE CLASS="western">FilesystemUploadStorageProvider.cs</CODE>
and <CODE CLASS="western">FilesystemUploadedFile.cs</CODE>. &nbsp;
For another example, see the files in the <CODE CLASS="western">HashedInputFile</CODE>
directory.</P>
<H2 CLASS="western"><A NAME="5.7.Creating a Custom UploadStateStoreProvider|outline"></A>
 5.7 Creating a Custom UploadStateStoreProvider</H2>
<P>By default, NeatUpload uses the built-in
<CODE CLASS="western">AdaptiveUploadStateStoreProvider</CODE> which
maintains the state of uploads in the user's session so that it can
be shared across a web garden or web farm if it determines that the
session state mode is something other than Off or InProc.  Otherwise,
it maintains the state of uploads in application state.  You can
force NeatUpload to maintain upload state in application state or the
user's session by configuring NeatUpload to use the
<CODE CLASS="western">InProcUploadStateStoreProvider</CODE> or
<CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>,
respectively.  
</P>
<P>In addition, you can create your own <CODE CLASS="western">UploadStateStoreProvider</CODE>
subclass which maintains upload state differently.  You will need to
implement the following methods:</P>
<PRE>public abstract void Initialize(string name, NameValueCollection attrs);<BR>public abstract UploadState Load(string postBackID); 
public abstract void MergeAndSave(UploadState uploadState); 
protected virtual void Delete(string postBackID); </PRE>
<UL>
	<P>When the configuration section where your provider is added is
	first relevant to a request, NeatUpload creates an instance of your
	provider and calls it's <CODE CLASS="western">Initialize()</CODE>
	method, &nbsp;passing the value of the &quot;name&quot; attribute as
	the first parameter and the remaining attributes (other than &quot;name&quot;,
	and &quot;type&quot;) as the second parameter. &nbsp;You can use the
	remaining attributes to pass provider-specific configuration
	information to your provider.  
	</P>
	<LI><P>When NeatUpload needs the <CODE CLASS="western">UploadState</CODE>
	object associated with a particular post-back ID, it will call the
	<CODE CLASS="western">Load()</CODE> method which must return either
	the <CODE CLASS="western">UploadState</CODE> object, or null if the
	post-back ID is not known.  
	</P>
	<LI><P>When NeatUpload needs to update the <CODE CLASS="western">UploadState</CODE>,
	it will call the <CODE CLASS="western">MergeAndSave()</CODE> method.
	 That method must atomically merge the passed <CODE CLASS="western">UploadState</CODE>
	object with the stored <CODE CLASS="western">UploadState</CODE>
	object and replace the stored <CODE CLASS="western">UploadState</CODE>
	object with the merged result.  The static
	<CODE CLASS="western">UploadStateStoreProvider.Merge()</CODE> helper
	method can do the actual merging once your provider has both
	<CODE CLASS="western">UploadState</CODE> objects.  
	</P>
	<LI><P>When NeatUpload determines that an <CODE CLASS="western">UploadState</CODE>
	object is stale, it will call the <CODE CLASS="western">Delete()</CODE>
	method which must delete the <CODE CLASS="western">UploadState</CODE>
	object from the state store.  <CODE CLASS="western">Delete()</CODE>
	is called from the protected <CODE CLASS="western">CleanUpIfStale()</CODE>
	method.  <CODE CLASS="western">CleanUpIfStale()</CODE> calls <CODE CLASS="western">Load()</CODE>
	to retrieve the <CODE CLASS="western">UploadState</CODE> object from
	the store, and then calls <CODE CLASS="western">Delete()</CODE> if
	it is stale.  By default, the <CODE CLASS="western">CleanUpIfStale()</CODE>
	method runs on a thread which does not have any <CODE CLASS="western">HttpContext</CODE>.
	 So, if your <CODE CLASS="western">Load()</CODE> or <CODE CLASS="western">Delete()</CODE>
	implementations require an <CODE CLASS="western">HttpContext</CODE>,
	you will need to implement:</P>
</UL>
<PRE>public virtual CleanUpIfStaleCallback GetCleanUpIfStaleCallback();</PRE>
<UL>
	<LI VALUE=1><P>to return a method that calls <CODE CLASS="western">CleanUpIfStale()</CODE>
	in an a suitable environment.  For example,
	<CODE CLASS="western">InProcUploadStateStoreProvider.GetCleanUpIfStaleCallback()</CODE>
	saves a reference to the <CODE CLASS="western">HttpApplicationState</CODE>
	object and returns a method that makes it available to the provider
	(via a <CODE CLASS="western">ThreadStatic</CODE> field) when the
	returned method calls <CODE CLASS="western">CleanUpIfStale()</CODE>.</P>
</UL>
<P>For an example of how to implement a custom
<CODE CLASS="western">UploadStateStoreProvider</CODE>, see
<CODE CLASS="western">InProcUploadStateProvider.cs</CODE> and
<CODE CLASS="western">SessionBasedUploadStateStoreProvider.cs</CODE>.
</P>
<H2 CLASS="western"><A NAME="5.8.Handling Non-absolute Paths in IE6|outline"></A>
 5.8 Handling Non-absolute Paths in IE6</H2>
<P>If instead of selecting a file to upload via the file selection
dialog, an IE6 user types in a non-absolute path (e.g. just &quot;x&quot;),
IE6 will not submit the form, no upload will occur, and NeatUpload
will not start the progress display. &nbsp;Unfortunately, this means
that the user gets no feedback to indicate what the problem is. &nbsp;If
you want to provide feedback, NeatUpload provides a hook for that
purpose. &nbsp;When NeatUpload detects this situation, it checks to
see if a JavaScript function named NeatUpload_HandleIE6InvalidPath()
exists. &nbsp; If it exists, NeatUpload calls that function, passing
it the input file form element that contains the non-absolute path.
&nbsp;NeatUpload does not provide an implementation of that function
by default, but you can provide your own implementation. &nbsp;For
example, your implementation might display &quot;Invalid path&quot;
next to the input file form element so that the user knows what the
problem is. 
</P>
<P>Since users almost always use the file selection dialog, this
issue almost never arises.</P>
<H1><A NAME="SqlServerInputFile"></A><A NAME="6.Extensions|outline"></A>
 6 Extensions</H1>
<H2 CLASS="western"><A NAME="6.1.The SqlServerInputFile Extension|outline"></A>
 6.1 The SqlServerInputFile Extension</H2>
<P>SqlServerInputFile is a NeatUpload extension generously
contributed by Joakim Wennergren (jokedst at gmail dot com). It
streams uploaded files to and from an SQL Server database and
consists of the <CODE CLASS="western">SqlServerInputFile</CODE> web
control&nbsp;and a custom <CODE CLASS="western">UploadStorageProvider</CODE>
called <CODE CLASS="western">SqlServerUploadStorageProvider</CODE>. 
</P>
<H3 CLASS="western"><A NAME="SqlServerInputFileInstall"></A><A NAME="6.1.1.Installation|outline"></A>
 6.1.1 Installation</H3>
<P STYLE="margin-top: 0in; margin-bottom: 0in">To install
<CODE CLASS="western">SqlServerInputFile</CODE>:</P>
<P STYLE="margin-left: 0.42in"><U>If you will be using the Visual
Studio Web Form Designer</U>, add the <CODE CLASS="western">SqlServerInputFile</CODE>
control to your toolbox. &nbsp;To do that, right-click on the
Toolbox, click Add/Remove Items, Browse to&nbsp;
<CODE CLASS="western">NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/bin/Hitone.Web.SqlServerUploader.dll</CODE>,
click Open, and then click OK. &nbsp;A reference to
<CODE CLASS="western">Hitone.Web.SqlServerUploader.dll</CODE> will
automatically be added to your project the first time you use the
designer to a SqlServerInputFile to a form.<BR><U>If you won't be
using the Visual Studio Web Form Designer</U>, add a reference to
your web application that refers to the
<CODE CLASS="western">Hitone.Web.SqlServerUploader.dll</CODE> in the
<CODE CLASS="western">NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/bin/</CODE>
directory.</P>
<H3 CLASS="western"><A NAME="SqlServerInputFileConfigure"></A><A NAME="6.1.2.Configuration|outline"></A>
 6.1.2 Configuration</H3>
<P>To configure your application to use the
<CODE CLASS="western">SqlServerUploadStorageProvider</CODE>, add the
following to your <CODE CLASS="western">Web.config</CODE>:</P>
<PRE>&lt;configuration&gt;<BR>&nbsp;&nbsp;&lt;configSections&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;section name=&quot;neatUpload&quot; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;Brettle.Web.NeatUpload.ConfigSectionHandler, Brettle.Web.NeatUpload&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowLocation=&quot;true&quot; /&gt;<BR>&nbsp;&nbsp;&lt;/configSections&gt;<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;neatUpload ... defaultStorageProvider=&quot;SqlServerUploadStorageProvider&quot;&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name=&quot;SqlServerUploadStorageProvider&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;<FONT FACE="Nimbus Mono L, monospace">Hitone</FONT><FONT FACE="Nimbus Mono L, monospace">.Web.SqlServerUploader.SqlServerUploadStorageProvider, Hitone.Web.SqlServerUploader&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>connectionString=&quot;<VAR>connection string,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;required unless using connectionName to identify named connection</VAR>&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<VAR>options identifying stored procs or table/column names (required)</VAR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hashAlgorithm=&quot;<VAR>optional name of hash algorithm supported by .NET (e.g. MD5, SHA1, etc),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaults to no hash</VAR>&quot;/&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/providers&gt;<BR>&nbsp;&nbsp;&lt;/neatUpload&gt;<BR>&nbsp;&nbsp;...<BR>&lt;/configuration&gt;</PRE><P>
The <CODE CLASS="western">SqlServerUploadStorageProvider</CODE> can
either generate SQL itself or use stored procedures on the database
server for all tasks. This is controlled by the attributes you
specify when you add the provider to your <CODE CLASS="western">Web.config</CODE>.
When the provider needs to do something, it first checks to see if
you have specified a stored procedure to do it using one of the
following attributes: 
</P>
<UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">createProcedure</CODE>
	- Procedure that takes @FileName and @MIMEType (both varchars) input
	parameters, and sets @Identity (Numeric) and @Pointer (Binary(16))
	output parameters. The @Identity and @Pointer values that are
	returned will be passed to the <CODE CLASS="western">writeProcedure</CODE>
	as the file is received. The @Identity value will also be passed to
	the <CODE CLASS="western">deleteProcedure</CODE>, <CODE CLASS="western">cleanupProcedure</CODE>,
	<CODE CLASS="western">renameProcedure</CODE>, and
	<CODE CLASS="western">storeHashProcedure</CODE>. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">writeProcedure</CODE>
	- Procedure that takes @Identity (Numeric), @Pointer (Binary(16)),
	@Offset (Int), @Delete (Int), and @Bytes (varbinary) input
	parameters. It should replace the @Delete bytes at position @Offset
	in the file identified by @Identity and @Pointer with the bytes in
	@Bytes. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">cleanupProcedure</CODE>
	- The provider calls this procedure with @Identity (Numeric) when an
	upload is no longer in progress and it will not call <CODE CLASS="western">writeProcedure</CODE>
	anymore. Note that this procedure is called even if the upload did
	not complete successfully for some reason. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">storeHashProcedure</CODE>
	- If the <CODE CLASS="western">hashAlgorithm</CODE> attribute is
	set, the provider calls this procedure with @Identity (Numeric) and
	@Hash (varchar). @Hash is the hash value computed for the file
	identified by @Identity. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">renameProcedure</CODE>
	- The provider calls this procedure with @Identity (Numeric) and
	@FileName (varchar) to indicate that the application has requested
	that the name of the file identified by @Identity be changed to
	@FileName. This happens when you call <EM>inputFileId</EM><CODE CLASS="western">.MoveTo()</CODE>.
		</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">deleteProcedure</CODE>
	- Procedure that takes @Identity (Numeric) input parameter and
	deletes the specified file. This is called at the end of the request
	if your application called neither <EM>inputFileId</EM><CODE CLASS="western">.MoveTo()
	nor </CODE><EM>inputFileId</EM><CODE CLASS="western">.Verify()</CODE></P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">openProcedure</CODE>
	- This procedure is called if you use <EM>inputFileId</EM><CODE CLASS="western">.FileContent</CODE>
	to access the uploaded file as a stream. It takes an @Identity
	(Numeric) input parameter, and sets @Pointer (Binary(16)), @FileName
	(varchar), and @MIMEType (varchar) output parameters. The @Pointer
	value that is returned will be passed to the <CODE CLASS="western">readProcedure</CODE>
	as content is read from the stream. 
	</P>
	<LI><P><CODE CLASS="western">readProcedure</CODE> - This procedure
	is called if you use <EM>inputFileId</EM><CODE CLASS="western">.FileContent</CODE>
	to access the uploaded file as a stream. It takes @Identity
	(Numeric), @Pointer (Binary(16)), @Offset (Int), and @Size (Int)
	input parameters and returns the @Size bytes starting at position
	@Offset in the file identified by @Identity and @Pointer. 
	</P>
</UL>
<P>If you don't provide a stored procedure for what the provider
needs to do, it will generate the SQL to do it. When generating SQL
queries, the provider uses the values you specify with the following
attributes: 
</P>
<UL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">tableName</CODE>
	- Name of the table to contain the files. &quot;FileTable&quot; in
	the example below. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">dataColumnName</CODE>
	- Name of an image/varbinary column for the contents of the uploaded
	file. &quot;DataField&quot; in the example below. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">partialFlagColumnName</CODE>
	- Name of a tinyint column that the provider will set to 1 while the
	upload is being received and set to 0 when the upload is complete.
	&quot;Partial&quot; in the example below. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">fileNameColumnName</CODE>
	- Name of a nvarchar column for the name of the uploaded file. While
	the upload is being received, the provider will set the column to
	the name (excluding path provided by the browser). If you call
	<EM>inputFileId</EM>.MoveTo(), the new name will be stored in this
	column. &quot;FileName&quot; in the example below. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in"><CODE CLASS="western">mimeTypeColumnName</CODE>
	- Name of a nvarchar column for the browser-provided MIME content
	type of the file &quot;MimeType&quot; in the example below. 
	</P>
	<LI><P><CODE CLASS="western">hashColumnName</CODE> - Name of a
	nvarchar column for the hash of the file contents (as a hex string).
	&quot;FileHash&quot; in the example below. 
	</P>
</UL>
<P>To generate SQL queries, the provider only requires <CODE CLASS="western">tableName</CODE>
and <CODE CLASS="western">dataColumnName</CODE>. The remaining
attributes are optional. 
</P>
<P><STRONG>Note: The generated SQL will not work with SQL Server 2000</STRONG>
because it requires the &quot;$IDENTITY&quot; object to reference the
IDENTITY column of the table. An <CODE CLASS="western">identityColumnName</CODE>
attribute might be added in a future release. Until then, SQL Server
2000 users will need to use stored procedures to workaround around
this limitation. 
</P>
<H3 CLASS="western"><A NAME="SqlServerInputFileUse"></A><A NAME="6.1.3.Usage|outline"></A>
 6.1.3 Usage</H3>
<P>To add the <CODE CLASS="western">SqlServerInputFile</CODE> to your
forms:</P>
<OL>
	<LI><P><U>If you are using Visual Studio Web Form Designer</U>,
	simply drag the <CODE CLASS="western">SqlServerInputFile</CODE>
	control from your Toolbox and drop it on the form.<BR><U>If you are
	not using Visual Studio Web Form Designer</U>, add the following
	line at the top of your form:</P>
	<PRE STYLE="margin-bottom: 0.2in"><FONT FACE="Nimbus Mono L, monospace">&lt;%@ Register TagPrefix=&quot;SqlUpload&quot; Namespace=&quot;Hitone.Web.SqlServerUploader&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assembly=&quot;Hitone.Web.SqlServerUploader&quot;%&gt;</FONT></PRE><P>
	and add an&nbsp;<CODE CLASS="western">SqlServerInputFile</CODE>
	control to your aspx page wherever you want the user to choose a
	file, using something like this: 
	</P>
	<PRE STYLE="margin-bottom: 0.2in">&lt;SqlUpload:SqlServerInputFile id=&quot;<VAR>inputFileId</VAR>&quot; runat=&quot;server&quot; /&gt;</PRE>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Set any
	properties that you would normally set on an <CODE CLASS="western">InputFile
	or HtmlInputFile</CODE> control. 
	</P>
	<LI><P>In your code-behind class, you can use the methods properties
	you would normally use on an <CODE CLASS="western">InputFile</CODE>
	object. In addition, <CODE CLASS="western">SqlServerInputFile</CODE>
	offers a <CODE CLASS="western">Verify()</CODE> method that tells the
	<CODE CLASS="western">SqlServerUploadStorageProvider</CODE> not to
	delete the uploaded file at the end of the request. <CODE CLASS="western">Verify()</CODE>
	is equivalent to calling <EM>inputFileId</EM><CODE CLASS="western">.MoveTo(</CODE><EM>inputFileId</EM><CODE CLASS="western">.FileName,
	MoveToOptions.Overwrite)</CODE> but doesn't cause the extra database
	update. <CODE CLASS="western">SqlServerInputFile</CODE> also adds
	<CODE CLASS="western">Hash</CODE>, <CODE CLASS="western">HashSize</CODE>,
	and <CODE CLASS="western">HashAlgorithm</CODE> properties which
	return information about the cryptographic hash (if any) computed
	for the uploaded file.</P>
</OL>
<H3 CLASS="western"><A NAME="SqlServerInputFileExample"></A><A NAME="6.1.4.Example|outline"></A>
 6.1.4 Example</H3>
<P>There is a demo at
<CODE CLASS="western">NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/Extensions/Hitone.Web.SqlServerUploader/DBWrite.aspx</CODE>.
Before using it for the first time, you need to: 
</P>
<OL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Create a database
	named &quot;FileStorageTest&quot; on an SQL Server. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Create the table
	and stored procedures by running the query below corresponding to
	your version of SQL Server. 
	</P>
	<LI><P>If necessary, change the connection strings in
	<CODE CLASS="western">NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/Extensions/Hitone.Web.SqlServerUploader/Web.config</CODE>
	to point to your database. For example, if you are using SQL Server
	Express on your local machine, you'll need to change <CODE CLASS="western">&quot;Server=.;&quot;</CODE>
	to <CODE CLASS="western">&quot;Server=.</CODE><CODE CLASS="western"><FONT FACE="Nimbus Sans L, sans-serif">\</FONT></CODE><CODE CLASS="western">
	SQLEXPRESS;&quot;</CODE> in several places.</P>
</OL>
<H4 CLASS="western"><A NAME="6.1.4.1.Example Setup Query for SQL Server 2005|outline"></A>
 6.1.4.1 Example Setup Query for SQL Server 2005</H4>
<PRE>CREATE TABLE [FileTable] (
        [Id] [int] IDENTITY (1, 1) PRIMARY KEY NOT NULL ,
        [FileName] [nvarchar] (50) NULL,
        [DataField] [varbinary] (max) NOT NULL ,
        [Partial] [tinyint] NOT NULL ,
        [MimeType] [nvarchar] (50) NULL ,
        [Created] [datetime] NOT NULL CONSTRAINT [DF_FileTable_Created] DEFAULT (getdate()),
        [FileHash] [nvarchar] (50) NULL ,
)
GO

CREATE Procedure CreateBlob
        @Identity Numeric Output,
        @Pointer Binary(16) Output,
        @FileName VarChar(250) = null,
        @MIMEType VarChar(250) = null
As Begin Set NoCount ON;
        Insert Into FileTable (Datafield,FileName,MimeType,Partial) Values (0x,@FileName,@MimeType,1)
        Select @Identity = SCOPE_IDENTITY()
        Select @Pointer = DataField From FileTable Where $IDENTITY = @Identity
End

Go

CREATE Procedure OpenBlob
        @Identity Numeric,
        @Pointer VarBinary(max) Output,
        @Size Int Output,
        @FileName VarChar(250) Output,
        @MIMEType VarChar(250) Output
As Begin Set NoCount On
        Select  @Pointer = 0x, -- Because @pointer is not used
                        @Size = DATALENGTH(DataField),
                        @FileName = [FileName],
                        @MIMEType = MIMEType
        From FileTable Where $IDENTITY = @Identity
End

Go

CREATE Procedure ReadBlob
        @Identity Numeric, --ignored in this implementation, here for reference
        @Pointer Binary(16),
        @Offset Int,
        @Size Int
As Begin Set NoCount On
        SELECT SUBSTRING(DataField, @Offset+1, @Size) FROM FileTable WHERE ($IDENTITY = @Identity)
End

Go

CREATE Procedure WriteBlob
        @Identity Numeric, --ignored in this implementation, here for reference
        @Pointer Binary(16),
        @Bytes VarBinary(max),
        @Offset Int,
        @Delete Int
As Begin Set NoCount On
        UPDATE FileTable SET DataField.write(@Bytes, null, null) WHERE $IDENTITY = @Identity
End

Go

CREATE Procedure CleanUpBlob
        @Identity Numeric
As Begin Set NoCount On
        Update FileTable Set Partial=0 Where $Identity=@Identity
End

Go

CREATE Procedure DeleteBlob
        @Identity Numeric
As Begin Set NoCount On
        Delete From FileTable Where $Identity=@Identity
End

Go

CREATE Procedure RenameBlob
        @Identity Numeric,
        @FileName VarChar(250)
As Begin Set NoCount On
        Update FileTable Set [FileName]=@FileName Where $Identity=@Identity
End

Go

CREATE Procedure FinalizeBlob
        @Identity Numeric,
        @Hash VarChar(250)
As Begin Set NoCount On
        Update FileTable Set FileHash=@Hash Where $Identity=@Identity
End</PRE><H4 CLASS="western">
<A NAME="6.1.4.2.Example Setup Query for SQL Server 2000|outline"></A>
 6.1.4.2 Example Setup Query for SQL Server 2000</H4>
<P>The main difference between this version and the version for SQL
Server 2005 is the lack of a $IDENTITY object and the cap of 8000
bytes in a varbinary 
</P>
<PRE>CREATE TABLE [FileTable] (<BR> [Id] [int] IDENTITY (1, 1) PRIMARY KEY NOT NULL ,<BR> [FileName] [nvarchar] (50) NOT NULL ,<BR> [DataField] [image] NOT NULL ,<BR> [Partial] [tinyint] NOT NULL ,<BR> [MimeType] [nvarchar] (50) NOT NULL ,<BR> [Created] [datetime] NOT NULL CONSTRAINT [DF_FileTable_Created] DEFAULT (getdate()),<BR> [FileHash] [nvarchar] (50) NULL ,<BR>)<BR><BR>GO<BR><BR>CREATE Procedure CleanUpBlob<BR> @Identity Numeric<BR>As Begin Set NoCount On<BR> Update FileTable Set Partial=0 Where Id=@Identity<BR>End<BR><BR>GO<BR><BR>CREATE Procedure CreateBlob<BR> @Identity Numeric Output,<BR> @Pointer Binary(16) Output,<BR> @FileName VarChar(250) = null,<BR> @MIMEType VarChar(250) = null<BR>As Begin Set NoCount ON;<BR> Insert Into FileTable (Datafield,FileName,MimeType,Partial) Values ('',@FileName,@MimeType,1)<BR> Select @Identity = SCOPE_IDENTITY()<BR> Select @Pointer = TEXTPTR(DataField) From FileTable Where id = @Identity<BR>End<BR><BR>GO<BR><BR>CREATE Procedure DeleteBlob<BR> @Identity Numeric<BR>As Begin Set NoCount On<BR> Delete From FileTable Where id=@Identity<BR>End<BR><BR>GO<BR><BR>CREATE Procedure FinalizeBlob<BR> @Identity Numeric,<BR> @Hash VarChar(250)<BR>As Begin Set NoCount On<BR> Update FileTable Set FileHash=@Hash Where id=@Identity<BR>End<BR><BR>GO<BR><BR>CREATE Procedure OpenBlob<BR> @Identity Numeric,<BR> @Pointer VarBinary(8000) Output,<BR> @Size Int Output,<BR> @FileName VarChar(250) Output,<BR> @MIMEType VarChar(250) Output<BR>As Begin Set NoCount On<BR> Select  @Pointer = TEXTPTR(DataField), <BR> @Size = DATALENGTH(DataField),<BR> @FileName = [FileName],<BR> @MIMEType = MIMEType<BR> From FileTable Where id = @Identity<BR>End<BR><BR>GO<BR><BR>CREATE Procedure ReadBlob<BR> @Identity Numeric, --ignored in this implementation, here for reference<BR> @Pointer Binary(16),<BR> @Offset Int,<BR> @Size Int<BR>As Begin Set NoCount On<BR> ReadText FileTable.DataField @Pointer @Offset @Size<BR>End<BR><BR>GO<BR><BR>CREATE Procedure RenameBlob<BR> @Identity Numeric,<BR> @FileName VarChar(250)<BR>As Begin Set NoCount On<BR> Update FileTable Set [FileName]=@FileName Where id=@Identity<BR>End<BR><BR>GO<BR><BR>CREATE Procedure WriteBlob<BR> @Identity Numeric, --ignored in this implementation, here for reference<BR> @Pointer Binary(16),<BR> @Bytes VarBinary(8000),<BR> @Offset Int,<BR> @Delete Int<BR>As Begin Set NoCount On<BR> UpdateText FileTable.DataField @Pointer @Offset @Delete With Log @Bytes<BR>End</PRE><H2 CLASS="western">
<A NAME="6.2.The GreyBoxProgressBar Extension|outline"></A> 6.2 The
GreyBoxProgressBar Extension</H2>
<P>GreyBoxProgressBar is a NeatUpload extension that uses <A HREF="http://www.orangoo.com/labs/GreyBox/">Orangoo's
open-source GreyBox</A> to display progress in a “pop-up window
that doesn't suck”.  To use the <CODE CLASS="western">GreyBoxProgressBar</CODE>
control:</P>
<OL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Install
	GreyBoxProgressBar:</P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"><U>If you will be
	using the Visual Studio Web Form Designer</U>, add the
	<CODE CLASS="western">GreyBoxProgressBar</CODE> control to your
	toolbox. &nbsp;To do that, right-click on the Toolbox, click
	Add/Remove Items, Browse to&nbsp;
	<CODE CLASS="western">NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/bin/Brettle.Web.NeatUpload.GreyBoxProgressBar.dll</CODE>,
	click Open, and then click OK. &nbsp;A reference to
	<CODE CLASS="western">Brettle.Web.NeatUpload.GreyBoxProgressBar.dll</CODE>
	will automatically be added to your project the first time you use
	the designer to a GreyBoxProgressBar to a form.<BR><U>If you won't
	be using the Visual Studio Web Form Designer</U>, add a reference to
	your web application that refers to the
	<CODE CLASS="western">Brettle.Web.NeatUpload.GreyBoxProgressBar.dll</CODE>
	in the <CODE CLASS="western">NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/bin/</CODE>
	directory.</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Download and
	install <A HREF="http://www.orangoo.com/labs/GreyBox/">GreyBox</A>
	into a “/greybox” folder of your application.  If you wish to
	put GreyBox someplace else, use the GreyBoxRoot attribute of the
	GreyBoxProgressBar control to specify the URL of the GreyBox
	directory.  You may use an absolute or relative URL that refers to a
	page in the same web application.  If the URL starts with &quot;~&quot;,
	the &quot;~&quot; will be replaced with the web application root. 
	By default, &quot;~/greybox&quot; will be used.</P>
	<LI><P>Add the GreyBoxProgressBar to your forms:<BR><U>If you are
	using Visual Studio Web Form Designer</U>, simply drag the
	<CODE CLASS="western">GreyBoxProgressBar</CODE> control from your
	Toolbox and drop it on the form.<BR><U>If you are not using Visual
	Studio Web Form Designer</U>, add the following line at the top of
	your form:</P>
	<PRE STYLE="margin-bottom: 0.2in">&lt;%@ Register TagPrefix=&quot;GreyBoxUpload&quot; Namespace=&quot;Brettle.Web.NeatUpload&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assembly=&quot;Brettle.Web.NeatUpload.GreyBoxProgressBar &quot;%&gt;</PRE><P>
	and add a <CODE CLASS="western">GreyBoxProgressBar</CODE> control to
	your aspx page wherever you want the user to choose a file, using
	something like this: 
	</P>
	<PRE STYLE="margin-bottom: 0.2in">&lt;GreyBoxUpload:GreyBoxProgressBar id=&quot;progressBar<VAR>Id</VAR>&quot; runat=&quot;server&quot; /&gt;</PRE>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Optionally, set
	any properties that you would normally set on an<CODE CLASS="western">
	ProgressBar</CODE> control, except the for the Inline property.  If
	you set the Width or Height properties, they must be set to values
	in units of pixels.</P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"></P>
</OL>
<P>For an example of using the GreyBoxProgressBar extension, see
<CODE CLASS="western">Demo.aspx </CODE>and<CODE CLASS="western">
Demo.aspx.cs </CODE>in the<CODE CLASS="western">
NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/Extensions/Brettle.Web.NeatUpload.GreyBoxProgressBar/
</CODE>directory<CODE CLASS="western">.</CODE></P>
<H2 CLASS="western"><A NAME="mozTocId831551"></A><A NAME="6.3.The HashedInputFile Extension|outline"></A>
 6.3 The HashedInputFile Extension</H2>
<P>HashedInputFile is a NeatUpload extension that computes the
cryptographic hash of each uploaded file while the upload is in
progress.&nbsp; &nbsp;It consists of the <CODE CLASS="western">HashedInputFile</CODE>
web control&nbsp;and a custom <CODE CLASS="western">UploadStorageProvider</CODE>
called <CODE CLASS="western">HashingFilesystemUploadStorageProvider</CODE>.
&nbsp;The <CODE CLASS="western">HashedInputFile</CODE> control is a
subclass of <CODE CLASS="western">InputFile</CODE> that adds a <CODE CLASS="western">Hash</CODE>
property which returns the cryptographic hash of the uploaded file
computed by the <CODE CLASS="western">HashingFilesystemUploadStorageProvider</CODE>.
&nbsp;To use the HashedInputFile extension:</P>
<OL START=5>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Install
	HashedInputFile:</P>
	<P STYLE="margin-top: 0in; margin-bottom: 0in"><U>If you will be
	using the Visual Studio Web Form Designer</U>, add the
	<CODE CLASS="western">HashedInputFile</CODE> control to your
	toolbox. &nbsp;To do that, right-click on the Toolbox, click
	Add/Remove Items, Browse to&nbsp;
	<CODE CLASS="western">NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/bin/Brettle.Web.NeatUpload.HashedInputFile.dll</CODE>,
	click Open, and then click OK. &nbsp;A reference to
	<CODE CLASS="western">Brettle.Web.NeatUpload.HashedInputFile.dll</CODE>
	will automatically be added to your project the first time you use
	the designer to a HashedInputFile to a form.<BR><U>If you won't be
	using the Visual Studio Web Form Designer</U>, add a reference to
	your web application that refers to the
	<CODE CLASS="western">Brettle.Web.NeatUpload.HashedInputFile.dll</CODE>
	in the <CODE CLASS="western">NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/bin/</CODE>
	directory.</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Configure your
	web application to use the <CODE CLASS="western">HashingFilesystemUploadStorageProvider</CODE>.
	&nbsp;The simplest way to do that is to add the following to your
	<CODE CLASS="western">Web.config</CODE> (see&nbsp;<A HREF="#mozTocId221000">Configuration</A>
	for more options):</P>
	<PRE>&lt;configuration&gt;<BR>&nbsp;&nbsp;&lt;configSections&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;section name=&quot;neatUpload&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;Brettle.Web.NeatUpload.ConfigSectionHandler,Brettle.Web.NeatUpload&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowLocation=&quot;true&quot; /&gt;<BR>&nbsp;&nbsp;&lt;/configSections&gt;<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&lt;neatUpload ... defaultStorageProvider=&quot;HashingFilesystemUploadStorageProvider&quot;&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name=&quot;HashingFilesystemUploadStorageProvider&quot; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;Brettle.Web.NeatUpload.HashingFilesystemUploadStorageProvider,Brettle.Web.NeatUpload.HashedInputFile&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;algorithm=&quot;MD5&quot;/&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/providers&gt;<BR>&nbsp;&nbsp;&lt;/neatUpload&gt;<BR>&nbsp;&nbsp;...<BR>&lt;/configuration&gt;</PRE><P STYLE="margin-top: 0in; margin-bottom: 0in">
	Note: the value of the&nbsp;<CODE CLASS="western">algorithm</CODE>
	attribute above is passed to <A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemsecuritycryptographyhashalgorithmclasscreatetopic2.asp">HashAlgorithm.Create()</A>.
	&nbsp;The default value is &quot;MD5&quot;, so the attribute could
	have been omitted above. 
	</P>
	<LI><P>Add the HashedInputFile to your forms:<BR><U>If you are using
	Visual Studio Web Form Designer</U>, simply drag the <CODE CLASS="western">HashedInputFile</CODE>
	control from your Toolbox and drop it on the form.<BR><U>If you are
	not using Visual Studio Web Form Designer</U>, add the following
	line at the top of your form:</P>
	<PRE STYLE="margin-bottom: 0.2in">&lt;%@ Register TagPrefix=&quot;HashedUpload&quot; Namespace=&quot;Brettle.Web.NeatUpload&quot;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assembly=&quot;Brettle.Web.NeatUpload.HashedInputFile&quot;%&gt;</PRE><P>
	and add an&nbsp;<CODE CLASS="western">HashedInputFile</CODE> control
	to your aspx page wherever you want the user to choose a file, using
	something like this: 
	</P>
	<PRE STYLE="margin-bottom: 0.2in">&lt;HashedUpload:HashedInputFile id=&quot;<VAR>inputFileId</VAR>&quot; runat=&quot;server&quot; /&gt;</PRE>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Set any
	properties that you would normally set on an <CODE CLASS="western">InputFile
	or HtmlInputFile</CODE> control. 
	</P>
	<LI><P>In your code-behind class,&nbsp;use the
	<CODE CLASS="western"><FONT FACE="Nimbus Mono L, monospace"><I>inputFileId</I></FONT></CODE><CODE CLASS="western"><FONT FACE="Nimbus Mono L, monospace">.Hash</FONT></CODE>property
	to get a byte array containing the cryptographic hash. &nbsp;You can
	also use <FONT FACE="Nimbus Mono L, monospace"><I>inputFileId</I></FONT><FONT FACE="Nimbus Mono L, monospace">.HashSize</FONT>
	to get the number of bits in the hash (in case it isn't a multiple
	of 8).</P>
</OL>
<P>For an example of using the HashedInputFile extension, see
<CODE CLASS="western">HashedDemo.aspx</CODE> and <CODE CLASS="western">HashedDemo.aspx.cs</CODE>
in the
<CODE CLASS="western">NeatUpload&nbsp;</CODE><EM>version</EM><CODE CLASS="western">/dotnet/app/Extensions/Brettle.Web.NeatUpload.HashedInputFile/
</CODE> directory. &nbsp;For a more complex configuration example,
see <CODE CLASS="western">Web.config</CODE> in that directory. &nbsp;It
uses <A HREF="#mozTocId134915">location filtering</A> and is designed
to work in conjuction with the <CODE CLASS="western">Web.config</CODE>
in application root.</P>
<H1><A NAME="mozTocId580088"></A><A NAME="7.Known Issues|outline"></A>
 7 Known Issues</H1>
<H2 CLASS="western"><A NAME="AspNetTrace"></A><A NAME="7.1.ASP.NET application-wide tracing disables NeatUpload|outline"></A>
 7.1 ASP.NET application-wide tracing disables NeatUpload</H2>
<P>When ASP.NET tracing is enabled in the application Web.config,
ASP.NET reads the entire upload before NeatUpload can access it. As a
result, NeatUpload can't stream the upload to storage and can't
provide a meaningful progress bar. Since NeatUpload can't do anything
useful under such circumstances, it automatically disables itself.
Specifically, it acts as though you set the <CODE CLASS="western">useHttpModule</CODE>
attribute of the <CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element to &quot;false&quot;. That prevents display of the progress
bar and prevents streaming to storage, but your code should otherwise
continue to function normally. 
</P>
<P>Note that this issue only arises when you enable <I>application-wide</I>
ASP.NET tracing (i.e. via the Web.config). It does not arise if you
only enable ASP.NET tracing at the page level using the <CODE CLASS="western">Trace</CODE>
attribute of the <CODE CLASS="western">&lt;%@Page%&gt;</CODE>
directive. Unfortunately, if you enable application-wide ASP.NET
tracing but disable tracing for some or all pages using the <CODE CLASS="western">Trace</CODE>
attribute of the <CODE CLASS="western">&lt;%@Page%&gt;</CODE>
directive, the problem still occurs. This is because the <CODE CLASS="western">Trace</CODE>
attribute of the <CODE CLASS="western">&lt;%@Page%&gt;</CODE>
directive has no effect on whether ASP.NET reads in the entire
request before NeatUpload can access it. 
</P>
<H2 CLASS="western"><A NAME="7.2.Permissions on uploaded files depend on temporary directory|outline"></A>
 7.2 <CODE CLASS="western">Permissions on uploaded files depend on
temporary directory</CODE></H2>
<P>Uploaded files are created in a temporary directory and inherit
the permissions of that directory. Calling <CODE CLASS="western">InputFile.MoveTo()</CODE>
does not change the permissions. In some environments, files in the
default temporary directory are not readable by web applications, and
as a result uploaded files are not readable by the web application.
To avoid this issue, simply <A HREF="../../branches/NeatUpload-1.2/docs/Manual.html#mozTocId905959">change
the temporary directory used by NeatUpload</A> to a directory that
has the permissions you desire. 
</P>
<H2 CLASS="western"><A NAME="7.3.Module conflicts|outline"></A><A NAME="7.3.Module conflicts|outline"></A><A NAME="7.3.Module conflicts|outline"></A>
 7.3 <CODE CLASS="western">Module conflicts</CODE></H2>
<P>When certain 3rd-party <CODE CLASS="western">HttpModule</CODE>s
are used along with NeatUpload, a conflict can occur.  In some cases,
the 3rd-party module prevents NeatUpload's module from working and in
other cases, NeatUpload's module prevents the 3rd-party module from
working.  Typically, it is best to start with NeatUpload's
<CODE CLASS="western">UploadHttpModule</CODE><EM>first</EM> in the
<CODE CLASS="western">&lt;httpModules&gt;</CODE> and <CODE CLASS="western">&lt;modules&gt;</CODE>
sections,  and then move other module's before it only if they fail
to function properly.  
</P>
<P>When a 3rd-party module is preventing NeatUpload's module from
working,  a &quot;Data length (xxx) is shorter than Content-Length
(yyy)” error can occur, and the progress display will fail to
update.  This problem has been reported with both <A HREF="http://www.snapsis.com/PageBlaster.aspx">PageBlaster</A>
and <A HREF="http://www.ifinity.com.au/Products/Url_Master_DNN_SEO_Urls/">UrlMaster</A>.
It is often encountered on sites that installed NeatUpload as part of
<A HREF="http://www.bizmodules.net/Products/UltraVideoGallery2/Overview/tabid/124/Default.aspx">Ultra
Video Gallery (UVG)</A>.  This issue is caused by the fact that
NeatUpload (and any other module that monitors upload progress) needs
to intercept the request before ASP.NET reads the request body.
ASP.NET needs to read the request body in order to compute certain
properties of the <CODE CLASS="western">Request</CODE> object (e.g.
<CODE CLASS="western">Request.Params</CODE>). So if another module
accesses one of those properties before NeatUpload intercepts the
request, ASP.NET will read the request body and when NeatUpload tries
to read the request body, there won't be anything there.</P>
<P>When NeatUpload's module is preventing a 3rd-party module from
working, it is typically because the 3rd-party module only works
properly with certain <CODE CLASS="western">HttpWorkerRequest</CODE>
subclasses and NeatUpload's module changes the <CODE CLASS="western">HttpWorkerRequest</CODE>
subclass.  Such 3rd-party modules will often also fail when used in
hosting environments other than IIS, because those environments also
create a different <CODE CLASS="western">HttpWorkerRequest</CODE>
subclass.  The UrlRewriter module used by DotNetNuke (DNN) is an
example of a module that won't work when listed after NeatUpload's
module.  However, it can be safely listed before NeatUpload's module
for both to properly function.</P>
<P>If you encounter modules that need to be listed before
NeatUpload's module, please email me (dean at brettle dot com) so
that I can update this documentation.</P>
<H2 CLASS="western"><A NAME="mozTocId766780"></A><A NAME="7.4.HttpResponse.AppendToLog() does nothing when UploadHttpModule is used|outline"></A>
 7.4 <CODE CLASS="western">HttpResponse.AppendToLog()</CODE> does
nothing when <CODE CLASS="western">UploadHttpModule</CODE> is used</H2>
<P>Due to the design of NeatUpload this bug will not be fixed,
however NeatUpload does provide a workaround. &nbsp;Simply replace
<CODE CLASS="western">Response.AppendToLog()</CODE> with
<CODE CLASS="western">Brettle.Web.NeatUpload.UploadHttpModule.AppendToLog()</CODE>.
&nbsp;That will work whether the <CODE CLASS="western">UploadHttpModule</CODE>
is used or not.</P>
<H2 CLASS="western"><A NAME="7.5.Setting HttpResponse.HeaderEncoding does nothing when UploadHttpModule is used|outline"></A>
 7.5 Setting <CODE CLASS="western">HttpResponse.HeaderEncoding</CODE>
does nothing when <CODE CLASS="western">UploadHttpModule</CODE> is
used</H2>
<P>Due to the design of NeatUpload this bug will not be fixed,
however if the pages that need to set <CODE CLASS="western">Response.HeaderEncoding</CODE>
are not pages to which the user will be uploading files, you can use
<A HREF="../../branches/NeatUpload-1.2/docs/Manual.html#mozTocId134915">location
filtering</A> to disable the <CODE CLASS="western">UploadHttpModule</CODE>
for those pages. Also, if you are setting <CODE CLASS="western">Response.HeaderEncoding</CODE>
so that you can specify a non-ASCII filename for a downloaded file
via the filename parameter of the Content-Disposition header, you
should consider other approaches. Even without the <CODE CLASS="western">UploadHttpModule</CODE>,
setting <CODE CLASS="western">Response.HeaderEncoding</CODE> will
only work if you set it to the encoding that the browser happens to
be using. For example, setting it to &quot;big5&quot; will not cause
the file to have a name with Chinese characters if the user is using
the UTF-8 encoding. Also, if you set <CODE CLASS="western">Response.HeaderEncoding</CODE>
to a value that is different from the encoding used by the browser,
you could create a security hole. 
</P>
<P>There are two better approaches. For both approaches, the filename
needs to be encoded using the <CODE CLASS="western">HttpUtility.UrlPathEncode()</CODE>
method. That encodes non-ASCII characters using the %XX notation you
often see in URLs. Once you have the UrlPathEncoded filename, you
have 2 options. 
</P>
<UL>
	<LI><P>Option 1: Set the Content-Disposition header to simply
	&quot;attachment&quot;, and place the encoded filename in the &quot;path
	info&quot; part of the download URL. So, instead of using a download
	URL of &quot;http://tempuri.org/DownloadFile.ashx&quot;, you would
	use a download URL of
	&quot;http://tempuri.org/DownloadFile.ashx/<I>YourUrlPathEncodedFilename</I>&quot;.
	If you are using IIS or some other webserver that supports path
	info, this approach will work under at least the latest versions of
	IE, Firefox, Opera, and Safari. However, this approach does not work
	if you are using Visual Studio's Development Web Server because it
	doesn't support path info. If your server does support path info,
	you can implement this approach easily by changing your download
	page to redirect the browser to a page which has the necessary path
	info, like this: 
	</P>
	<PRE>&lt;%@ WebHandler Language=&quot;C#&quot; Class=&quot;Handler&quot; %&gt;
using System;
using System.Web;

public class Handler : IHttpHandler {
    public void ProcessRequest (HttpContext context) 
    {
        string filename = &quot;中文檔名.doc&quot; //  or some other file name
        string encodedFilename = HttpUtility.UrlPathEncode(filename);
        if (context.Request.PathInfo == null || context.Request.PathInfo.Length == 0)
        {
            string query = context.Request.Url.Query;
            context.Response.Redirect(context.Request.Path + &quot;/&quot; + encodedFilename + query);
        }
        else
        {
            context.Response.Clear();
            context.Response.ContentType = &quot;application/octet-stream&quot;;
            context.Response.AddHeader(&quot;Content-Disposition&quot;, &quot;attachment&quot;);
            FileInfo fi = new FileInfo(context.Server.MapPath(filename));
            context.Response.WriteFile(fi.FullName);
            context.Response.Flush();
            context.Response.End();
        }
    }
    
    public bool IsReusable { get { return false; } }
}</PRE>
	<LI><P>Option 2: Set the Content-Disposition header's filename
	parameter to the UrlPathEncoded filename, but do so in a way that is
	supported by the browser. According to <A HREF="http://www.faqs.org/rfcs/rfc2231.html">RFC
	2231</A>, the correct way to do this is to set the
	Content-Disposition header to
	&quot;<CODE CLASS="western">attachment;&nbsp;filename*=utf-8''</CODE><CODE CLASS="western"><I>YourUrlPathEncodedFilename</I></CODE>&quot;.
	That works for the latest versions of Firefox and Opera, but not IE
	and Safari. Both IE and Safari will ignore the filename parameter
	and use the name of your download page (e.g. DownloadFile.ashx).
	There is no way to set the filename parameter to work with Safari,
	but for IE you can set Content-Disposition header to
	&quot;<CODE CLASS="western">attachment;&nbsp;filename=</CODE><CODE CLASS="western"><I>YourUrlPathEncodedFilename</I></CODE>&quot;.
	That doesn't work for Firefox or Safari though. So, you need to
	treat it as a special IE-only case. Here is an example: 
	</P>
	<PRE>&lt;%@ WebHandler Language=&quot;C#&quot; Class=&quot;Handler&quot; %&gt;
using System;
using System.Web;

public class Handler : IHttpHandler {
    public void ProcessRequest (HttpContext context) 
    {
        string filename = &quot;中文檔名.doc&quot; //  or some other file name
        string encodedFilename = HttpUtility.UrlPathEncode(filename);
        context.Response.Clear();
            context.Response.ContentType = &quot;application/octet-stream&quot;;
        string contentDisposition = &quot;attachment&quot;;
        if (context.Request.Browser.IsBrowser(&quot;IE&quot;))
            contentDisposition += &quot;; filename=&quot; + encodedFilename;
        else
            contentDisposition += &quot;; filename*=utf-8''&quot; + encodedFilename;
        context.Response.AddHeader(&quot;Content-Disposition&quot;, contentDisposition);
        FileInfo fi = new FileInfo(context.Server.MapPath(filename));
        context.Response.WriteFile(fi.FullName);
        context.Response.Flush();
        context.Response.End();
    }
    
    public bool IsReusable { get { return false; } }
}</PRE>
</UL>
<H2 CLASS="western"><A NAME="mozTocId181845"></A><A NAME="7.6.Non-absolute path in IE7 causes the progress display to start even though no upload occurs|outline"></A>
 7.6 Non-absolute path in IE7 causes the progress display to start
even though no upload occurs</H2>
<P>If instead of selecting a file to upload via the file selection
dialog, the user types in a non-absolute path (e.g. just &quot;x&quot;),
IE6 and IE7 will not submit the form and no upload will occur. &nbsp;Under
IE6, it is possible to detect this situation and prevent the progress
display from starting. &nbsp;The situation is detected by using
Javascript to examine the value of the <CODE CLASS="western">&lt;input
type=&quot;file&quot;&gt;</CODE> form element. &nbsp;If the value
doesn't look like an absolute path, the progress display is not
started. &nbsp;In IE7, the value of the form element is always just
the filename, not the full path, probably for security reasons. &nbsp;As
a result, NeatUpload can't prevent the progress display from starting
because it's not possible to determine whether an absolute path was
entered -- the value is &quot;x&quot; whether the user entered &quot;x&quot;
or &quot;c:<FONT FACE="Nimbus Sans L, sans-serif">\</FONT>x&quot;.</P>
<P>Since users almost always use the file selection dialog, this
issue almost never arises.</P>
<H2 CLASS="western"><A NAME="7.7. Clicking submit buttons or image buttons might start progress display or clear selected files|outline"></A><A NAME="7.7. Clicking submit buttons or image buttons might start the progress display or clear selected files|outline"></A>
 7.7  Clicking submit buttons or image buttons might start the
progress display or clear selected files</H2>
<P>NeatUpload attempts to start the progress display whenever a
postback containing a file occurs.  Unfortunately, NeatUpload can't
know that clicking on some buttons won't actually cause the files to
be uploaded.  Consider the common case where an <CODE CLASS="western">&lt;asp:Button&gt;</CODE>
is used to initiate an <EM>partial</EM> postback in an <CODE CLASS="western">UpdatePanel</CODE>.
 Since only a partial postback is performed, files are not uploaded
and the progress display should not be started.  You could (and
should) use the <CODE CLASS="western">ProgressBar</CODE>'s <CODE CLASS="western">Triggers</CODE>
attribute to list only the elements that should start the upload, but
leaving the aforementioned button off that list will have an
additional undesirable effect.  Clicking the button will now cause
NeatUpload to clear any selected files.  This is because NeatUpload
assumes that clicking the button will initiate a <EM>full</EM>
postback which is not intended to start an upload (e.g. a traditional
“cancel” button), and failure to clear the selected files could
make the full postback take a very long time.  Unfortunately, since
only a partial postback is being performed, clearing the files is
both unnecessary and undesirable.</P>
<P>The underlying issue is that NeatUpload assumes that clicking any
<CODE CLASS="western">type=”submit”</CODE> or <CODE CLASS="western">type=”image”</CODE>
buttons will initiate a full postback.  For the particular case of an
<CODE CLASS="western">&lt;asp:Button&gt;</CODE>, there is a simple
workaround.  Adding <CODE CLASS="western">UseSubmitBehavior=”false”</CODE>
to the attributes of the button will cause it to no longer be
rendered as one of those types.  For other cases, the workaround is
more complex.  You need to override the <CODE CLASS="western">GetSubmittingElem()</CODE>
JavaScript method of the <CODE CLASS="western">NeatUploadForm</CODE>
object associated with the <CODE CLASS="western">ProgressBar</CODE>
control.  Your method should return <CODE CLASS="western">null</CODE>
if clicking the element identified by the <CODE CLASS="western">NeatUpload_LastEventSource</CODE>
global will not initiate a full postback.  Otherwise it should
delegate to the original <CODE CLASS="western">GetSubmittingElem()</CODE>
implementation.  Here is some example code that would be called
during <CODE CLASS="western">window.onload</CODE> to ensure that the
necessary JavaScript objects exist: 
</P>
<UL>
	<PRE>    	NeatUploadPB.prototype.Bars['ProgressBar1'].UploadForm.GetSubmittingElem = function() {
    		if (NeatUpload_LastEventSource.getAttribute('id') == &quot;<VAR>PartialPostBackButtonID</VAR>&quot;)
    			return null;
    		return NeatUploadForm.prototype.GetSubmittingElem();
    	}</PRE>
</UL>
<H2 CLASS="western"><A NAME="MacIELinkButtons"></A><A NAME="7.8. LinkButtons do not start the progress display in Internet Explorer for the Mac|outline"></A>
 7.8  <CODE CLASS="western">LinkButtons</CODE> do not start the
progress display in Internet Explorer for the Mac</H2>
<P>NeatUpload overrides the <CODE CLASS="western">form.submit()</CODE>
JavaScript method to start the progress display when the form is
submitted programmatically (e.g. with a <CODE CLASS="western">LinkButton</CODE>).
Mac IE does not support overriding <CODE CLASS="western">form.submit()</CODE>
so NeatUpload can't start the progress display if a <CODE CLASS="western">LinkButton</CODE>
is used to submit the form. The upload still occurs though. Since Mac
IE is no longer supported by Microsoft and currently has less than 1%
of the browser market, there are currently no plans to develop a
workaround for this. 
</P>
<H2 CLASS="western"><A NAME="LargeResponseNotBuffered"></A><A NAME="7.9.Sometimes responses larger than 1MB are not buffered|outline"></A>
 7.9 Sometimes responses larger than 1MB are not buffered</H2>
<P>Without NeatUpload, ASP.NET (by default) buffers the entire
response in memory before sending it. However, when NeatUpload's
<CODE CLASS="western">UploadHttpModule</CODE> is installed, it will
sometimes flush the buffer if the response is larger than 1 MByte.
Responses smaller then 1 MBytes are not affected, but NeatUpload will
sometimes flush larger responses even if the page does not contain
any NeatUpload controls and does not receive uploads. To avoid this
behavior you need to use <A HREF="#mozTocId134915">location filtering</A>
to set <CODE CLASS="western">&lt;neatUpload ...
useHttpModule=&quot;true&quot;.../&gt;</CODE> for the page. Very few
applications need to buffer such large responses, but if your
application needs such buffering, you can use location filtering to
workaround the issue. 
</P>
<P>Technical note: The current behavior is a side-effect of a
workaround for a problem where <CODE CLASS="western">HttpResponse.TransmitFile()</CODE>
was causing the entire file to be buffered in memory when the
<CODE CLASS="western">UploadHttpModule</CODE> was being used.
Apparently, Microsoft coded <CODE CLASS="western">TransmitFile()</CODE>
so that buffering is only avoided when the current <CODE CLASS="western">HttpWorkerRequest</CODE>
is a particular subclass of <CODE CLASS="western">HttpWorkerRequest</CODE>.
Since NeatUpload wraps the original <CODE CLASS="western">HttpWorkerRequest</CODE>
in it's own subclass, ASP.NET does not see the original
<CODE CLASS="western">HttpWorkerRequest</CODE> and does not bypass
the buffering. Instead it calls
<CODE CLASS="western">HttpWorkerRequest.SendResponseFromFile()</CODE>.
NeatUpload's implementation of <CODE CLASS="western">SendResponseFromFile()</CODE>
avoids the problem by flushing the response after every 1 MByte.
Since this workaround affects <CODE CLASS="western">SendResponseFromFile()</CODE>
but not other methods of sending response content, the flushing will
not occur for all types of responses. That means you should not
assume a response will be flushed simply because it is larger than 1
MByte. 
</P>
<H2 CLASS="western"><A NAME="7.10.NeatUpload controls might not work properly within an UpdatePanel|outline"></A>
 7.10 NeatUpload controls might not work properly within an
UpdatePanel</H2>
<P>To maintain compatibility with ASP.NET 1.1, NeatUpload's controls
do not call some methods that might be needed to ensure proper
operation within an <CODE CLASS="western">UpdatePanel</CODE> control.
 To avoid those issues:</P>
<UL>
	<LI><P>Don't add a NeatUpload control to the DOM in response to an
	AJAX callback.  For example, adding a NeatUpload control as a child
	control of the <CODE CLASS="western">UpdatePanel</CODE>, or changing
	the control's <CODE CLASS="western">Visible</CODE> property from
	<CODE CLASS="western">False</CODE> to <CODE CLASS="western">True</CODE>,
	would cause the control to be added to the DOM. To workaround this,
	consider keeping the control in the DOM all the time but using CSS
	to hide it or show it as necessary.</P>
	<LI><P>Don't try to upload files using an AJAX callback.  This does
	not work for ASP.NET's <CODE CLASS="western">FileUpload</CODE> or
	<CODE CLASS="western">HtmlInputFile</CODE> controls either.  To
	workaround this, you must ensure that a full postback occurs.  One
	way to do that is to register the upload button as a <CODE CLASS="western"><A HREF="http://msdn.microsoft.com/en-us/library/system.web.ui.postbacktrigger.aspx">PostBackTrigger</A></CODE>
	for the <CODE CLASS="western">UpdatePanel</CODE>.</P>
</UL>
<P>If you are using an <CODE CLASS="western">UpdatePanel</CODE>, you
should also read how <A HREF="#7.7. Clicking submit buttons or image buttons might start progress display or clear selected files|outline">clicking
submit buttons or image buttons might start the progress display or
clear selected files</A>.  Follow the link for workarounds.</P>
<H2 CLASS="western"><A NAME="7.12.NeatUpload might fail when using Windows Authentication|outline"></A><A NAME="7.12.NeatUpload might fail when using Windows Authentication|outline"></A><A NAME="7.12.NeatUpload might fail when using Windows Authentication|outline"></A><A NAME="7.11.NeatUpload might fail when using Windows Authentication|outline"></A>
 7.11 NeatUpload might fail when using Windows Authentication</H2>
<P>The <CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>
stores upload state in the user's session by making anonymous HTTP
requests to <CODE CLASS="western">NeatUpload/UploadStateStoreHandler.ashx</CODE>.
 If the server requests authentication, NeatUpload will throw an
exception.</P>
<P>When <A HREF="#3.4.Allowing Users with Flash to Select Multiple Files from One File Selection Dialog|outline">Flash
is used to upload file</A>, the Flash player makes anonymous HTTP
requests to <CODE CLASS="western">NeatUpload/MultiRequestUploadHandler.ashx</CODE>.
 If the server requests authentication, Flash will display an
authentication dialog, but due to bugs in Flash will not be able to
use that information to authenticate with the server and the upload
will not occur.</P>
<P>For all of the above problems, the easiest workaround is to enable
Anonymous Authentication <I>and disable Windows Authentication</I>
for the NeatUpload folder.  If you aren't using Flash and you don't
have a web garden or web farm you can also avoid this issue by
configuring NeatUpload to use the <CODE CLASS="western">InProcUploadStateStoreProvider</CODE>,
as described in <A HREF="#4.9.Reducing Server Load|outline">Reducing
Server Load</A>.</P>
<H2 CLASS="western"><A NAME="7.12.NeatUpload might fail when using SSL/HTTPS|outline"></A>
 7.12 NeatUpload might fail when using SSL/HTTPS</H2>
<P>The <CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>
stores upload state in the user's session by making requests to
<CODE CLASS="western">NeatUpload/UploadStateStoreHandler.ashx </CODE>using
the same protocol (HTTP or HTTPS) that the user used to do the
upload.  If HTTPS is used and the server's certificate is not
trusted, NeatUpload will throw an exception complaining that &quot;The
remote certificate is invalid according to the validation process&quot;.</P>
<P>The easiest workaround is to <A HREF="http://weblogs.asp.net/jan/archive/2003/12/04/41154.aspx">configure
ASP.NET to accept your cert</A>, probably in your
Global.Application_Start().  If you don't have a web garden or web
farm you can also avoid this issue by configuring NeatUpload to use
the <CODE CLASS="western">InProcUploadStateStoreProvider</CODE>, as
described in <A HREF="#4.9.Reducing Server Load|outline">Reducing
Server Load</A>.</P>
<H2 CLASS="western"><A NAME="7.14.Application restarts can interrupt uploads or blank ProgressBars|outline"></A><A NAME="7.13.Application restarts can interrupt uploads or blank ProgressBars|outline"></A>
 7.13 Application restarts can interrupt uploads or blank
ProgressBars</H2>
<P>ASP.NET can restart your application for a variety of reasons,
including changes to your Web.config(s), aspx files, the contents of
your bin folder, or App_LocalResources folder(s).  It will also
<A HREF="http://blogs.msdn.com/tmarq/archive/2007/11/02/asp-net-file-change-notifications-exactly-which-files-and-directories-are-monitored.aspx">restart
your application if you delete directories</A> from anywhere within
your application's directory hierarchy, including App_Data.  If you
aren't using NeatUpload, you might not notice these restarts because
requests that are already in process finish normally, and new
requests are handled by a new instance of your application.  To
determine if your application is being restarted, <A HREF="http://blogs.msdn.com/rahulso/archive/2006/04/13/health-monitoring-for-application-s-lifetime-related-events-in-asp-net-2-0.aspx">configure
your application to log application lifetime events</A> to the event
log.  
</P>
<P>Restarts are important because application state and, if your
session state mode is InProc, all session state is lost during a
restart.  That loss of state can cause problems for NeatUpload
because it stores the state of an in-progress upload in either
application state or session state.</P>
<P>You can prevent ASP.NET from doing some application restarts by
<A HREF="http://support.microsoft.com/kb/911272">setting
HKLM\Software\Microsoft\ASP.NET\FCNMode=1</A> but IIS7 will still
restart your application if you change the root Web.config and you
will undoubtedly need to restart your application manually on
occasion.  To completely workaround the issue use a session state
mode other than InProc or Off and use the
<CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>. 
If you do not, you may experience the following problems:</P>
<UL>
	<LI><P>Non-flash uploads will throw an exception if the
	<CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE> is
	being used with a session state mode of InProc.  The
	<CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>
	maintains upload state in the user's session by making HTTP requests
	to <CODE CLASS="western">NeatUpload/UploadStateStoreHandler.ashx</CODE>.
	 If the session state mode is InProc, then an application restart
	will cause the user's session to not exist in the new application
	instance handling the request from the
	<CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>. 
	To workaround this issue, avoid using the
	<CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>
	with a session state mode of InProc.  Instead, use a session state
	mode other than InProc or Off, or use the
	<CODE CLASS="western">InProcUploadStateStoreProvider</CODE>.</P>
	<LI><P><CODE CLASS="western">ProgressBar</CODE>s will go blank and
	Flash uploads will hang if the session state mode is InProc or Off
	or the <CODE CLASS="western">InProcUploadStateStoreProvider</CODE>
	is being used.  <CODE CLASS="western">ProgressBar</CODE>s will go
	blank because they monitor progress by making separate requests to
	the server and after the restart, those requests will be handled by
	the new application instance.  Flash uploads will hang because Flash
	uses a separate request to upload each file and after the restart,
	the requests will be handled by the new application instance which
	can't associate them with an existing upload state.  To workaround
	this issue use a session state mode other than InProc or Off and use
	the default <CODE CLASS="western">AdaptiveUploadStateStoreProvider</CODE>
	or the <CODE CLASS="western">SessionBasedUploadStateStoreProvider</CODE>.</P>
</UL>
<H1><A NAME="mozTocId405545"></A><A NAME="0.1.Troubleshooting|outline"></A><A NAME="8.Troubleshooting|outline"></A>
 8 Troubleshooting</H1>
<P>If you think NeatUpload's <CODE CLASS="western">UploadHttpModule</CODE>
might be causing a problem, the first thing you should do is set the
<CODE CLASS="western">&lt;neatUpload&gt;</CODE>
element's&nbsp;<CODE CLASS="western">useHttpModule</CODE> attribute
to&nbsp;&quot;false&quot; (or remove the <CODE CLASS="western">UploadHttpModule</CODE>
from the <CODE CLASS="western">&lt;httpModules&gt;</CODE> section)
and try to reproduce the problem. &nbsp;All of your existing code
should continue to work - you just won't get progress bars and
streaming of files to disk. &nbsp;If the problem goes away when you
remove the <CODE CLASS="western">UploadHttpModule</CODE>, it is a bug
so please <A HREF="http://www.brettle.com/neatupload_bugs">report it</A>.
&nbsp;You can help me diagnosis the problem by doing the following:</P>
<OL>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Set the
	<CODE CLASS="western">debugDirectory</CODE> attribute of the
	<CODE CLASS="western">&lt;neatUpload&gt;</CODE> element in your
	<CODE CLASS="western">Web.config</CODE> to the name of a directory
	in your webapp where NeatUpload can store copies of the request
	bodies it processes. &nbsp;For example,<CODE CLASS="western">
	&lt;neatUpload ... debugDirectory=&quot;MyDebugDir&quot; ...&gt;
	</CODE>would cause NeatUpload to store copies of the request bodies
	in the &quot;MyDebugDir&quot; directory under you application root. 
	</P>
	<LI><P STYLE="margin-top: 0in; margin-bottom: 0in">Reproduce the
	problem. 
	</P>
	<LI><P>Send me (dean at brettle dot com) a zip file containing the
	files from debug directory with the extensions &quot;.body&quot; and
	&quot;.sizes&quot;. &nbsp;Each &quot;.body&quot; file contains the
	body of a request you sent when reproducing the problem. &nbsp;The
	corresponding &quot;.sizes&quot; file contains the MIME type of the
	request and the size of each chunk that NeatUpload read. &nbsp;I can
	use the <CODE CLASS="western">TestFilter.exe</CODE> program to
	reproduce how the <CODE CLASS="western">UploadHttpModule</CODE>
	processed the request and (hopefully) determine exactly what went
	wrong. 
	</P>
</OL>
</BODY>
</HTML>